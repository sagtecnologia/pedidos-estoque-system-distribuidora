<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Ponto de Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    
    <!-- Serviço Centralizado de Estoque -->
    <script src="../js/services/estoque-central.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Processando...</h3>
            <p id="loading-message" class="text-gray-600">Aguarde enquanto processamos sua solicitação</p>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[9998] flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="confirm-title">Confirmar Ação</h3>
            <p class="text-gray-600 mb-6" id="confirm-message"></p>
            <div class="flex gap-3 justify-end">
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Cancelar
                </button>
                <button id="confirm-ok" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16 pb-8">
        <div class="max-w-7xl mx-auto px-4">
            <!-- Status do Caixa -->
            <div class="mb-6">
                <div id="status-caixa" class="bg-red-100 text-red-800 p-4 rounded-lg flex flex-col gap-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <i class="fas fa-lock text-lg flex-shrink-0"></i>
                        <div class="min-w-0 flex-1">
                            <div class="font-bold">Nenhum caixa aberto</div>
                            <div class="text-sm break-words">Clique em "Abrir Caixa" para começar</div>
                        </div>
                    </div>
                    <button id="btn-abrir-caixa" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium self-start sm:self-auto">
                        <i class="fas fa-unlock mr-1"></i>Abrir Caixa
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Esquerda: Busca e Carrinho -->
                <div class="lg:col-span-2">
                    <!-- Busca de Produtos -->
                    <div class="bg-white rounded-lg shadow p-4 mb-6">
                        <h3 class="font-bold text-lg mb-4">
                            <i class="fas fa-barcode mr-2"></i>Adicionar Produto
                        </h3>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="busca-produto" 
                                placeholder="Código de barras ou SKU (pressione ENTER)"
                                class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                            <button onclick="document.getElementById('busca-produto').focus()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Carrinho de Compras -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold text-lg mb-4">
                            <i class="fas fa-shopping-cart mr-2"></i>Carrinho
                        </h3>
                        <div id="carrinho-items" class="min-h-32 max-h-96 overflow-y-auto mb-4">
                            <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
                        </div>

                        <!-- Totalizadores -->
                        <div class="space-y-2 border-t pt-4">
                            <div class="flex justify-between text-lg">
                                <span>Subtotal:</span>
                                <span id="subtotal-valor" class="font-bold">R$ 0.00</span>
                            </div>
                            <div class="flex justify-between text-green-600">
                                <span>Desconto:</span>
                                <span id="desconto-valor" class="font-bold">-R$ 0.00</span>
                            </div>
                            <div class="flex justify-between text-orange-600">
                                <span>Acréscimo:</span>
                                <span id="acrescimo-valor" class="font-bold">+R$ 0.00</span>
                            </div>
                            <div class="flex justify-between text-2xl font-bold bg-blue-50 p-3 rounded mt-2">
                                <span>Total:</span>
                                <span id="total-valor">R$ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Direita: Botões de Ação -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow p-4 space-y-3">
                        <h3 class="font-bold text-lg mb-4">
                            <i class="fas fa-cog mr-2"></i>Ações
                        </h3>

                        <button onclick="PDVSystem.proximoCliente()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i>Novo Cliente
                        </button>

                        <button id="btn-finalizar-venda" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 text-lg font-bold">
                            <i class="fas fa-check-circle"></i>Finalizar Venda
                        </button>

                        <button onclick="PDVSystem.itensCarrinho = []; PDVSystem.atualizarCarrinho();" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i>Limpar Carrinho
                        </button>

                        <!-- Seção de Emissão Fiscal -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-2">
                                <i class="fas fa-file-invoice mr-2"></i>Emissão Fiscal
                            </h4>

                            <button onclick="PDVSystem.emitirNFCe()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 text-sm">
                                <i class="fas fa-receipt"></i>Emitir NFC-e
                            </button>

                            <button onclick="PDVSystem.consultarFiscal()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 text-sm mt-2">
                                <i class="fas fa-search"></i>Consultar Status
                            </button>
                        </div>

                        <!-- Informações Operador -->
                        <div class="border-t pt-4 mt-4 text-sm bg-gray-50 p-3 rounded">
                            <p><strong>Operador:</strong> <span id="operador-nome">-</span></p>
                            <p><strong>Caixa:</strong> <span id="caixa-numero">-</span></p>
                            <p><strong>Hora:</strong> <span id="hora-atual">-</span></p>
                        </div>

                        <!-- Fechar Caixa -->
                        <button onclick="PDVSystem.fecharCaixa()" class="w-full px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 flex items-center justify-center gap-2 text-sm mt-4">
                            <i class="fas fa-power-off"></i>Fechar Caixa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/rbac.js"></script>
    <script src="../js/services/estoque.js"></script>
    <script src="../js/services/servico-fiscal.js"></script>
    <script src="../js/services/produtos.js"></script>
    <script src="../js/services/clientes.js"></script>
    <script src="../js/services/usuarios.js"></script>
    <script src="../js/services/impressao.js"></script>
    <script src="../js/services/comandas.js"></script>
    <script src="../js/services/pdv.js"></script>
    <script src="../js/services/focus-nfe.js"></script>
    <script src="../js/services/nuvem-fiscal.js?v=20260207-fix-icms"></script>
    <script src="../js/services/fiscal.js"></script>
    <script src="../js/services/shared-utils.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>

    <script>
        // Modal de confirmação profissional
        function showConfirm(message, title = 'Confirmar Ação') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const btnOk = document.getElementById('confirm-ok');
                const btnCancel = document.getElementById('confirm-cancel');
                
                titleEl.textContent = title;
                messageEl.innerHTML = message.replace(/\n/g, '<br>');
                modal.classList.remove('hidden');
                
                const handleOk = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    modal.classList.add('hidden');
                    btnOk.removeEventListener('click', handleOk);
                    btnCancel.removeEventListener('click', handleCancel);
                };
                
                btnOk.addEventListener('click', handleOk);
                btnCancel.addEventListener('click', handleCancel);
            });
        }

        // Atualizar mensagem do loading
        function setLoadingMessage(message) {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
        }
    </script>

    <script>
        (async () => {
            await checkAuth();

            // Proteger PDV para OPERADOR_CAIXA e ADMIN
            if (!(await RBACSystem.protegerPagina(['ADMIN', 'OPERADOR_CAIXA']))) {
                return;
            }

            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();

            // Aguardar que PDVSystem esteja definido
            while (typeof PDVSystem === 'undefined') {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Inicializar PDV
            await PDVSystem.init();

            // Adicionar listener do botão "Abrir Caixa"
            document.getElementById('btn-abrir-caixa')?.addEventListener('click', () => {
                PDVSystem.exibirModalAbrirCaixa();
            });

            // Atualizar informações do operador
            const usuario = await getCurrentUser();
            document.getElementById('operador-nome').textContent = usuario.nome_completo;
            
            // Atualizar caixa número (observar mudanças)
            const atualizarCaixaNumero = () => {
                if (PDVSystem.caixaAtual) {
                    document.getElementById('caixa-numero').textContent = PDVSystem.caixaAtual.numero + ' - ' + PDVSystem.caixaAtual.nome;
                } else {
                    document.getElementById('caixa-numero').textContent = '-';
                }
            };
            atualizarCaixaNumero();
            setInterval(atualizarCaixaNumero, 500);

            // Atualizar hora
            setInterval(() => {
                document.getElementById('hora-atual').textContent = new Date().toLocaleTimeString('pt-BR');
            }, 1000);

            // Registrar auditoria de acesso
            await RBACSystem.registrarAuditoria('pdv_acesso', 'SELECT', null, { pagina: 'PDV' });
        })();
    </script>
</body>
</html>
