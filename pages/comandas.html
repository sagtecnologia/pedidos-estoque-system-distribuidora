<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comandas - Sistema Distribuidora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .comanda-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            min-height: 180px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .comanda-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .comanda-card.aberta {
            border-color: #10b981;
            background: linear-gradient(135deg, #f9fafb 0%, #d1fae5 100%);
        }
        .tab-abas {
            padding: 1rem 0;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-abas:hover {
            color: #3b82f6;
        }
        .tab-abas.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .tab-tipo {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-tipo:hover {
            color: #3b82f6;
        }
        .tab-tipo.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-backdrop.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-receipt mr-4 text-orange-600"></i>Comandas
                        </h1>
                        <p class="text-gray-600 mt-2">Vendas em aberto para consumo no local</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="carregarComandas()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-redo"></i> Atualizar
                        </button>
                        <button onclick="abrirModalNovaComanda()" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> Nova Comanda
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cards de Resumo -->
            <div class="grid grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                    <h6 class="text-gray-600 text-sm font-medium mb-2">Total Abertas</h6>
                    <h2 class="text-3xl font-bold text-blue-600" id="count-total">0</h2>
                </div>
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                    <h6 class="text-gray-600 text-sm font-medium mb-2">Mesas</h6>
                    <h2 class="text-3xl font-bold text-green-600" id="count-mesas">0</h2>
                </div>
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                    <h6 class="text-gray-600 text-sm font-medium mb-2">Balcao</h6>
                    <h2 class="text-3xl font-bold text-yellow-600" id="count-balcao">0</h2>
                </div>
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                    <h6 class="text-gray-600 text-sm font-medium mb-2">Delivery</h6>
                    <h2 class="text-3xl font-bold text-purple-600" id="count-delivery">0</h2>
                </div>
            </div>

            <!-- Tabs Principais: Abertos vs Hist√≥rico -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Abas principais">
                        <button onclick="mudarAbaSecao('abertos')" class="tab-abas active" data-aba="abertos" style="padding: 1rem 0; border-bottom: 3px solid transparent; font-weight: bold;">
                            <i class="fas fa-list mr-2"></i>Comandas Abertas
                        </button>
                        <button onclick="mudarAbaSecao('historico')" class="tab-abas" data-aba="historico" style="padding: 1rem 0; border-bottom: 3px solid transparent; font-weight: bold;">
                            <i class="fas fa-history mr-2"></i>Hist√≥rico
                        </button>
                    </nav>
                </div>
            </div>

            <!-- SECAO 1: COMANDAS ABERTAS -->
            <div id="secao-abertos" class="block">
                <!-- Tabs de Filtro por Tipo -->
                <div class="bg-white rounded-lg shadow-sm mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-4 px-6" aria-label="Tipos de comanda">
                            <button onclick="filtrarPorTipo('todas')" class="tab-tipo active" data-tipo="todas">Todas</button>
                            <button onclick="filtrarPorTipo('mesa')" class="tab-tipo" data-tipo="mesa">Mesas</button>
                            <button onclick="filtrarPorTipo('balcao')" class="tab-tipo" data-tipo="balcao">Balcao</button>
                            <button onclick="filtrarPorTipo('delivery')" class="tab-tipo" data-tipo="delivery">Delivery</button>
                        </nav>
                    </div>
                </div>

                <!-- Grid de Comandas Abertas -->
                <div id="comandas-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Comandas serao inseridas aqui -->
                </div>
            </div>

            <!-- SECAO 2: HIST√ìRICO -->
            <div id="secao-historico" class="hidden">
                <!-- Filtros do Hist√≥rico -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                            <input 
                                type="datetime-local" 
                                id="filtro-data-historico" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                onchange="carregarHistoricoComandas()"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente (opcional)</label>
                            <input 
                                type="text" 
                                id="filtro-cliente-historico" 
                                placeholder="Buscar por nome..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                onkeyup="filtrarHistoricoCliente()"
                            >
                        </div>
                        <div>
                            <button onclick="carregarHistoricoComandas()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition font-medium">
                                <i class="fas fa-search mr-2"></i>Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Hist√≥rico -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-orange-500">
                        <h6 class="text-gray-600 text-sm font-medium mb-2">Fechadas</h6>
                        <h2 class="text-2xl font-bold text-orange-600" id="count-historico-fechadas">0</h2>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
                        <h6 class="text-gray-600 text-sm font-medium mb-2">Canceladas</h6>
                        <h2 class="text-2xl font-bold text-red-600" id="count-historico-canceladas">0</h2>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-gray-500">
                        <h6 class="text-gray-600 text-sm font-medium mb-2">Total</h6>
                        <h2 class="text-2xl font-bold text-gray-600" id="count-historico-total">0</h2>
                    </div>
                </div>

                <!-- Grid de Hist√≥rico -->
                <div id="historico-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Hist√≥rico sera inserido aqui -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Nova Comanda -->
    <div id="modalNovaComanda" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Nova Comanda</h3>
                <button onclick="fecharModalNovaComanda()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-nova-comanda" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                    <select id="comanda-tipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required onchange="atualizarCamposMesa()">
                        <option value="mesa">Mesa</option>
                        <option value="balcao">Balcao</option>
                        <option value="delivery">Delivery</option>
                    </select>
                </div>
                <div id="campo-numero-mesa">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Numero da Mesa</label>
                    <input type="text" id="comanda-numero-mesa" placeholder="Ex: 5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <small class="text-gray-500 text-xs">Numero da comanda sera gerado automaticamente</small>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cliente (opcional)</label>
                    <select id="comanda-cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Sem cliente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Cliente (se nao cadastrado)</label>
                    <input type="text" id="comanda-cliente-nome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </form>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="fecharModalNovaComanda()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button onclick="salvarNovaComanda()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    Abrir Comanda
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Detalhes da Comanda -->
    <div id="modalDetalhesComanda" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 p-6 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="titulo-comanda">Comanda</h3>
                <button onclick="fecharModalDetalhes()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div><strong>Cliente:</strong> <span id="comanda-cliente-nome-display">-</span></div>
                <div class="text-right"><strong>Aberta em:</strong> <span id="comanda-data-abertura">-</span></div>
            </div>

            <!-- Adicionar Item -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h6 class="font-medium mb-3"><i class="fas fa-barcode mr-2"></i>Adicionar Item</h6>
                <div class="grid grid-cols-12 gap-2">
                    <div class="col-span-6 relative">
                        <input 
                            type="text" 
                            id="busca-produto-comanda" 
                            placeholder="Codigo de barras ou nome do produto"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                        <div id="dropdown-sugestoes-comanda" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-64 overflow-y-auto"></div>
                    </div>
                    <input type="number" id="add-quantidade" value="1" min="0.01" step="0.01" class="col-span-3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button onclick="document.getElementById('busca-produto-comanda').focus()" class="col-span-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-search mr-2"></i> Buscar
                    </button>
                </div>
                <small class="text-gray-500 text-xs mt-2 block">Digite o nome para pesquisar ou cole/digite o codigo e pressione ENTER</small>
            </div>

            <!-- Lista de Itens -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6"  style="max-height: 300px; overflow-y: auto;">
                <h6 class="font-medium mb-3">Itens da Comanda</h6>
                <div id="lista-itens-comanda">
                    <p class="text-gray-500 text-center">Nenhum item adicionado</p>
                </div>
            </div>

            <!-- Totais -->
            <div class="space-y-2 border-t pt-4 bg-gray-50 rounded-lg p-4 mt-6">
                <div class="flex justify-between text-lg">
                    <span>Subtotal:</span>
                    <span id="comanda-subtotal" class="font-bold">R$ 0,00</span>
                </div>
                <div class="flex justify-between text-green-600">
                    <span>Desconto:</span>
                    <span id="comanda-desconto" class="font-bold">-R$ 0,00</span>
                </div>
                <div class="flex justify-between text-orange-600">
                    <span>Acrescimo:</span>
                    <span id="comanda-acrescimo" class="font-bold">+R$ 0,00</span>
                </div>
                <div class="flex justify-between text-2xl font-bold bg-blue-50 p-3 rounded mt-2">
                    <span>Total:</span>
                    <span id="comanda-total">R$ 0,00</span>
                </div>
            </div>

            <!-- Botoes de Acao -->
            <div class="flex justify-between gap-2 mt-6">
                <button onclick="fecharModalDetalhes()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                    <i class="fas fa-arrow-left mr-2"></i> Voltar
                </button>
                <div class="flex gap-2">
                    <button onclick="cancelarComanda()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-times-circle mr-2"></i> Cancelar Comanda
                    </button>
                    <button onclick="fecharComanda()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-lg">
                        <i class="fas fa-check-circle mr-2"></i> Fechar Comanda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../js/services/estoque-central.js"></script>
    <script src="../js/services/comandas.js"></script>
    
    <script>
        // ===== SISTEMA DE LOGGING PARA AUDITORIA DE PROBLEMAS =====
        let eventosComandasLog = []; // Array para armazenar eventos em tempo real
        
        function registrarEvento(tipo, descricao, dados = {}) {
            const evento = {
                timestamp: new Date().toISOString(),
                hora: new Date().toLocaleTimeString(),
                tipo, // 'RELOAD', 'ACAO_USUARIO', 'SINCRONIZACAO', 'DETECCAO'
                descricao,
                dados
            };
            eventosComandasLog.push(evento);
            
            // Manter apenas os √∫ltimos 100 eventos
            if (eventosComandasLog.length > 100) {
                eventosComandasLog.shift();
            }
        }
        
        // Fun√ß√£o global para verificar logs (DEBUG no console)
        window.verHistoricoComandas = function() {
            console.log('%cüìä === HIST√ìRICO DE EVENTOS DAS COMANDAS (√∫ltimos 100) ===', 'color: blue; font-weight: bold; font-size: 14px;');
            console.table(eventosComandasLog);
            return eventosComandasLog;
        };
        
        window.verUltimoEvento = function() {
            if (eventosComandasLog.length === 0) {
                console.log('Nenhum evento registrado');
                return null;
            }
            const ultimo = eventosComandasLog[eventosComandasLog.length - 1];
            console.log(`√öltimo evento: ${ultimo.hora} | ${ultimo.tipo} | ${ultimo.descricao}`);
            return ultimo;
        };

        let todasComandas = [];
        let comandasFiltradas = [];
        let comandaAtual = null;
        let tipoFiltroAtual = "todas";
        let adicionandoItemComanda = false; // ‚úÖ Flag para evitar race condition
        let sincronizandoComanda = false; // ‚úÖ Flag para evitar m√∫ltiplas sincroniza√ß√µes simult√¢neas
        let itensLocaisComanda = []; // üöÄ Array local para opera√ß√µes instant√¢neas (como PDV)
        let historicoComandas = []; // üìÖ Hist√≥rico de comandas fechadas/canceladas
        let historicoFiltrado = []; // üîç Hist√≥rico filtrado por cliente

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                await checkAuth();
                
                document.getElementById("navbar").innerHTML = createNavbar();
                document.getElementById("sidebar-container").innerHTML = createSidebar();
                await initNavbar();
                await initSidebar();
                
                await carregarComandas();
                await carregarClientesSelect();
                await inicializarHistorico();
                
                // Setup busca de produto com autocomplete
                setupBuscaProduto();

                // ‚è∞ Polling peri√≥dico: 30s normalmente, 10s quando comanda aberta (detecta mudan√ßas)
                let ultimoReload = Date.now();
                setInterval(async () => {
                    const agora = Date.now();
                    const intervaloMinimo = (comandaAtual && comandaAtual.id) ? 10000 : 30000; // 10s se aberta, 30s se n√£o
                    
                    if (agora - ultimoReload >= intervaloMinimo) {
                        console.log(`üîÑ [${new Date().toLocaleTimeString()}] Recarregando comandas (pool autom√°tico)...`);
                        await carregarComandas();
                        ultimoReload = agora;
                    }
                }, 5000); // Verificar a cada 5 segundos
            } catch (error) {
                console.error("Erro ao inicializar comandas:", error);
                window.location.href = "/index.html";
            }
        });

        async function carregarComandas() {
            try {
                const tempoInicio = performance.now();
                console.log(`\nüìã [${new Date().toLocaleTimeString()}] === CARREGANDO COMANDAS ===`);
                registrarEvento('RELOAD', 'Iniciando carregamento de comandas');
                
                todasComandas = await ServicoComandasService.buscarComandasAbertas();
                const contagem = await ServicoComandasService.contarComandasAbertas();

                document.getElementById("count-total").textContent = contagem.total;
                document.getElementById("count-mesas").textContent = contagem.mesa;
                document.getElementById("count-balcao").textContent = contagem.balcao;
                document.getElementById("count-delivery").textContent = contagem.delivery;

                // üìä Logging detalhado
                const tempoDecorrido = (performance.now() - tempoInicio).toFixed(0);
                console.log(`‚úÖ Comandas carregadas: ${contagem.total} total | ${contagem.mesa} mesas | ${contagem.balcao} balc√£o | ${contagem.delivery} delivery`);
                console.log(`‚è±Ô∏è Tempo: ${tempoDecorrido}ms`);
                registrarEvento('RELOAD', `Comandas carregadas: ${contagem.total} total`, { ...contagem, tempoMs: tempoDecorrido });
                
                // üîç Se h√° comanda aberta, monitorar mudan√ßas de status
                if (comandaAtual?.id) {
                    const comandaAtualizada = todasComandas.find(c => c.id === comandaAtual.id);
                    if (comandaAtualizada) {
                        if (comandaAtualizada.status !== comandaAtual.status) {
                            console.warn(`‚ö†Ô∏è STATUS MUDOU da comanda aberta: ${comandaAtual.status} ‚Üí ${comandaAtualizada.status}`);
                            registrarEvento('DETECCAO', `STATUS MUDOU: ${comandaAtual.status} ‚Üí ${comandaAtualizada.status}`, { comandaId: comandaAtual.id });
                        }
                        if (JSON.stringify(comandaAtualizada.itens) !== JSON.stringify(comandaAtual.itens)) {
                            console.warn(`‚ö†Ô∏è ITENS MUDARAM na comanda aberta!`);
                            console.log(`  Antes: ${comandaAtual.itens?.length || 0} itens`);
                            console.log(`  Depois: ${comandaAtualizada.itens?.length || 0} itens`);
                            registrarEvento('DETECCAO', `ITENS MUDARAM: ${comandaAtual.itens?.length} ‚Üí ${comandaAtualizada.itens?.length}`, { comandaId: comandaAtual.id });
                        }
                    } else {
                        console.error(`üö® COMANDA DESAPARECEU DO CARREGAMENTO: ${comandaAtual.id}`);
                        registrarEvento('AVISO', `COMANDA DESAPARECEU: ${comandaAtual.id}`, { comandaId: comandaAtual.id });
                    }
                }

                filtrarPorTipo(tipoFiltroAtual);
            } catch (erro) {
                console.error("‚ùå Erro ao carregar comandas:", erro);
                registrarEvento('DETECCAO', 'ERRO ao carregar comandas', { erro: erro.message });
            }
        }

        function filtrarPorTipo(tipo) {
            tipoFiltroAtual = tipo;
            
            document.querySelectorAll(".tab-tipo").forEach(tab => {
                tab.classList.toggle("active", tab.dataset.tipo === tipo);
            });

            comandasFiltradas = tipo === "todas" ? todasComandas : todasComandas.filter(c => c.tipo === tipo);
            
            renderizarGrid();
        }

        function renderizarGrid() {
            const container = document.getElementById("comandas-container");
            
            if (comandasFiltradas.length === 0) {
                container.innerHTML = '<div class="col-span-4 text-center text-gray-500 py-12">Nenhuma comanda aberta</div>';
                return;
            }

            container.innerHTML = comandasFiltradas.map(comanda => {
                const qtdItens = comanda.itens.length;
                const valorTotal = comanda.valor_total || 0;
                const clienteNome = comanda.cliente?.nome || comanda.cliente_nome || "Sem cliente";
                
                // Mostrar n√∫mero da mesa se dispon√≠vel, sen√£o mostrar tipo
                let displayInfo = '';
                if (comanda.numero_mesa) {
                    displayInfo = `Mesa ${comanda.numero_mesa}`;
                } else {
                    const tipoIcon = {
                        'mesa': 'fa-utensils',
                        'balcao': 'fa-store',
                        'delivery': 'fa-motorcycle'
                    };
                    displayInfo = `<i class="fas ${tipoIcon[comanda.tipo] || 'fa-receipt'} mr-1"></i>${comanda.tipo}`;
                }

                return `
                    <div class="comanda-card aberta" onclick="abrirDetalhesComanda('${comanda.id}')"
                        <span class="absolute top-3 right-3 bg-green-500 text-white text-xs px-2 py-1 rounded">
                            ${qtdItens} ${qtdItens === 1 ? "item" : "itens"}
                        </span>
                        <div class="text-2xl font-bold mb-1">
                            ${displayInfo}
                        </div>
                        <div class="text-sm text-gray-500 mb-2">
                            <i class="fas fa-hashtag mr-1"></i>${comanda.numero_comanda}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-user mr-2"></i>${clienteNome}
                        </div>
                        <div class="text-sm text-gray-600 mb-3">
                            <i class="fas fa-clock mr-2"></i>${formatarHora(comanda.data_abertura)}
                        </div>
                        <div class="text-xl font-bold text-green-600">
                            R$ ${valorTotal.toLocaleString("pt-BR", {minimumFractionDigits: 2})}
                        </div>
                    </div>
                `;
            }).join("");
        }

        async function abrirDetalhesComanda(comandaId) {
            try {
                // ‚õî AGUARDAR SE HOUVER SINCRONIZA√á√ÉO EM ANDAMENTO
                if (sincronizandoComanda) {
                    console.warn('‚è≥ Aguardando sincroniza√ß√£o anterior terminar...');
                    await new Promise(resolve => {
                        const checkSync = setInterval(() => {
                            if (!sincronizandoComanda) {
                                clearInterval(checkSync);
                                resolve();
                            }
                        }, 100);
                    });
                }

                const inicio = performance.now();
                
                // üöÄ Se j√° temos a comanda carregada, s√≥ atualizar itens (mais r√°pido)
                if (comandaAtual && comandaAtual.id === comandaId) {
                    console.log('üöÄ Atualizando apenas itens (otimizado)...');
                    const itens = await ServicoComandasService.atualizarItensComanda(comandaId);
                    comandaAtual.itens = itens;
                } else {
                    // Primeira vez carregando, buscar dados completos
                    console.log('üì• Carregando comanda completa...');
                    comandaAtual = await ServicoComandasService.buscarComandaPorId(comandaId);
                }
                
                // üöÄ CARREGAR ITENS EM ARRAY LOCAL (com dedupilca√ß√£o por produto_id)
                const itensMap = new Map(); // ‚úÖ Usar Map para evitar duplicatas
                (comandaAtual.itens || []).forEach(item => {
                    const key = String(item.produto_id); // ‚úÖ Normalizar como string
                    if (!itensMap.has(key)) {
                        itensMap.set(key, {
                            id: item.id,
                            produto_id: item.produto_id,
                            nome_produto: item.nome_produto,
                            quantidade: item.quantidade,
                            preco_unitario: item.preco_unitario,
                            subtotal: item.subtotal,
                            status: item.status,
                            observacoes: item.observacoes
                        });
                    }
                });
                itensLocaisComanda = Array.from(itensMap.values());
                
                // Mostrar Mesa X se tiver numero_mesa, sen√£o s√≥ o numero_comanda
                let tituloComanda = comandaAtual.numero_mesa 
                    ? `Mesa ${comandaAtual.numero_mesa} (${comandaAtual.numero_comanda})`
                    : comandaAtual.numero_comanda;
                
                document.getElementById("titulo-comanda").textContent = tituloComanda;
                document.getElementById("comanda-cliente-nome-display").textContent = 
                    comandaAtual.cliente?.nome || comandaAtual.cliente_nome || "Sem cliente";
                document.getElementById("comanda-data-abertura").textContent = 
                    formatarDataHora(comandaAtual.data_abertura);

                renderizarItensComandaLocal();
                atualizarTotaisLocal();
                
                // Re-setup busca ao abrir modal
                setupBuscaProduto();

                document.getElementById("modalDetalhesComanda").classList.remove("hidden");
                
                const tempo = (performance.now() - inicio).toFixed(0);
                console.log(`‚úÖ Modal aberto em ${tempo}ms`);
            } catch (erro) {
                console.error("Erro ao carregar detalhes:", erro);
                mostrarMensagem('Erro', 'Erro ao carregar detalhes da comanda', 'erro');
            }
        }


        // üöÄ Removed old renderizarItensComanda - using renderizarItensComandaLocal instead

        async function adicionarProdutoPorId(produtoId) {
            // ‚úÖ BLOQUEAR CLIQUES M√öLTIPLOS ENQUANTO EST√Å PROCESSANDO
            if (adicionandoItemComanda) {
                console.warn('‚ö†Ô∏è J√° est√° adicionando item, aguarde...');
                return;
            }
            
            const quantidade = parseFloat(document.getElementById("add-quantidade").value);

            if (!produtoId || quantidade <= 0) {
                mostrarMensagem('Aten√ß√£o', 'Produto ou quantidade inv√°lida', 'aviso');
                return;
            }

            try {
                // üöÄ MARCAR COMO PROCESSANDO
                adicionandoItemComanda = true;
                
                // ‚è±Ô∏è TIMEOUT DE SEGURAN√áA (libera ap√≥s 15s mesmo se der erro)
                const timeoutId = setTimeout(() => {
                    adicionandoItemComanda = false;
                    console.warn('‚ö†Ô∏è Timeout de 15s atingido, liberando flag de processamento');
                }, 15000);

                const inputBusca = document.getElementById("busca-produto-comanda");
                const inputQuantidade = document.getElementById("add-quantidade");
                
                // Desabilitar visualmente
                inputBusca.disabled = true;
                inputQuantidade.disabled = true;
                inputBusca.style.opacity = "0.5";
                inputQuantidade.style.opacity = "0.5";
                inputBusca.style.cursor = "not-allowed";
                inputQuantidade.style.cursor = "not-allowed";
                
                // üöÄ BUSCAR PRODUTO (r√°pido - apenas uma query)
                const { data: produto, error: erroP } = await supabase
                    .from('produtos')
                    .select('id, nome, preco_venda, exige_estoque')
                    .eq('id', produtoId)
                    .single();

                if (erroP || !produto) {
                    throw new Error('Produto n√£o encontrado');
                }

                // ‚úÖ VALIDAR ESTOQUE CONSIDERANDO OUTRAS COMANDAS (mesmo padr√£o do backend)
                if (produto.exige_estoque !== false) {
                    const estoqueDisponivel = await ServicoComandasService.calcularEstoqueDisponivel(produtoId, comandaAtual.id);
                    const quantidadeJaAdicionada = itensLocaisComanda
                        .filter(i => i.produto_id === produtoId)
                        .reduce((sum, i) => sum + i.quantidade, 0);
                    const quantidadeTotalNecessaria = quantidadeJaAdicionada + quantidade;

                    if (quantidadeTotalNecessaria > estoqueDisponivel) {
                        throw new Error(
                            `Estoque insuficiente para ${produto.nome}\n` +
                            `J√° adicionado nesta comanda: ${quantidadeJaAdicionada.toFixed(2)}\n` +
                            `Novo: ${quantidade.toFixed(2)}\n` +
                            `Total: ${quantidadeTotalNecessaria.toFixed(2)}\n` +
                            `Dispon√≠vel (outras comandas descontadas): ${estoqueDisponivel.toFixed(2)}`
                        );
                    }
                } else {
                    console.log(`‚ÑπÔ∏è Produto ${produto.nome} n√£o exige valida√ß√£o de estoque`);
                }

                // üöÄ ADICIONAR LOCALMENTE (INSTANT√ÇNEO!)
                const itemExistenteIdx = itensLocaisComanda.findIndex(i => 
                    String(i.produto_id) === String(produtoId)  // ‚úÖ Comparar como string para evitar problemas de tipagem
                );
                if (itemExistenteIdx >= 0) {
                    // ‚úÖ ITEM J√Å EXISTE - AUMENTAR QUANTIDADE
                    itensLocaisComanda[itemExistenteIdx].quantidade += quantidade;
                    itensLocaisComanda[itemExistenteIdx].subtotal = 
                        itensLocaisComanda[itemExistenteIdx].quantidade * itensLocaisComanda[itemExistenteIdx].preco_unitario;
                    console.log(`‚úÖ Produto aumentado: quantidade=${itensLocaisComanda[itemExistenteIdx].quantidade}`);
                } else {
                    // ‚ùå ITEM N√ÉO EXISTE - CRIAR NOVO
                    itensLocaisComanda.push({
                        id: `temp-${Date.now()}`,
                        produto_id: produtoId,
                        nome_produto: produto.nome,
                        quantidade: quantidade,
                        preco_unitario: parseFloat(produto.preco_venda),
                        subtotal: parseFloat(produto.preco_venda) * quantidade,
                        status: 'pendente',
                        observacoes: null
                    });
                    console.log(`‚úÖ Novo produto adicionado: ${produto.nome}`);
                }

                // üöÄ RENDERIZAR IMEDIATAMENTE (sem esperar banco)
                renderizarItensComandaLocal();
                atualizarTotaisLocal();

                // üöÄ LIMPAR INPUTS
                document.getElementById("add-quantidade").value = "1";
                document.getElementById("busca-produto-comanda").value = "";
                
                console.log(`üì¶ [${new Date().toLocaleTimeString()}] Produto adicionado: ${produto.nome} (qty: ${quantidade})`);

                // üöÄ SINCRONIZAR COM BANCO EM BACKGROUND (n√£o bloqueia UX)
                sincronizarItensBanco(comandaAtual.id).catch(err => {
                    console.error('‚ùå Erro ao sincronizar com banco:', err);
                    mostrarMensagem('Aviso', 'Item adicionado localmente, mas erro ao sincronizar', 'aviso');
                });

                // Limpar timeout se chegou aqui sem erro
                clearTimeout(timeoutId);

            } catch (erro) {
                console.error("Erro ao adicionar item:", erro);
                mostrarMensagem('Erro', erro.message, 'erro');
            } finally {
                // üöÄ LIBERAR CLIQUES NOVAMENTE
                adicionandoItemComanda = false;
                const inputBusca = document.getElementById("busca-produto-comanda");
                const inputQuantidade = document.getElementById("add-quantidade");
                inputBusca.disabled = false;
                inputQuantidade.disabled = false;
                inputBusca.style.opacity = "1";
                inputQuantidade.style.opacity = "1";
                inputBusca.style.cursor = "text";
                inputQuantidade.style.cursor = "text";
            }
        }

        // üöÄ RENDERIZAR ITENS DO ARRAY LOCAL
        function renderizarItensComandaLocal() {
            const container = document.getElementById("lista-itens-comanda");
            
            // ‚úÖ FILTRAR ITENS V√ÅLIDOS (com produto_id e nome_produto)
            const itensValidos = itensLocaisComanda.filter(item => 
                item.status !== "cancelado" && 
                item.produto_id && 
                item.nome_produto
            );
            
            if (!itensValidos || itensValidos.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Nenhum item adicionado</p>';
                return;
            }

            container.innerHTML = itensValidos.map(item => {
                return `
                    <div class="flex justify-between items-center py-3 border-b border-gray-200 gap-3">
                        <div class="flex-grow min-w-0">
                            <div class="font-medium">${item.nome_produto}</div>
                            <div class="text-sm text-gray-600">
                                ${item.quantidade} x R$ ${item.preco_unitario.toFixed(2)}
                            </div>
                            ${item.observacoes ? `<div class="text-xs text-gray-500 mt-1"><i class="fas fa-comment mr-1"></i>${item.observacoes}</div>` : ""}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                                <button onclick="alterarQuantidadeItemLocal('${item.produto_id}', ${item.quantidade - 1})" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm" ${item.quantidade <= 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="px-3 font-bold text-sm">${item.quantidade.toFixed(2)}</span>
                                <button onclick="alterarQuantidadeItemLocal('${item.produto_id}', ${item.quantidade + 1})" class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="font-bold text-lg text-right min-w-[80px]">R$ ${item.subtotal.toFixed(2)}</div>
                            <button onclick="removerItemComandaLocal('${item.produto_id}')" class="text-red-600 hover:text-red-800 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join("");
        }

        // üöÄ ATUALIZAR TOTAIS LOCALMENTE
        function atualizarTotaisLocal() {
            // ‚úÖ CONSIDERAR APENAS ITENS V√ÅLIDOS (com produto_id e nome_produto)
            const itensValidos = itensLocaisComanda.filter(item => 
                item.status !== "cancelado" && 
                item.produto_id && 
                item.nome_produto
            );
            
            const subtotal = itensValidos.reduce((sum, item) => sum + (item.subtotal || 0), 0);
            const desconto = (comandaAtual?.desconto || 0);
            const acrescimo = (comandaAtual?.acrescimo || 0);
            const total = subtotal - desconto + acrescimo;

            document.getElementById("comanda-subtotal").textContent = "R$ " + subtotal.toFixed(2);
            document.getElementById("comanda-desconto").textContent = "-R$ " + desconto.toFixed(2);
            document.getElementById("comanda-acrescimo").textContent = "+R$ " + acrescimo.toFixed(2);
            document.getElementById("comanda-total").textContent = "R$ " + total.toFixed(2);
        }

        // üöÄ REMOVER ITEM LOCALMENTE
        function removerItemComandaLocal(produtoId) {
            itensLocaisComanda = itensLocaisComanda.filter(i => i.produto_id !== produtoId);
            renderizarItensComandaLocal();
            atualizarTotaisLocal();
            sincronizarItensBanco(comandaAtual.id).catch(err => console.error('Erro ao sincronizar:', err));
        }

        // üöÄ ALTERAR QUANTIDADE LOCALMENTE
        function alterarQuantidadeItemLocal(produtoId, novaQuantidade) {
            if (novaQuantidade <= 0) {
                removerItemComandaLocal(produtoId);
                return;
            }

            const item = itensLocaisComanda.find(i => i.produto_id === produtoId);
            if (item) {
                item.quantidade = novaQuantidade;
                item.subtotal = item.preco_unitario * novaQuantidade;
                renderizarItensComandaLocal();
                atualizarTotaisLocal();
                sincronizarItensBanco(comandaAtual.id).catch(err => console.error('Erro ao sincronizar:', err));
            }
        }

        // üöÄ SINCRONIZAR ITENS LOCAIS COM BANCO (background)
        async function sincronizarItensBanco(comandaId) {
            try {
                // ‚õî EVITAR M√öLTIPLAS SINCRONIZA√á√ïES SIMULT√ÇNEAS (CAUSA DUPLICA√á√ÉO!)
                if (sincronizandoComanda) {
                    console.warn('‚ö†Ô∏è Sincroniza√ß√£o j√° em andamento, ignorando nova chamada');
                    return;
                }

                sincronizandoComanda = true;
                console.log('üîÑ Sincronizando itens com banco...');
                
                const { data: { user } } = await supabase.auth.getUser();

                // ‚úÖ FILTRAR APENAS ITENS V√ÅLIDOS (com produto_id e nome_produto)
                const itensValidos = itensLocaisComanda.filter(item => 
                    item.status !== "cancelado" && 
                    item.produto_id && 
                    item.nome_produto
                );

                // ‚ö†Ô∏è PROTE√á√ÉO: Se n√£o h√° itens v√°lidos, n√£o deletar tudo (evita comanda vazia)
                if (itensValidos.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum item v√°lido para sincronizar. Mantendo comanda intacta.');
                    sincronizandoComanda = false;
                    return;
                }

                // ‚ùå DELETAR TODOS OS ITENS PENDENTES ANTIGOS (APENAS se h√° novas items para salvar)
                const { error: erroDelete } = await supabase
                    .from('comanda_itens')
                    .delete()
                    .eq('comanda_id', comandaId)
                    .eq('status', 'pendente');

                if (erroDelete) throw erroDelete;

                // ‚úÖ INSERIR TODOS OS ITENS V√ÅLIDOS
                const itensParaSalvar = itensValidos.map(item => ({
                    comanda_id: comandaId,
                    produto_id: item.produto_id,
                    nome_produto: item.nome_produto,
                    quantidade: item.quantidade,
                    preco_unitario: item.preco_unitario,
                    subtotal: item.subtotal,
                    observacoes: item.observacoes,
                    usuario_id: user?.id,
                    status: 'pendente'
                }));

                const { error: erroInsert } = await supabase
                    .from('comanda_itens')
                    .insert(itensParaSalvar);

                if (erroInsert) throw erroInsert;

                // üìä Recalcular totais da comanda
                const subtotal = itensValidos.reduce((sum, item) => sum + (item.subtotal || 0), 0);
                const { error: errorUpdate } = await supabase
                    .from('comandas')
                    .update({
                        subtotal: subtotal,
                        valor_total: subtotal + (comandaAtual?.acrescimo || 0) - (comandaAtual?.desconto || 0),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', comandaId);

                if (errorUpdate) throw errorUpdate;
                
                console.log('‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso');
                
                // üîÑ Reload autom√°tico ap√≥s sincroniza√ß√£o
                console.log('‚è±Ô∏è Agendando reload em 300ms para refletir mudan√ßas...');
                setTimeout(async () => {
                    console.log(`üîÑ [${new Date().toLocaleTimeString()}] Recarregando comandas ap√≥s sincroniza√ß√£o...`);
                    await carregarComandas();
                }, 300);
                
                // üîÑ Reload autom√°tico ap√≥s sincroniza√ß√£o
                console.log('‚è±Ô∏è Agendando reload em 500ms para refletir mudan√ßas...');
                setTimeout(async () => {
                    console.log('üîÑ Recarregando comandas ap√≥s sincroniza√ß√£o...');
                    await carregarComandas();
                }, 500);
            } catch (erro) {
                console.error('‚ùå Erro ao sincronizar:', erro);
                mostrarMensagem('Erro', 'Erro ao sincronizar com banco: ' + erro.message, 'erro');
            } finally {
                sincronizandoComanda = false;
            }
        }

        async function alterarQuantidadeItem(itemId, novaQuantidade) {
            if (novaQuantidade <= 0) {
                // Se quantidade for 0 ou menor, remove o item
                removerItemComandaLocal(itemId);
                return;
            }

            try {
                // Buscar o produto do item para validar estoque
                const item = itensLocaisComanda.find(i => i.id === itemId);
                if (!item) {
                    throw new Error('Item n√£o encontrado');
                }

                // üîì Pular valida√ß√£o se exige_estoque = false (servi√ßos, vouchers, etc)
                const { data: produto } = await supabase
                    .from('produtos')
                    .select('nome, exige_estoque')
                    .eq('id', item.produto_id)
                    .single();

                if (produto?.exige_estoque !== false) {
                    // ‚úÖ VALIDAR COM OUTRAS COMANDAS DESCONTADAS (mesmo padr√£o do backend)
                    const estoqueDisponivel = await ServicoComandasService.calcularEstoqueDisponivel(item.produto_id, comandaAtual.id);
                    
                    if (novaQuantidade > estoqueDisponivel) {
                        mostrarMensagem(
                            'Estoque Insuficiente',
                            `Dispon√≠vel (outras comandas descontadas): ${estoqueDisponivel.toFixed(2)}\nSolicitado: ${novaQuantidade.toFixed(2)}`,
                            'aviso'
                        );
                        return;
                    }
                } else {
                    console.log(`‚ÑπÔ∏è Produto ${produto?.nome} n√£o exige valida√ß√£o de estoque`);
                }

                alterarQuantidadeItemLocal(item.produto_id, novaQuantidade);
            } catch (erro) {
                console.error("Erro ao alterar quantidade:", erro);
                mostrarMensagem('Erro', 'Erro ao alterar quantidade: ' + erro.message, 'erro');
            }
        }

        async function fecharComanda() {
            exibirTelaFinalizacaoComanda();
        }

        function exibirTelaFinalizacaoComanda() {
            console.log('üîµ Abrindo modal de finalizacao da comanda...');
            // üöÄ Calcular total localmente
            const subtotal = itensLocaisComanda.reduce((sum, item) => sum + item.subtotal, 0);
            const desconto = (comandaAtual?.desconto || 0);
            const acrescimo = (comandaAtual?.acrescimo || 0);
            const total = subtotal - desconto + acrescimo;
            
            // Criar elementos
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.id = 'modal-finalizar-comanda-overlay';
            
            const container = document.createElement('div');
            container.className = 'bg-white p-6 rounded-lg max-w-lg w-full mx-4';
            
            // Construir HTML manualmente
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Finalizar Comanda</h3>
                <p class="text-gray-600 mb-4">Total: <strong>R$ ${total.toFixed(2)}</strong></p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Forma de Pagamento</label>
                    <select id="forma-pagamento-comanda" class="w-full border rounded px-3 py-2">
                        <option value="DINHEIRO">Dinheiro</option>
                        <option value="PIX">PIX</option>
                        <option value="CARTAO_DEBITO">Cartao Debito</option>
                        <option value="CARTAO_CREDITO">Cartao Credito</option>
                        <option value="PRAZO">A Prazo</option>
                    </select>
                </div>

                <div id="secao-acrescimo-comanda" class="mb-4 hidden">
                    <label class="block text-sm font-medium mb-2">Acrescimo (Tarifa) - <span id="taxa-percentual-comanda" class="text-blue-600 text-xs font-bold"></span></label>
                    <div class="flex gap-2">
                        <input type="number" id="acrescimo-tarifa-comanda" class="flex-1 border rounded px-3 py-2" placeholder="0.00" step="0.01" min="0">
                        <span class="flex items-center text-gray-600 font-medium">R$</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1"><span id="taxa-descricao-comanda">Valor da tarifa</span></p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Valor Recebido</label>
                    <input type="number" id="valor-pago-comanda" class="w-full border rounded px-3 py-2" value="${total.toFixed(2)}" step="0.01" min="0">
                </div>

                <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
                    <div class="text-sm">Troco: <strong id="troco-valor-comanda" class="text-blue-600 font-bold">R$ 0.00</strong></div>
                </div>

                <div class="flex gap-2">
                    <button id="btn-cancelar-comanda" class="flex-1 px-4 py-2 border rounded hover:bg-gray-100">Cancelar</button>
                    <button id="btn-confirmar-comanda" class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Confirmar</button>
                </div>
            `;
            
            overlay.appendChild(container);
            document.body.appendChild(overlay);

            // Agora buscar os elementos (ja estao no DOM)
            const formaPagamentoSelect = container.querySelector('#forma-pagamento-comanda');
            const secaoAcrescimo = container.querySelector('#secao-acrescimo-comanda');
            const acrescimoTarifaInput = container.querySelector('#acrescimo-tarifa-comanda');
            const valorPagoInput = container.querySelector('#valor-pago-comanda');
            const trocoValor = container.querySelector('#troco-valor-comanda');
            const btnCancelar = container.querySelector('#btn-cancelar-comanda');
            const btnConfirmar = container.querySelector('#btn-confirmar-comanda');

            if (!valorPagoInput || !trocoValor) {
                console.error('‚ùå Elementos nao encontrados!');
                return;
            }

            // Funcao para calcular e atualizar troco
            const atualizarTroco = (e) => {
                const acrescimo = parseFloat(acrescimoTarifaInput.value) || 0;
                // ‚úÖ IMPORTANTE: Taxa N√ÉO afeta o troco!
                // Cliente paga o valor total normal, taxa √© desconto do estabelecimento
                const valorPago = parseFloat(valorPagoInput.value) || 0;
                const troco = valorPago - total;
                trocoValor.textContent = `R$ ${troco.toFixed(2)}`;
                
                console.log(`üí∞ Calculo: R$ ${valorPago.toFixed(2)} - R$ ${total.toFixed(2)} = R$ ${troco.toFixed(2)} (taxa ${acrescimo.toFixed(2)} √© desconto do lojista, n√£o afeta cliente)`);
                
                // Mudar cor conforme o troco
                if (troco < -0.01) {
                    trocoValor.className = 'text-red-600 font-bold';
                } else if (Math.abs(troco) < 0.01) {
                    trocoValor.className = 'text-green-600 font-bold';
                } else {
                    trocoValor.className = 'text-blue-600 font-bold';
                }
            };

            // Listener para mudanca de forma de pagamento
            formaPagamentoSelect.addEventListener('change', (e) => {
                const forma = e.target.value;
                const isCartao = forma === 'CARTAO_CREDITO' || forma === 'CARTAO_DEBITO';
                
                if (isCartao) {
                    secaoAcrescimo.classList.remove('hidden');
                    
                    // Definir taxa
                    let taxa = 0;
                    let descricao = '';
                    
                    if (forma === 'CARTAO_DEBITO') {
                        taxa = 1.09; // 1,09%
                        descricao = 'Taxa de debito: 1,09%';
                    } else if (forma === 'CARTAO_CREDITO') {
                        taxa = 3.16; // 3,16%
                        descricao = 'Taxa de credito: 3,16%';
                    }
                    
                    // üí° IMPORTANTE: Taxa √© apenas INFORMATIVA na tela!
                    // N√£o afeta nenhum c√°lculo de troco ou valor a pagar
                    const taxaValor = (total * taxa) / 100;
                    
                    // Mostrar apenas a taxa (N√ÉO editar campo de acrescimo)
                    acrescimoTarifaInput.value = taxaValor.toFixed(2);
                    acrescimoTarifaInput.disabled = true; // Desabilitar edi√ß√£o
                    
                    // Atualizar descricao
                    container.querySelector('#taxa-percentual-comanda').textContent = `${taxa.toFixed(2)}%`;
                    container.querySelector('#taxa-descricao-comanda').textContent = descricao;
                    
                    // ‚úÖ MANTER valor a cobrar igual ao total (SEM adicionar taxa na tela)
                    valorPagoInput.value = total.toFixed(2);
                    
                    console.log(`üí≥ ${forma}: Taxa ${taxa}% = R$ ${taxaValor.toFixed(2)} (apenas informativa)`);
                } else {
                    secaoAcrescimo.classList.add('hidden');
                    acrescimoTarifaInput.value = '0';
                    acrescimoTarifaInput.disabled = false;
                    valorPagoInput.value = total.toFixed(2);
                    container.querySelector('#taxa-percentual-comanda').textContent = '';
                    container.querySelector('#taxa-descricao-comanda').textContent = 'Valor da tarifa';
                }
                
                atualizarTroco();
            });

            // Inicializar troco
            atualizarTroco();

            // Listeners para eventos
            valorPagoInput.addEventListener('change', atualizarTroco);
            valorPagoInput.addEventListener('keyup', atualizarTroco);
            valorPagoInput.addEventListener('input', atualizarTroco);
            acrescimoTarifaInput.addEventListener('change', atualizarTroco);
            acrescimoTarifaInput.addEventListener('keyup', atualizarTroco);
            acrescimoTarifaInput.addEventListener('input', atualizarTroco);

            // Cancelar venda - usar { once: true } para evitar multiplos listeners
            btnCancelar.addEventListener('click', () => {
                console.log('‚ùå Cancelando finalizacao...');
                overlay.remove();
            }, { once: true });

            // Confirmar pagamento
            btnConfirmar.addEventListener('click', (e) => {
                console.log('‚úÖ Confirmar clicado');
                e.preventDefault();
                e.stopPropagation();
                
                const forma = container.querySelector('#forma-pagamento-comanda')?.value;
                const valorPago = parseFloat(container.querySelector('#valor-pago-comanda')?.value);
                const acrescimo = parseFloat(container.querySelector('#acrescimo-tarifa-comanda')?.value) || 0;

                console.log('üí≥ Confirmando pagamento:', { forma, valorPago, acrescimo });

                if (!forma) {
                    mostrarMensagem('Aten√ß√£o', 'Selecione uma forma de pagamento!', 'aviso');
                    return;
                }

                if (isNaN(valorPago) || valorPago < 0) {
                    mostrarMensagem('Aten√ß√£o', 'Digite um valor v√°lido!', 'aviso');
                    return;
                }

                // Adicionar feedback visual ANTES de processar
                btnConfirmar.disabled = true;
                btnCancelar.disabled = true;
                btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';
                
                // Chamar finalizarComandaFinal (async)
                (async () => {
                    try {
                        // üí° Taxa √© apenas INFORMATIVA - n√£o afeta c√°lculos na tela
                        // Cliente sempre paga o valor total sem taxa adicionada
                        const totalAcobrar = total; // Valor REAL que cliente paga (sem taxa)
                        const troco = valorPago - totalAcobrar; // Troco baseado no valor real
                        
                        // Chamar servi√ßo passando:
                        // - acrescimo: 0 (taxa N√ÉO √© acrescimo, √© apenas informativa)
                        // - forumla: sempre ser√° o valor real sem taxa
                        console.log(`üìä Processando: Total=${totalAcobrar.toFixed(2)}, Pago=${valorPago.toFixed(2)}, Troco=${troco.toFixed(2)}`);
                        
                        await ServicoComandasService.fecharComanda(comandaAtual.id, forma, valorPago, 0);
                        console.log(`‚úÖ Comanda finalizada com sucesso: ${comandaAtual.numero_comanda}`);
                        
                        // Fechar overlay e exibir cupom
                        overlay.remove();
                        exibirCupomComanda({
                            numero: comandaAtual.numero_comanda,
                            total: totalAcobrar,
                            valorPago: valorPago,
                            troco: troco,
                            forma: forma
                        });
                        
                        fecharModalDetalhes();
                        console.log(`üîÑ [${new Date().toLocaleTimeString()}] Recarregando ap√≥s fechar comanda...`);
                        await carregarComandas();
                        
                        // Extra: Reload adicional ap√≥s 1 segundo para garantir sincroniza√ß√£o
                        setTimeout(() => {
                            console.log(`üîÑ [${new Date().toLocaleTimeString()}] Reload extra de seguran√ßa (1s)...`);
                            carregarComandas();
                        }, 1000);
                    } catch (erro) {
                        console.error('‚ùå Erro ao finalizar comanda:', erro);
                        console.error('üìã Stack:', erro.stack);
                        mostrarMensagem('Erro', erro.message, 'erro');
                        
                        // Reabilitar botoes para retry
                        btnConfirmar.disabled = false;
                        btnCancelar.disabled = false;
                        btnConfirmar.innerHTML = 'Confirmar';
                    }
                })();
            });

            // Fechar ao clicar no overlay (fora do container)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay || e.target.id === 'modal-finalizar-comanda-overlay') {
                    console.log('üö™ Fechando modal por clique no overlay');
                    overlay.remove();
                }
            });
            
            // Impedir que cliques no container fechem o modal
            container.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Focus no input para facilitar digitacao
            valorPagoInput.focus();
            valorPagoInput.select();
        }

        // ===== FUN√á√ïES DE HIST√ìRICO =====

        async function inicializarHistorico() {
            try {
                // Setar data padr√£o como "hoje" em formato datetime-local
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                const horas = String(hoje.getHours()).padStart(2, '0');
                const minutos = String(hoje.getMinutes()).padStart(2, '0');
                
                const dataHoje = `${ano}-${mes}-${dia}T${horas}:${minutos}`;
                
                const inputData = document.getElementById('filtro-data-historico');
                if (inputData) {
                    inputData.value = dataHoje;
                    console.log(`üìÖ Data padr√£o do hist√≥rico setada para: ${dataHoje}`);
                    
                    // Carregar hist√≥rico automaticamente
                    await carregarHistoricoComandas();
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar hist√≥rico:', error);
            }
        }

        function mudarAbaSecao(aba) {
            // Atualizar abas ativas
            document.querySelectorAll('.tab-abas').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-aba="${aba}"]`).classList.add('active');

            // Mostrar/esconder se√ß√µes
            document.getElementById('secao-abertos').classList.toggle('hidden', aba === 'historico');
            document.getElementById('secao-historico').classList.toggle('hidden', aba === 'abertos');

            // Carregar hist√≥rico se for a primeira vez
            if (aba === 'historico' && historicoComandas.length === 0) {
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('filtro-data-historico').value = hoje;
                carregarHistoricoComandas();
            }
        }

        async function carregarHistoricoComandas() {
            try {
                const dataInputStr = document.getElementById('filtro-data-historico').value;
                if (!dataInputStr) {
                    mostrarMensagem('Aten√ß√£o', 'Por favor, selecione uma data', 'aviso');
                    return;
                }

                // Extrair apenas a data (YYYY-MM-DD) do datetime-local
                const dataParte = dataInputStr.split('T')[0]; // Pega apenas YYYY-MM-DD
                const dataInicio = `${dataParte}T00:00:00`;
                const dataFim = `${dataParte}T23:59:59`;

                console.log(`üìÖ Carregando hist√≥rico para ${dataParte}`);
                console.log(`üìÖ Range: ${dataInicio} a ${dataFim}`);

                // Buscar comandas fechadas ou canceladas do dia
                const { data, error } = await supabase
                    .from('comandas')
                    .select(`
                        id,
                        numero_comanda,
                        tipo,
                        numero_mesa,
                        cliente_nome,
                        cliente:clientes(nome),
                        data_abertura,
                        data_fechamento,
                        status,
                        valor_total,
                        itens:comanda_itens(count)
                    `)
                    .in('status', ['fechada', 'cancelada'])
                    .gte('data_fechamento', dataInicio)
                    .lte('data_fechamento', dataFim)
                    .order('data_fechamento', { ascending: false });

                if (error) throw error;

                historicoComandas = data || [];
                historicoFiltrado = historicoComandas;

                // Atualizar contadores
                const fechadas = historicoComandas.filter(c => c.status === 'fechada').length;
                const canceladas = historicoComandas.filter(c => c.status === 'cancelada').length;

                document.getElementById('count-historico-fechadas').textContent = fechadas;
                document.getElementById('count-historico-canceladas').textContent = canceladas;
                document.getElementById('count-historico-total').textContent = historicoComandas.length;

                console.log(`‚úÖ ${historicoComandas.length} comandas carregadas`);
                renderizarHistorico();
            } catch (error) {
                console.error('‚ùå Erro ao carregar hist√≥rico:', error);
                mostrarMensagem('Erro', 'Erro ao carregar hist√≥rico: ' + error.message, 'erro');
            }
        }

        function filtrarHistoricoCliente() {
            const buscaCliente = document.getElementById('filtro-cliente-historico').value.toLowerCase().trim();

            if (!buscaCliente) {
                historicoFiltrado = historicoComandas;
            } else {
                historicoFiltrado = historicoComandas.filter(c => {
                    const nomeCliente = (c.cliente?.nome || c.cliente_nome || '').toLowerCase();
                    return nomeCliente.includes(buscaCliente);
                });
            }

            console.log(`üîç ${historicoFiltrado.length} comandas ap√≥s filtro de cliente`);
            renderizarHistorico();
        }

        function renderizarHistorico() {
            const container = document.getElementById('historico-container');

            if (historicoFiltrado.length === 0) {
                container.innerHTML = '<div class="col-span-4 text-center text-gray-500 py-12">Nenhuma comanda encontrada</div>';
                return;
            }

            container.innerHTML = historicoFiltrado.map(comanda => {
                const qtdItens = comanda.itens?.[0]?.count || 0;
                const valorTotal = comanda.valor_total || 0;
                const clienteNome = comanda.cliente?.nome || comanda.cliente_nome || 'Sem cliente';
                const isCancelada = comanda.status === 'cancelada';
                const statusClass = isCancelada ? 'bg-red-500' : 'bg-green-500';
                const statusText = isCancelada ? 'CANCELADA' : 'FECHADA';

                // Mostrar n√∫mero da mesa se dispon√≠vel
                let displayInfo = '';
                if (comanda.numero_mesa) {
                    displayInfo = `Mesa ${comanda.numero_mesa}`;
                } else {
                    const tipoIcon = {
                        'mesa': 'fa-utensils',
                        'balcao': 'fa-store',
                        'delivery': 'fa-motorcycle'
                    };
                    displayInfo = `<i class="fas ${tipoIcon[comanda.tipo] || 'fa-receipt'} mr-1"></i>${comanda.tipo}`;
                }

                return `
                    <div class="comanda-card ${isCancelada ? 'opacity-50' : ''}" style="border-color: ${isCancelada ? '#ef4444' : '#f97316'}; background: ${isCancelada ? '#fef2f2' : '#fef3c7'}; display: flex; flex-direction: column;">
                        <span class="absolute top-3 right-3 ${statusClass} text-white text-xs px-2 py-1 rounded font-bold">
                            ${statusText}
                        </span>
                        <div class="text-2xl font-bold mb-1">
                            ${displayInfo}
                        </div>
                        <div class="text-sm text-gray-500 mb-2">
                            <i class="fas fa-hashtag mr-1"></i>${comanda.numero_comanda}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-user mr-2"></i>${clienteNome}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-clock mr-2"></i>${formatarDataHora(comanda.data_fechamento)}
                        </div>
                        <div class="text-sm text-gray-600 mb-3">
                            <i class="fas fa-box mr-2"></i>${qtdItens} ${qtdItens === 1 ? 'item' : 'itens'}
                        </div>
                        <div class="text-xl font-bold mb-3 ${isCancelada ? 'text-red-600' : 'text-green-600'}">
                            R$ ${valorTotal.toLocaleString("pt-BR", {minimumFractionDigits: 2})}
                        </div>
                        ${!isCancelada ? `
                            <button onclick="reabrirComanda('${comanda.id}')" class="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition font-medium text-sm">
                                <i class="fas fa-redo mr-1"></i> Reabrir
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join("");
        }

        async function reabrirComanda(comandaIdOriginal) {
            let novaComandaId = null; // Para rollback em caso de erro
            
            try {
                mostrarMensagem('Processando', 'Reabrindo comanda...', 'info');
                console.log(`üîÑ Iniciando reabertura de comanda: ${comandaIdOriginal}`);
                
                // ‚úÖ PASSO 1: Buscar comanda original com seus itens E VENDA_ID
                console.log('üìã Step 1: Buscando comanda original...');
                const { data: comandaOriginal, error: erroComanda } = await supabase
                    .from('comandas')
                    .select(`
                        id,
                        numero_comanda,
                        tipo,
                        numero_mesa,
                        cliente_id,
                        cliente_nome,
                        status,
                        data_abertura,
                        data_fechamento,
                        subtotal,
                        desconto,
                        acrescimo,
                        valor_total,
                        venda_id,
                        comanda_itens(
                            id,
                            produto_id,
                            nome_produto,
                            quantidade,
                            preco_unitario,
                            subtotal,
                            desconto,
                            status,
                            observacoes,
                            usuario_id
                        )
                    `)
                    .eq('id', comandaIdOriginal)
                    .single();
                
                if (erroComanda || !comandaOriginal) {
                    throw new Error(`Comanda n√£o encontrada: ${erroComanda?.message || 'ID inv√°lido'}`);
                }
                
                const itensOriginais = comandaOriginal.comanda_itens || [];
                console.log(`‚úÖ Comanda encontrada com ${itensOriginais.length} itens`);
                console.log(`üìä Status da comanda: ${comandaOriginal.status}, Venda ID: ${comandaOriginal.venda_id || 'N/A'}`);
                
                // ‚úÖ PASSO 1.5: Se comanda foi FECHADA (tem venda_id), estornar estoque e cancelar venda
                if (comandaOriginal.status === 'fechada' && comandaOriginal.venda_id) {
                    console.log('üîÑ Step 1.5: Comanda foi fechada - iniciando estorno de estoque...');
                    
                    try {
                        // Reverter movimenta√ß√£o de estoque da venda
                        const resultadoEstorno = await EstoqueService.reverterSaidaVenda(comandaOriginal.venda_id);
                        console.log('‚úÖ Estoque estornado:', resultadoEstorno);
                        
                        // Cancelar a venda original
                        const { error: erroCancelarVenda } = await supabase
                            .from('vendas')
                            .update({
                                status: 'CANCELADA',
                                observacoes: `CANCELADA por reabertura de comanda ${comandaOriginal.numero_comanda}`
                            })
                            .eq('id', comandaOriginal.venda_id);
                        
                        if (erroCancelarVenda) {
                            console.error('‚ùå Erro ao cancelar venda:', erroCancelarVenda);
                            throw new Error(`Erro ao cancelar venda: ${erroCancelarVenda.message}`);
                        }
                        
                        console.log('‚úÖ Venda cancelada e estoque devolvido com sucesso');
                    } catch (erroEstorno) {
                        console.error('‚ùå Erro ao estornar estoque/venda:', erroEstorno);
                        throw new Error(`Erro ao estornar estoque: ${erroEstorno.message}\n\n‚ö†Ô∏è Opera√ß√£o abortada para evitar inconsist√™ncias.`);
                    }
                } else if (comandaOriginal.status === 'cancelada') {
                    console.log('‚ÑπÔ∏è Comanda foi cancelada (nunca teve venda) - n√£o h√° estoque para estornar');
                } else {
                    console.log(`‚ÑπÔ∏è Status: ${comandaOriginal.status} - prosseguindo sem estorno`);
                }
                
                // ‚úÖ PASSO 2: Validar estoque para TODOS os itens ANTES de qualquer a√ß√£o
                console.log('üîç Step 2: Validando estoque para todos os itens...');
                for (let item of itensOriginais) {
                    const estoqueDisponivel = await ServicoComandasService.calcularEstoqueDisponivel(item.produto_id);
                    console.log(`  - ${item.nome_produto}: solicitado ${item.quantidade}, dispon√≠vel ${estoqueDisponivel}`);
                    
                    if (item.quantidade > estoqueDisponivel) {
                        throw new Error(
                            `‚ùå Estoque insuficiente para ${item.nome_produto}\n` +
                            `Solicitado: ${item.quantidade}\n` +
                            `Dispon√≠vel: ${estoqueDisponivel}\n\n` +
                            `‚ö†Ô∏è Nenhuma a√ß√£o foi realizada no estoque`
                        );
                    }
                }
                console.log(`‚úÖ Estoque validado com sucesso para todos os itens`);
                
                // ‚úÖ PASSO 3: Criar nova comanda (APENAS AP√ìS VALIDA√á√ïES)
                console.log('üìù Step 3: Criando nova comanda...');
                const { data: { user } } = await supabase.auth.getUser();
                
                // üî¢ Gerar novo n√∫mero de comanda √∫nico (n√£o usar REAB- que causa duplica√ß√£o)
                const numeroComandaNovoReabertura = await ServicoComandasService.gerarNumeroComanda();
                console.log(`üî¢ Novo n√∫mero gerado: ${numeroComandaNovoReabertura}`);
                
                const { data: novaComanda, error: erroInsert } = await supabase
                    .from('comandas')
                    .insert({
                        numero_comanda: numeroComandaNovoReabertura,
                        numero_mesa: comandaOriginal.numero_mesa,
                        tipo: comandaOriginal.tipo,
                        cliente_id: comandaOriginal.cliente_id,
                        cliente_nome: comandaOriginal.cliente_nome,
                        status: 'aberta',
                        data_abertura: new Date().toISOString(),
                        subtotal: 0,
                        desconto: 0,
                        acrescimo: 0,
                        valor_total: 0
                    })
                    .select('*')
                    .single();
                
                if (erroInsert || !novaComanda) {
                    throw new Error(`Falha ao criar comanda: ${erroInsert?.message || 'Resposta inv√°lida do servidor'}`);
                }
                
                novaComandaId = novaComanda.id; // Guardar para rollback
                console.log(`‚úÖ Nova comanda criada: ${novaComanda.numero_comanda} (ID: ${novaComanda.id})`);
                
                // ‚úÖ PASSO 4: Adicionar itens √† nova comanda
                console.log('üì¶ Step 4: Adicionando itens √† nova comanda...');
                const itensParaInserir = itensOriginais.map(item => ({
                    comanda_id: novaComanda.id,
                    produto_id: item.produto_id,
                    nome_produto: item.nome_produto,
                    quantidade: item.quantidade,
                    preco_unitario: item.preco_unitario,
                    subtotal: item.subtotal,
                    observacoes: item.observacoes || '',
                    usuario_id: user?.id,
                    status: 'pendente'
                }));
                
                const { error: erroItens, data: itensAdicionados } = await supabase
                    .from('comanda_itens')
                    .insert(itensParaInserir)
                    .select('*');
                
                if (erroItens || !itensAdicionados) {
                    // ‚ùå ROLLBACK: Deletar a comanda criada se items falharem
                    console.error(`‚ùå Erro ao adicionar itens: ${erroItens?.message}`);
                    console.log(`üîÑ Fazendo rollback - deletando comanda ${novaComanda.id}...`);
                    
                    await supabase
                        .from('comandas')
                        .delete()
                        .eq('id', novaComanda.id);
                    
                    throw new Error(`Falha ao adicionar itens: ${erroItens?.message}`);
                }
                
                console.log(`‚úÖ ${itensAdicionados.length} itens adicionados com sucesso`);
                
                // ‚úÖ PASSO 5: Atualizar totais da comanda
                console.log('üí∞ Step 5: Atualizando totais...');
                const subtotal = itensOriginais.reduce((sum, item) => sum + item.subtotal, 0);
                
                const { error: erroUpdate } = await supabase
                    .from('comandas')
                    .update({
                        subtotal: subtotal,
                        valor_total: subtotal
                    })
                    .eq('id', novaComanda.id);
                
                if (erroUpdate) {
                    // ‚ùå ROLLBACK: Deletar comanda e itens se update falhar
                    console.error(`‚ùå Erro ao atualizar totais: ${erroUpdate?.message}`);
                    console.log(`üîÑ Fazendo rollback...`);
                    
                    await supabase
                        .from('comanda_itens')
                        .delete()
                        .eq('comanda_id', novaComanda.id);
                    
                    await supabase
                        .from('comandas')
                        .delete()
                        .eq('id', novaComanda.id);
                    
                    throw new Error(`Falha ao atualizar totais: ${erroUpdate?.message}`);
                }
                
                console.log(`‚úÖ Totais atualizados: R$ ${subtotal.toFixed(2)}`);
                
                // ‚úÖ PASSO 6: Deletar comanda original fechada/cancelada (limpeza do BD)
                console.log(`üóëÔ∏è Step 6: Deletando comanda original para evitar duplica√ß√£o...`);
                const { error: erroDeletarOriginal } = await supabase
                    .from('comandas')
                    .delete()
                    .eq('id', comandaIdOriginal);
                
                if (erroDeletarOriginal) {
                    console.warn(`‚ö†Ô∏è Aviso: N√£o conseguiu deletar comanda original: ${erroDeletarOriginal?.message}`);
                    console.warn(`‚ö†Ô∏è A comanda original pode aparecer em duplicado (${comandaOriginal.numero_comanda})`);
                    // N√£o fazer rollback aqui pois a nova comanda j√° foi criada com sucesso
                } else {
                    console.log(`‚úÖ Comanda original (${comandaOriginal.numero_comanda}) deletada do BD`);
                }
                
                // ‚úÖ SUCESSO: Recarregar dados e abrir comanda
                console.log(`üéâ Comanda reaberfa com sucesso! ${novaComanda.numero_comanda}`);
                registrarEvento('ACAO_USUARIO', `COMANDA REABERIDA: ${comandaOriginal.numero_comanda} ‚Üí ${novaComanda.numero_comanda}`, 
                    { comandaAntigaId: comandaIdOriginal, comandaNovId: novaComanda.id });
                mostrarMensagem('Sucesso', `Comanda reaberfa como ${novaComanda.numero_comanda}!`, 'sucesso');
                
                // Reload obrigat√≥rio para limpar hist√≥rico
                console.log(`üîÑ Recarregando comandas...`);
                await carregarComandas();
                await carregarHistoricoComandas(); // Recarregar hist√≥rico tamb√©m
                
                // Aguardar um pouco e depois abrir a comanda
                setTimeout(() => {
                    console.log(`üìÇ Abrindo nova comanda: ${novaComanda.id}`);
                    abrirDetalhesComanda(novaComanda.id);
                }, 500);
                
            } catch (erro) {
                console.error('‚ùå Erro ao reabrir comanda:', erro);
                console.error('üìã Detalhes do erro:', {
                    message: erro.message,
                    stack: erro.stack,
                    novaComandaId
                });
                
                // Garantir que mensagem de erro fica clara
                const mensagem = erro.message.includes('Estoque insuficiente') 
                    ? erro.message  // J√° tem contexto de estoque
                    : `Erro ao reabrir comanda: ${erro.message}\n\n‚ö†Ô∏è Nenhuma a√ß√£o foi realizada.`;
                
                mostrarMensagem('Erro', mensagem, 'erro');
            }
        }

        function exibirCupomComanda(cupom) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg max-w-2xl w-full">
                    <div class="text-center mb-8">
                        <i class="fas fa-check-circle text-green-500 text-8xl mb-4"></i>
                        <h3 class="text-4xl font-bold text-gray-800 mb-3">Comanda Finalizada!</h3>
                        <p class="text-gray-600 text-lg">Transacao finalizada com sucesso</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-lg mb-6 text-center border-2 border-blue-200">
                        <p class="text-sm text-gray-700 mb-2 font-medium uppercase">Numero da Comanda</p>
                        <p class="text-4xl font-bold text-blue-700">${cupom.numero}</p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg mb-6 space-y-3">
                        <div class="flex justify-between text-lg">
                            <span class="text-gray-600">Total:</span>
                            <span class="font-bold">R$ ${cupom.total.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-lg">
                            <span class="text-gray-600">Pago:</span>
                            <span class="font-bold">R$ ${cupom.valorPago.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-lg border-t pt-3">
                            <span class="text-gray-600 font-medium">Troco:</span>
                            <span class="font-bold text-blue-600">R$ ${cupom.troco.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm mt-2">
                            <span class="text-gray-500">Forma de Pagamento:</span>
                            <span class="font-medium">${cupom.forma.replace('_', ' ')}</span>
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove(); carregarComandas();" class="w-full px-6 py-5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-xl transition-colors shadow-lg">
                        <i class="fas fa-arrow-right mr-2"></i>Proxima Comanda
                    </button>
                    
                    <p class="text-sm text-gray-500 text-center mt-6">
                        <i class="fas fa-info-circle mr-1"></i>
                        Comanda finalizada com sucesso
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-fechar ao clicar no overlay
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    carregarComandas();
                }
            });
        }

        async function cancelarComanda() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const container = document.createElement('div');
            container.className = 'bg-white p-6 rounded-lg max-w-md w-full mx-4';
            
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Cancelar Comanda
                </h3>
                <p class="text-gray-700 mb-4">
                    Tem certeza que deseja cancelar a comanda <strong>${comandaAtual.numero_comanda}</strong>?
                </p>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Motivo do Cancelamento *</label>
                    <textarea id="motivo-cancelamento" rows="3" class="w-full border rounded px-3 py-2" placeholder="Digite o motivo..." required></textarea>
                </div>
                <div class="flex gap-2">
                    <button id="btn-cancelar-acao" class="flex-1 px-4 py-2 border rounded hover:bg-gray-100">Voltar</button>
                    <button id="btn-confirmar-cancelamento" class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Confirmar Cancelamento</button>
                </div>
            `;
            
            overlay.appendChild(container);
            document.body.appendChild(overlay);
            
            const btnCancelar = container.querySelector('#btn-cancelar-acao');
            const btnConfirmar = container.querySelector('#btn-confirmar-cancelamento');
            const motivoInput = container.querySelector('#motivo-cancelamento');
            
            btnCancelar.addEventListener('click', () => {
                overlay.remove();
            });
            
            btnConfirmar.addEventListener('click', async () => {
                const motivo = motivoInput.value.trim();
                
                if (!motivo) {
                    mostrarMensagem('Aten√ß√£o', 'Por favor, informe o motivo do cancelamento', 'aviso');
                    motivoInput.focus();
                    return;
                }
                
                btnConfirmar.disabled = true;
                btnCancelar.disabled = true;
                btnConfirmar.innerHTML = '<i class=\"fas fa-spinner fa-spin mr-2\"></i>Cancelando...';
                
                try {
                    await ServicoComandasService.cancelarComanda(comandaAtual.id, motivo);
                    overlay.remove();
                    fecharModalDetalhes();
                    await carregarComandas();
                    
                    // Modal de sucesso
                    const sucessoModal = document.createElement('div');
                    sucessoModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    sucessoModal.innerHTML = `
                        <div class="bg-white p-8 rounded-lg max-w-md text-center">
                            <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                            <h3 class="text-2xl font-bold mb-2">Comanda Cancelada</h3>
                            <p class="text-gray-600 mb-6">A comanda foi cancelada com sucesso</p>
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                                OK
                            </button>
                        </div>
                    `;
                    document.body.appendChild(sucessoModal);
                    
                    setTimeout(() => sucessoModal.remove(), 3000);
                } catch (erro) {
                    console.error("Erro ao cancelar:", erro);
                    mostrarMensagem('Erro', erro.message, 'erro');
                    
                    btnConfirmar.disabled = false;
                    btnCancelar.disabled = false;
                    btnConfirmar.innerHTML = 'Confirmar Cancelamento';
                }
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            container.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            motivoInput.focus();
        }

        function abrirModalNovaComanda() {
            document.getElementById("form-nova-comanda").reset();
            document.getElementById("modalNovaComanda").classList.remove("hidden");
        }

        function fecharModalNovaComanda() {
            document.getElementById("modalNovaComanda").classList.add("hidden");
        }

        async function fecharModalDetalhes() {
            document.getElementById("modalDetalhesComanda").classList.add("hidden");
            // Atualizar grid de comandas ao fechar
            await carregarComandas();
        }

        // Fun√ß√£o helper para mostrar mensagens em modal
        function mostrarMensagem(titulo, mensagem, tipo = 'info') {
            const cores = {
                'sucesso': { bg: 'bg-green-500', icon: 'fa-check-circle', texto: 'text-green-700' },
                'erro': { bg: 'bg-red-500', icon: 'fa-exclamation-circle', texto: 'text-red-700' },
                'aviso': { bg: 'bg-yellow-500', icon: 'fa-exclamation-triangle', texto: 'text-yellow-700' },
                'info': { bg: 'bg-blue-500', icon: 'fa-info-circle', texto: 'text-blue-700' }
            };
            const cor = cores[tipo] || cores['info'];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg max-w-md text-center shadow-2xl">
                    <i class="fas ${cor.icon} ${cor.bg.replace('bg-', 'text-')} text-6xl mb-4"></i>
                    <h3 class="text-2xl font-bold ${cor.texto} mb-2">${titulo}</h3>
                    <p class="text-gray-600 mb-6 whitespace-pre-line">${mensagem}</p>
                    <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 ${cor.bg} text-white rounded-lg hover:opacity-90 font-bold">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 5000);
        }

        function atualizarCamposMesa() {
            const tipo = document.getElementById("comanda-tipo").value;
            document.getElementById("campo-numero-mesa").style.display = tipo === "mesa" ? "block" : "none";
        }

        async function salvarNovaComanda() {
            const tipo = document.getElementById("comanda-tipo").value;
            const numeroMesa = document.getElementById("comanda-numero-mesa").value.trim();
            const clienteId = document.getElementById("comanda-cliente").value || null;
            const clienteNome = document.getElementById("comanda-cliente-nome").value.trim() || null;

            // SEMPRE gerar n√∫mero de comanda automaticamente
            const numeroComanda = await ServicoComandasService.gerarNumeroComanda();

            try {
                await ServicoComandasService.abrirComanda({
                    numero_comanda: numeroComanda,
                    tipo,
                    numero_mesa: numeroMesa || null,
                    cliente_id: clienteId,
                    cliente_nome: clienteNome
                });

                fecharModalNovaComanda();
                await carregarComandas();
                mostrarMensagem('Sucesso', `Comanda ${numeroComanda} aberta com sucesso!`, 'sucesso');
            } catch (erro) {
                console.error("Erro ao abrir comanda:", erro);
                mostrarMensagem('Erro', erro.message, 'erro');
            }
        }

        async function carregarClientesSelect() {
            const { data: clientes } = await supabase
                .from("clientes")
                .select("id, nome")
                .order("nome");

            const select = document.getElementById("comanda-cliente");
            select.innerHTML += clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join("");
        }

        // Buscar produto por codigo de barras ou SKU
        async function buscarProdutoPorCodigo(codigo) {
            try {
                const { data, error } = await supabase
                    .from("produtos")
                    .select("*")
                    .or(`codigo_barras.eq.${codigo},sku.eq.${codigo}`)
                    .eq("ativo", true)
                    .single();

                if (error && error.code !== "PGRST116") throw error;
                return data || null;
            } catch (error) {
                console.error("Erro ao buscar produto:", error);
                return null;
            }
        }

        // Buscar produtos por nome (autocomplete)
        async function buscarProdutosPorNome(nome) {
            try {
                if (!nome || nome.length < 2) return [];
                
                const { data, error } = await supabase
                    .from("produtos")
                    .select("id, codigo, nome, preco_venda, estoque_atual")
                    .ilike("nome", `%${nome}%`)
                    .eq("ativo", true)
                    .limit(10);

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error("Erro ao buscar produtos por nome:", error);
                return [];
            }
        }

        // Setup do campo de busca com autocomplete
        function setupBuscaProduto() {
            const inputBusca = document.getElementById("busca-produto-comanda");
            const dropdownSugestoes = document.getElementById("dropdown-sugestoes-comanda");

            if (!inputBusca) return;

            // Input para sugestoes
            inputBusca.addEventListener("input", async (e) => {
                const valor = e.target.value.trim();
                
                if (valor.length >= 2) {
                    const produtos = await buscarProdutosPorNome(valor);
                    
                    if (produtos.length > 0) {
                        dropdownSugestoes.innerHTML = produtos.map(p => `
                            <div class="p-3 border-b hover:bg-blue-50 cursor-pointer transition produto-sugestao" data-produto-id="${p.id}">
                                <div class="font-semibold text-gray-800">${p.nome}</div>
                                <div class="text-xs text-gray-500">Codigo: ${p.codigo || "N/A"} | R$ ${(p.preco_venda || 0).toFixed(2)} | Estoque: ${p.estoque_atual || 0}</div>
                            </div>
                        `).join("");
                        
                        // Adicionar listeners aos itens do dropdown
                        dropdownSugestoes.querySelectorAll(".produto-sugestao").forEach(item => {
                            item.addEventListener("click", async () => {
                                const produtoId = item.getAttribute("data-produto-id");
                                await selecionarProdutoAutoComplete(produtoId);
                            });
                        });
                        
                        dropdownSugestoes.classList.remove("hidden");
                    } else {
                        dropdownSugestoes.classList.add("hidden");
                    }
                } else {
                    dropdownSugestoes.classList.add("hidden");
                }
            });

            // Enter para buscar por codigo (com prote√ß√£o contra m√∫ltiplos eventos)
            let processandoBarras = false;
            inputBusca.addEventListener("keypress", async (e) => {
                if (e.key === "Enter") {
                    // ‚õî EVITAR M√öLTIPLAS CHAMADAS SIMULT√ÇNEAS DO LEITOR
                    if (processandoBarras) {
                        console.warn('‚ö†Ô∏è J√° est√° processando c√≥digo de barras, aguarde...');
                        return;
                    }

                    try {
                        processandoBarras = true;
                        dropdownSugestoes.classList.add("hidden");
                        const codigo = e.target.value.trim();
                        
                        if (codigo.length === 0) {
                            processandoBarras = false;
                            return;
                        }

                        const produto = await buscarProdutoPorCodigo(codigo);
                        if (produto) {
                            await adicionarProdutoPorId(produto.id);
                            e.target.value = "";
                        } else {
                            mostrarMensagem('Aviso', 'Produto n√£o encontrado', 'aviso');
                            e.target.value = "";
                        }
                    } finally {
                        processandoBarras = false;
                    }
                }
            });

            // Fechar dropdown ao clicar fora
            document.addEventListener("click", (e) => {
                if (e.target !== inputBusca && !dropdownSugestoes.contains(e.target)) {
                    dropdownSugestoes.classList.add("hidden");
                }
            });
        }

        // Selecionar produto do autocomplete
        async function selecionarProdutoAutoComplete(produtoId) {
            try {
                await adicionarProdutoPorId(produtoId);
                document.getElementById("busca-produto-comanda").value = "";
                document.getElementById("dropdown-sugestoes-comanda").classList.add("hidden");
            } catch (error) {
                console.error("Erro ao adicionar produto:", error);
                mostrarMensagem('Erro', error.message || 'Erro ao adicionar produto', 'erro');
            }
        }

        function formatarHora(data) {
            const d = new Date(data);
            // Subtrair 3 horas (Bras√≠lia √© UTC-3)
            const horarioBrasil = new Date(d.getTime() - (3 * 60 * 60 * 1000));
            return horarioBrasil.toLocaleTimeString("pt-BR", { 
                hour: "2-digit", 
                minute: "2-digit",
                hour12: false
            });
        }

        function formatarDataHora(data) {
            const d = new Date(data);
            // Subtrair 3 horas (Bras√≠lia √© UTC-3)
            const horarioBrasil = new Date(d.getTime() - (3 * 60 * 60 * 1000));
            return horarioBrasil.toLocaleString("pt-BR", {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
    </script>
</body>
</html>
