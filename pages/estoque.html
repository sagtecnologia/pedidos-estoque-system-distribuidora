<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Estoque - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Gerenciamento de Estoque</h2>
                <p class="text-gray-600 mt-2">Controle completo de estoque por produto e sabor</p>
            </div>

            <!-- Cards de Totais -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Valor Total Compra</p>
                            <p id="card-total-compra" class="text-2xl font-bold text-blue-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">Investimento em estoque</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Valor Total Venda</p>
                            <p id="card-total-venda" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">Valor potencial de venda</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Margem de Lucro</p>
                            <p id="card-margem-lucro" class="text-2xl font-bold text-purple-600">R$ 0,00</p>
                            <p id="card-margem-percentual" class="text-xs text-gray-500 mt-1">0%</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros Globais -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marca</label>
                        <select id="filter-marca" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="carregarProdutosFiltro()">
                            <option value="">Todas as marcas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Produto</label>
                        <select id="filter-produto" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="carregarSaboresFiltro()" disabled>
                            <option value="">Todos os produtos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sabor</label>
                        <select id="filter-sabor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()" disabled>
                            <option value="">Todos os sabores</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Situa√ß√£o</label>
                        <select id="filter-situacao" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="OK">OK</option>
                            <option value="BAIXO">Estoque Baixo</option>
                            <option value="ZERADO">Zerado</option>
                            <option value="BAIXO,OK">Baixo e OK</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="aplicarFiltros()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        üîç Filtrar
                    </button>
                    <button onclick="limparFiltros()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        üîÑ Limpar
                    </button>
                    <button onclick="exportarExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        üìä Exportar Excel
                    </button>
                    <button onclick="exportarPDF()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                        üìÑ Exportar PDF
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button onclick="switchTab('estoque-produto')" id="tab-estoque-produto" class="tab-button active py-4 px-6 font-medium text-sm border-b-2 border-blue-600 text-blue-600">
                            üì¶ Estoque por Produto
                        </button>
                        <button onclick="switchTab('estoque-sabor')" id="tab-estoque-sabor" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üçì Estoque por Sabor
                        </button>
                        <button onclick="switchTab('mov-produto')" id="tab-mov-produto" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üìä Movimenta√ß√µes Produto
                        </button>
                        <button onclick="switchTab('mov-sabor')" id="tab-mov-sabor" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üìà Movimenta√ß√µes Sabor
                        </button>
                    </nav>
                </div>

                <!-- Tab Content: Estoque por Produto -->
                <div id="content-estoque-produto" class="tab-content p-6">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Estoque Geral por Produto</h3>
                        <button onclick="exportarCSV('produto')" class="text-green-600 hover:text-green-800 text-sm">üì• Exportar CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque M√≠nimo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Situa√ß√£o</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd Sabores</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-estoque-produto" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Estoque por Sabor -->
                <div id="content-estoque-sabor" class="tab-content p-6 hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Estoque Detalhado por Sabor</h3>
                        <button onclick="exportarCSV('sabor')" class="text-green-600 hover:text-green-800 text-sm">üì• Exportar CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sabor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Situa√ß√£o</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo Compra</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo Venda</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-estoque-sabor" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Movimenta√ß√µes Produto -->
                <div id="content-mov-produto" class="tab-content p-6 hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Movimenta√ß√µes por Produto</h3>
                        <button onclick="exportarCSV('mov-produto')" class="text-green-600 hover:text-green-800 text-sm">üì• Exportar CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Est. Anterior</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Est. Novo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usu√°rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Observa√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-mov-produto" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Movimenta√ß√µes Sabor -->
                <div id="content-mov-sabor" class="tab-content p-6 hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Movimenta√ß√µes por Sabor</h3>
                        <button onclick="exportarCSV('mov-sabor')" class="text-green-600 hover:text-green-800 text-sm">üì• Exportar CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sabor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usu√°rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Observa√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-mov-sabor" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-700">Carregando...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/services/produtos.js"></script>
    <script src="../js/services/estoque.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    
    <script>
        let todosProdutos = [];
        let todosSabores = [];
        let todasMovimentacoes = [];
        let filtroAtual = {
            marca: '',
            produto: '',
            sabor: '',
            situacao: ''
        };

        (async () => {
            await checkAuth();
            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();
            
            await carregarMarcasFiltro();
            await carregarDados();
        })();

        async function carregarMarcasFiltro() {
            const marcas = await getMarcas();
            const select = document.getElementById('filter-marca');
            select.innerHTML = '<option value="">Todas as marcas</option>';
            marcas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca;
                option.textContent = marca;
                select.appendChild(option);
            });
        }

        async function carregarProdutosFiltro() {
            const marca = document.getElementById('filter-marca').value;
            const selectProduto = document.getElementById('filter-produto');
            const selectSabor = document.getElementById('filter-sabor');
            
            // Resetar selects
            selectProduto.innerHTML = '<option value="">Todos os produtos</option>';
            selectSabor.innerHTML = '<option value="">Todos os sabores</option>';
            selectSabor.disabled = true;
            
            if (!marca) {
                selectProduto.disabled = true;
                aplicarFiltros();
                return;
            }
            
            const produtos = todosProdutos.filter(p => p.marca === marca);
            produtos.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nome;
                selectProduto.appendChild(option);
            });
            
            selectProduto.disabled = false;
            aplicarFiltros();
        }

        async function carregarSaboresFiltro() {
            const produtoId = document.getElementById('filter-produto').value;
            const selectSabor = document.getElementById('filter-sabor');
            
            selectSabor.innerHTML = '<option value="">Todos os sabores</option>';
            
            if (!produtoId) {
                selectSabor.disabled = true;
                aplicarFiltros();
                return;
            }
            
            // Buscar sabores diretamente da view para ter consist√™ncia
            const { data: sabores, error } = await supabase
                .from('vw_estoque_sabores')
                .select('sabor_id, sabor')
                .eq('produto_id', produtoId)
                .order('sabor');
            
            if (error) {
                console.error('Erro ao buscar sabores:', error);
                return;
            }
            
            sabores.forEach(s => {
                const option = document.createElement('option');
                option.value = s.sabor_id;
                option.textContent = s.sabor;
                selectSabor.appendChild(option);
            });
            
            selectSabor.disabled = false;
            aplicarFiltros();
        }

        function limparFiltros() {
            document.getElementById('filter-marca').value = '';
            document.getElementById('filter-produto').value = '';
            document.getElementById('filter-produto').disabled = true;
            document.getElementById('filter-sabor').value = '';
            document.getElementById('filter-sabor').disabled = true;
            document.getElementById('filter-situacao').value = '';
            
            filtroAtual = { marca: '', produto: '', sabor: '', situacao: '' };
            aplicarFiltros();
        }

        function aplicarFiltros() {
            filtroAtual.marca = document.getElementById('filter-marca').value;
            filtroAtual.produto = document.getElementById('filter-produto').value;
            filtroAtual.sabor = document.getElementById('filter-sabor').value;
            filtroAtual.situacao = document.getElementById('filter-situacao').value;
            
            renderizarTabAtiva();
            calcularTotaisEstoque();
        }

        function calcularTotaisEstoque() {
            let totalCompra = 0;
            let totalVenda = 0;
            
            // Calcular com base nos sabores em estoque
            todosSabores.forEach(sabor => {
                const produto = todosProdutos.find(p => p.id === sabor.produto_id);
                if (!produto) return;
                
                // Aplicar filtros
                if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return;
                if (filtroAtual.produto && produto.id !== filtroAtual.produto) return;
                if (filtroAtual.sabor && sabor.sabor_id !== filtroAtual.sabor) return;
                
                const quantidade = sabor.quantidade || 0;
                const precoCompra = produto.preco_compra || 0;
                const precoVenda = produto.preco_venda || 0;
                
                totalCompra += quantidade * precoCompra;
                totalVenda += quantidade * precoVenda;
            });
            
            const margemLucro = totalVenda - totalCompra;
            const margemPercentual = totalCompra > 0 ? (margemLucro / totalCompra * 100) : 0;
            
            document.getElementById('card-total-compra').textContent = formatCurrency(totalCompra);
            document.getElementById('card-total-venda').textContent = formatCurrency(totalVenda);
            document.getElementById('card-margem-lucro').textContent = formatCurrency(margemLucro);
            document.getElementById('card-margem-percentual').textContent = `${margemPercentual.toFixed(1)}% de margem`;
        }

        async function carregarDados() {
            showLoading(true);
            try {
                // Carregar produtos
                todosProdutos = await listProdutos();
                
                // Carregar todos os sabores
                const { data: sabores, error } = await supabase
                    .from('vw_estoque_sabores')
                    .select('*')
                    .order('marca, produto, sabor');
                
                if (error) throw error;
                todosSabores = sabores || [];
                
                // Carregar movimenta√ß√µes
                todasMovimentacoes = await listMovimentacoes({ limit: 500 });
                
                renderizarTabAtiva();
                calcularTotaisEstoque();
            } catch (error) {
                handleError(error, 'Erro ao carregar dados');
            } finally {
                showLoading(false);
            }
        }

        function switchTab(tabName) {
            // Atualizar bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-600', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            
            // Atualizar conte√∫do
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            renderizarTabAtiva();
        }

        function renderizarTabAtiva() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            
            switch(activeTab) {
                case 'estoque-produto':
                    renderEstoqueProduto();
                    break;
                case 'estoque-sabor':
                    renderEstoqueSabor();
                    break;
                case 'mov-produto':
                    renderMovimentacoesProduto();
                    break;
                case 'mov-sabor':
                    renderMovimentacoesSabor();
                    break;
            }
        }

        function renderEstoqueProduto() {
            let produtos = [...todosProdutos];
            
            // Aplicar filtros
            if (filtroAtual.marca) {
                produtos = produtos.filter(p => p.marca === filtroAtual.marca);
            }
            if (filtroAtual.produto) {
                produtos = produtos.filter(p => p.id === filtroAtual.produto);
            }
            if (filtroAtual.situacao) {
                // Suportar m√∫ltiplos status separados por v√≠rgula
                const situacoes = filtroAtual.situacao.split(',');
                produtos = produtos.filter(p => {
                    const situacao = getSituacaoEstoque(p).tipo;
                    return situacoes.includes(situacao);
                });
            }
            
            const tbody = document.getElementById('tbody-estoque-produto');
            
            if (produtos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhum produto encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = produtos.map(p => {
                const situacao = getSituacaoEstoque(p);
                const qtdSabores = todosSabores.filter(s => s.produto_id === p.id).length;
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${p.codigo}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${p.marca || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${p.nome}</td>
                        <td class="px-6 py-4 text-sm"><span class="font-semibold ${situacao.color}">${p.estoque_atual} ${p.unidade}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-600">${p.estoque_minimo} ${p.unidade}</td>
                        <td class="px-6 py-4 text-sm">${situacao.badge}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${qtdSabores} sabor${qtdSabores != 1 ? 'es' : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderEstoqueSabor() {
            let sabores = [...todosSabores];
            
            // Recalcular status para incluir ZERADO
            sabores = sabores.map(s => ({
                ...s,
                status_estoque: s.quantidade === 0 ? 'ZERADO' : 
                               (s.quantidade <= s.estoque_minimo ? 'BAIXO' : 'OK')
            }));
            
            // Aplicar filtros
            if (filtroAtual.marca) {
                sabores = sabores.filter(s => s.marca === filtroAtual.marca);
            }
            if (filtroAtual.produto) {
                sabores = sabores.filter(s => s.produto_id === filtroAtual.produto);
            }
            if (filtroAtual.sabor) {
                sabores = sabores.filter(s => s.sabor_id === filtroAtual.sabor);
            }
            if (filtroAtual.situacao) {
                // Suportar m√∫ltiplos status separados por v√≠rgula
                const situacoes = filtroAtual.situacao.split(',');
                sabores = sabores.filter(s => situacoes.includes(s.status_estoque));
            }
            
            const tbody = document.getElementById('tbody-estoque-sabor');
            
            if (sabores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhum sabor encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = sabores.map(s => {
                let situacao, badge;
                if (s.status_estoque === 'ZERADO') {
                    situacao = 'text-gray-600';
                    badge = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Zerado</span>';
                } else if (s.status_estoque === 'BAIXO') {
                    situacao = 'text-red-600';
                    badge = '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Baixo</span>';
                } else {
                    situacao = 'text-green-600';
                    badge = '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">OK</span>';
                }
                const margem = s.preco_venda && s.preco_compra 
                    ? ((s.preco_venda - s.preco_compra) / s.preco_compra * 100).toFixed(1) + '%'
                    : '-';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-700">${s.marca || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${s.produto_nome || s.produto || '-'}</td>
                        <td class="px-6 py-4 text-sm font-medium text-blue-600">${s.sabor}</td>
                        <td class="px-6 py-4 text-sm"><span class="font-semibold ${situacao}">${s.quantidade}</span></td>
                        <td class="px-6 py-4 text-sm">${badge}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${formatCurrency(s.preco_compra || 0)}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatCurrency(s.preco_venda || 0)}</td>
                        <td class="px-6 py-4 text-sm text-green-600">${margem}</td>
                    </tr>
                `;
            }).join('');
        }

        async function renderMovimentacoesProduto() {
            let movimentacoes = [...todasMovimentacoes];
            
            // Aplicar filtros
            if (filtroAtual.marca) {
                const produtosIds = todosProdutos.filter(p => p.marca === filtroAtual.marca).map(p => p.id);
                movimentacoes = movimentacoes.filter(m => produtosIds.includes(m.produto_id));
            }
            if (filtroAtual.produto) {
                movimentacoes = movimentacoes.filter(m => m.produto_id === filtroAtual.produto);
            }
            
            const tbody = document.getElementById('tbody-mov-produto');
            
            if (movimentacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhuma movimenta√ß√£o encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = movimentacoes.map(m => {
                const tipoBadge = m.tipo === 'ENTRADA'
                    ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Entrada</span>'
                    : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Sa√≠da</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-600">${formatDateTime(m.created_at)}</td>
                        <td class="px-6 py-4 text-sm">${tipoBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${m.produto?.nome || '-'}</td>
                        <td class="px-6 py-4 text-sm font-medium">${m.quantidade}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${m.estoque_anterior}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${m.estoque_novo}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${m.usuario?.full_name || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${m.observacao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function renderMovimentacoesSabor() {
            let movimentacoes = todasMovimentacoes.filter(m => m.sabor_id !== null);
            
            // Aplicar filtros
            if (filtroAtual.marca) {
                const produtosIds = todosProdutos.filter(p => p.marca === filtroAtual.marca).map(p => p.id);
                movimentacoes = movimentacoes.filter(m => produtosIds.includes(m.produto_id));
            }
            if (filtroAtual.produto) {
                movimentacoes = movimentacoes.filter(m => m.produto_id === filtroAtual.produto);
            }
            if (filtroAtual.sabor) {
                movimentacoes = movimentacoes.filter(m => m.sabor_id === filtroAtual.sabor);
            }
            
            const tbody = document.getElementById('tbody-mov-sabor');
            
            if (movimentacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhuma movimenta√ß√£o de sabor encontrada</td></tr>';
                return;
            }
            
            // Buscar informa√ß√µes dos sabores
            const movimentacoesComSabor = await Promise.all(movimentacoes.map(async m => {
                if (m.sabor_id) {
                    const { data: sabor } = await supabase
                        .from('produto_sabores')
                        .select('sabor')
                        .eq('id', m.sabor_id)
                        .single();
                    m.sabor_nome = sabor?.sabor || '-';
                }
                return m;
            }));
            
            tbody.innerHTML = movimentacoesComSabor.map(m => {
                const tipoBadge = m.tipo === 'ENTRADA'
                    ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Entrada</span>'
                    : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Sa√≠da</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-600">${formatDateTime(m.created_at)}</td>
                        <td class="px-6 py-4 text-sm">${tipoBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${m.produto?.nome || '-'}</td>
                        <td class="px-6 py-4 text-sm font-medium text-blue-600">${m.sabor_nome}</td>
                        <td class="px-6 py-4 text-sm font-medium">${m.quantidade}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${m.usuario?.full_name || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${m.observacao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getSituacaoEstoque(produto) {
            if (produto.estoque_atual === 0) {
                return {
                    tipo: 'ZERADO',
                    badge: '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Zerado</span>',
                    color: 'text-red-600'
                };
            } else if (produto.estoque_atual <= produto.estoque_minimo) {
                return {
                    tipo: 'BAIXO',
                    badge: '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Baixo</span>',
                    color: 'text-yellow-600'
                };
            } else {
                return {
                    tipo: 'OK',
                    badge: '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">OK</span>',
                    color: 'text-green-600'
                };
            }
        }

        function exportarCSV(tipo) {
            // TODO: Implementar exporta√ß√£o CSV
            showToast('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info');
        }

        // ========================================
        // FUN√á√ïES DE EXPORTA√á√ÉO
        // ========================================

        function exportarExcel() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            const timestamp = new Date().toLocaleString('pt-BR').replace(/[/:]/g, '-');
            let dados = [];
            let nomeArquivo = '';

            switch(activeTab) {
                case 'estoque-produto':
                    dados = obterDadosEstoqueProduto();
                    nomeArquivo = `Estoque_Produto_${timestamp}.xlsx`;
                    break;
                case 'estoque-sabor':
                    dados = obterDadosEstoqueSabor();
                    nomeArquivo = `Estoque_Sabor_${timestamp}.xlsx`;
                    break;
                case 'mov-produto':
                    dados = obterDadosMovimentacoesProduto();
                    nomeArquivo = `Movimentacoes_Produto_${timestamp}.xlsx`;
                    break;
                case 'mov-sabor':
                    dados = obterDadosMovimentacoesSabor();
                    nomeArquivo = `Movimentacoes_Sabor_${timestamp}.xlsx`;
                    break;
            }

            if (dados.length === 0) {
                showToast('Nenhum dado para exportar', 'warning');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dados');
            XLSX.writeFile(wb, nomeArquivo);
            showToast('Arquivo Excel exportado com sucesso!', 'success');
        }

        function exportarPDF() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            const timestamp = new Date().toLocaleString('pt-BR');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabe√ßalho
            doc.setFontSize(18);
            doc.text('Gerenciamento de Estoque', 14, 15);
            doc.setFontSize(10);
            doc.text(`Gerado em: ${timestamp}`, 14, 22);

            // Filtros aplicados
            let filtros = [];
            if (filtroAtual.marca) filtros.push(`Marca: ${document.getElementById('filter-marca').selectedOptions[0].text}`);
            if (filtroAtual.produto) filtros.push(`Produto: ${document.getElementById('filter-produto').selectedOptions[0].text}`);
            if (filtroAtual.sabor) filtros.push(`Sabor: ${document.getElementById('filter-sabor').selectedOptions[0].text}`);
            if (filtroAtual.situacao) filtros.push(`Situa√ß√£o: ${filtroAtual.situacao}`);
            
            if (filtros.length > 0) {
                doc.setFontSize(9);
                doc.text(`Filtros: ${filtros.join(' | ')}`, 14, 28);
            }

            let startY = filtros.length > 0 ? 35 : 28;

            switch(activeTab) {
                case 'estoque-produto':
                    exportarTabelaPDF(doc, 'Estoque por Produto', obterDadosEstoqueProdutoTabela(), startY);
                    break;
                case 'estoque-sabor':
                    exportarTabelaPDF(doc, 'Estoque por Sabor', obterDadosEstoqueSaborTabela(), startY);
                    break;
                case 'mov-produto':
                    exportarTabelaPDF(doc, 'Movimenta√ß√µes por Produto', obterDadosMovimentacoesProdutoTabela(), startY);
                    break;
                case 'mov-sabor':
                    exportarTabelaPDF(doc, 'Movimenta√ß√µes por Sabor', obterDadosMovimentacoesSaborTabela(), startY);
                    break;
            }

            doc.save(`Estoque_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF exportado com sucesso!', 'success');
        }

        function exportarTabelaPDF(doc, titulo, dados, startY) {
            doc.setFontSize(12);
            doc.text(titulo, 14, startY);

            doc.autoTable({
                startY: startY + 5,
                head: [dados.headers],
                body: dados.rows,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 7 }
            });
        }

        // Fun√ß√µes auxiliares para obter dados
        function obterDadosEstoqueProduto() {
            let produtosFiltrados = todosProdutos.filter(p => {
                if (filtroAtual.marca && p.marca !== filtroAtual.marca) return false;
                if (filtroAtual.produto && p.id !== filtroAtual.produto) return false;
                
                const situacao = getSituacaoEstoque(p);
                if (filtroAtual.situacao && situacao.tipo !== filtroAtual.situacao) return false;
                
                return true;
            });

            return produtosFiltrados.map(p => {
                const sabores = todosSabores.filter(s => s.produto_id === p.id);
                const situacao = getSituacaoEstoque(p);
                
                return {
                    'C√≥digo': p.codigo || '-',
                    'Marca': p.marca || '-',
                    'Produto': p.nome,
                    'Estoque Total': p.estoque_atual,
                    'Estoque M√≠nimo': p.estoque_minimo,
                    'Situa√ß√£o': situacao.tipo,
                    'Qtd Sabores': sabores.length
                };
            });
        }

        function obterDadosEstoqueProdutoTabela() {
            const dados = obterDadosEstoqueProduto();
            return {
                headers: ['C√≥digo', 'Marca', 'Produto', 'Estoque', 'M√≠nimo', 'Situa√ß√£o', 'Sabores'],
                rows: dados.map(d => [d.C√≥digo, d.Marca, d.Produto, d['Estoque Total'], d['Estoque M√≠nimo'], d.Situa√ß√£o, d['Qtd Sabores']])
            };
        }

        function obterDadosEstoqueSabor() {
            // N√£o aplicar filtros aqui, pegar todos os sabores dispon√≠veis
            let saboresFiltrados = todosSabores.filter(s => {
                // Remover filtro de ativo - a view j√° traz apenas sabores ativos
                const produto = todosProdutos.find(p => p.id === s.produto_id);
                if (!produto) return false;
                
                if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return false;
                if (filtroAtual.produto && s.produto_id !== filtroAtual.produto) return false;
                if (filtroAtual.sabor && s.id !== filtroAtual.sabor) return false;
                if (filtroAtual.situacao && s.status_estoque !== filtroAtual.situacao) return false;
                
                return true;
            });

            return saboresFiltrados.map(s => {
                const produto = todosProdutos.find(p => p.id === s.produto_id);
                const margemBruta = s.preco_venda && s.preco_compra
                    ? ((s.preco_venda - s.preco_compra) / s.preco_compra * 100)
                    : 0;
                
                return {
                    'Marca': produto?.marca || s.marca || '-',
                    'Produto': s.produto_nome || s.produto || produto?.nome || '-',
                    'Sabor': s.sabor || '-',
                    'Quantidade': s.quantidade || 0,
                    'Situa√ß√£o': s.status_estoque || '-',
                    'Pre√ßo Compra': s.preco_compra ? `R$ ${s.preco_compra.toFixed(2)}` : '-',
                    'Pre√ßo Venda': s.preco_venda ? `R$ ${s.preco_venda.toFixed(2)}` : '-',
                    'Margem %': margemBruta.toFixed(1) + '%'
                };
            });
        }

        function obterDadosEstoqueSaborTabela() {
            const dados = obterDadosEstoqueSabor();
            return {
                headers: ['Marca', 'Produto', 'Sabor', 'Qtd', 'Situa√ß√£o', 'P. Compra', 'P. Venda', 'Margem'],
                rows: dados.map(d => [d.Marca, d.Produto, d.Sabor, d.Quantidade, d.Situa√ß√£o, d['Pre√ßo Compra'], d['Pre√ßo Venda'], d['Margem %']])
            };
        }

        function obterDadosMovimentacoesProduto() {
            let movsFiltradas = todasMovimentacoes.filter(m => {
                const produto = todosProdutos.find(p => p.id === m.produto_id);
                if (!produto) return false;
                
                if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return false;
                if (filtroAtual.produto && m.produto_id !== filtroAtual.produto) return false;
                
                return true;
            });

            return movsFiltradas.map(m => ({
                'Data': formatDateTime(m.created_at),
                'Tipo': m.tipo,
                'Produto': m.produto?.nome || '-',
                'Quantidade': m.quantidade,
                'Estoque Anterior': m.estoque_anterior,
                'Estoque Novo': m.estoque_novo,
                'Usu√°rio': m.usuario?.full_name || '-',
                'Observa√ß√£o': m.observacao || '-'
            }));
        }

        function obterDadosMovimentacoesProdutoTabela() {
            const dados = obterDadosMovimentacoesProduto();
            return {
                headers: ['Data', 'Tipo', 'Produto', 'Qtd', 'Est. Ant.', 'Est. Novo', 'Usu√°rio', 'Obs'],
                rows: dados.map(d => [d.Data, d.Tipo, d.Produto, d.Quantidade, d['Estoque Anterior'], d['Estoque Novo'], d.Usu√°rio, d.Observa√ß√£o])
            };
        }

        function obterDadosMovimentacoesSabor() {
            let movsFiltradas = todasMovimentacoes.filter(m => {
                if (!m.sabor_id) return false;
                
                const produto = todosProdutos.find(p => p.id === m.produto_id);
                if (!produto) return false;
                
                if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return false;
                if (filtroAtual.produto && m.produto_id !== filtroAtual.produto) return false;
                if (filtroAtual.sabor && m.sabor_id !== filtroAtual.sabor) return false;
                
                return true;
            });

            return movsFiltradas.map(m => {
                const saborInfo = todosSabores.find(s => s.id === m.sabor_id);
                return {
                    'Data': formatDateTime(m.created_at),
                    'Tipo': m.tipo,
                    'Produto': m.produto?.nome || '-',
                    'Sabor': saborInfo?.sabor || '-',
                    'Quantidade': m.quantidade,
                    'Usu√°rio': m.usuario?.full_name || '-',
                    'Observa√ß√£o': m.observacao || '-'
                };
            });
        }

        function obterDadosMovimentacoesSaborTabela() {
            const dados = obterDadosMovimentacoesSabor();
            return {
                headers: ['Data', 'Tipo', 'Produto', 'Sabor', 'Qtd', 'Usu√°rio', 'Obs'],
                rows: dados.map(d => [d.Data, d.Tipo, d.Produto, d.Sabor, d.Quantidade, d.Usu√°rio, d.Observa√ß√£o])
            };
        }

        function formatDateTime(date) {
            return new Date(date).toLocaleString('pt-BR');
        }
    </script>
</body>
</html>
