<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Estoque - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-warehouse mr-3 text-orange-600"></i>Gerenciamento de Estoque
                </h2>
                <p class="text-gray-600 mt-2">Controle de estoque por produto e lote</p>
            </div>

            <!-- Cards de Totais -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Produtos em Estoque</p>
                            <p id="card-total-produtos" class="text-2xl font-bold text-orange-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">Total de produtos</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <i class="fas fa-boxes text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Valor Total Estoque</p>
                            <p id="card-total-valor" class="text-2xl font-bold text-blue-600">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">Custo total</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-dollar-sign text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Lotes Cadastrados</p>
                            <p id="card-total-lotes" class="text-2xl font-bold text-green-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">Lotes rastreados</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-list text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Produtos Baixos</p>
                            <p id="card-produtos-baixos" class="text-2xl font-bold text-red-600">0</p>
                            <p class="text-xs text-gray-500 mt-1">Abaixo do m√≠nimo</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros Globais -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marca</label>
                        <select id="filter-marca" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()">
                            <option value="">Todas as marcas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="filter-categoria" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Situa√ß√£o</label>
                        <select id="filter-situacao" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="ZERADO">Zerado</option>
                            <option value="BAIXO">Baixo</option>
                            <option value="OK">OK</option>
                        </select>
                    </div>
                    <div class="flex items-center h-full">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="filter-inativos" class="w-4 h-4" onchange="aplicarFiltros()">
                            <span class="text-sm text-gray-700">Mostrar inativos</span>
                        </label>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="limparFiltros()" class="flex-1 px-4 py-2 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            <i class="fas fa-redo mr-2"></i>Limpar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs de Estoque -->
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex overflow-x-auto">
                        <button onclick="switchTab('estoque-produto')" id="tab-estoque-produto" class="tab-button active py-4 px-6 font-medium text-sm border-b-2 border-blue-600 text-blue-600">
                            üì¶ Estoque por Produto
                        </button>
                        <button onclick="switchTab('estoque-lote')" id="tab-estoque-lote" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üìã Estoque por Lote
                        </button>
                        <button onclick="switchTab('mov-produto')" id="tab-mov-produto" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üìä Movimenta√ß√µes
                        </button>
                        <div class="ml-auto flex gap-2 items-center pr-6">
                            <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                                <i class="fas fa-download mr-2"></i>Excel
                            </button>
                            <button onclick="exportarPDF()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">
                                <i class="fas fa-file-pdf mr-2"></i>PDF
                            </button>
                        </div>
                    </nav>
                </div>

                <!-- Tab Content: Estoque por Produto -->
                <div id="content-estoque-produto" class="tab-content p-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold">Estoque Geral por Produto</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unidade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque Atual</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque M√≠nimo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Situa√ß√£o</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo Custo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-estoque-produto" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Estoque por Lote -->
                <div id="content-estoque-lote" class="tab-content p-6 hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold">Estoque Detalhado por Lote</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lote</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fabrica√ß√£o</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Localiza√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-estoque-lote" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Movimenta√ß√µes -->
                <div id="content-mov-produto" class="tab-content p-6 hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold">Hist√≥rico de Movimenta√ß√µes</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Refer√™ncia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usu√°rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motivo</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-mov-produto" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="spinner mx-auto"></div>
            <p class="mt-4 text-gray-700">Carregando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/services/produtos.js"></script>
    <script src="../js/services/estoque.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    
    <script>
        let todosProdutos = [];
        let todosLotes = [];
        let todasMovimentacoes = [];
        let filtroAtual = {
            marca: '',
            categoria: '',
            situacao: ''
        };

        (async () => {
            try {
                await checkAuth();
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
                await initNavbar();
                await initSidebar();
                
                await carregarMarcasFiltro();
                await carregarCategoriasFiltro();
                await carregarDados();
            } catch (error) {
                console.error('Erro ao inicializar estoque:', error);
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
            }
        })();

        async function carregarMarcasFiltro() {
            const marcas = await getMarcas();
            const select = document.getElementById('filter-marca');
            select.innerHTML = '<option value="">Todas as marcas</option>';
            marcas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.nome;
                option.textContent = marca.nome;
                select.appendChild(option);
            });
        }

        async function carregarCategoriasFiltro() {
            try {
                const { data: categorias, error } = await supabase
                    .from('categorias')
                    .select('id, nome')
                    .eq('ativo', true)
                    .order('nome');
                
                if (error) throw error;
                
                const select = document.getElementById('filter-categoria');
                select.innerHTML = '<option value="">Todas as categorias</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        function limparFiltros() {
            document.getElementById('filter-marca').value = '';
            document.getElementById('filter-categoria').value = '';
            document.getElementById('filter-situacao').value = '';
            document.getElementById('filter-inativos').checked = false;
            
            // Limpar localStorage de forma segura (protege contra contextos sem acesso a storage)
            try {
                if (typeof localStorage !== 'undefined' && localStorage) {
                    localStorage.removeItem('filtro-inativos');
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel limpar localStorage:', e.message);
            }
            
            filtroAtual = { marca: '', categoria: '', situacao: '' };
            aplicarFiltros();
        }

        function aplicarFiltros() {
            filtroAtual.marca = document.getElementById('filter-marca').value;
            filtroAtual.categoria = document.getElementById('filter-categoria').value;
            filtroAtual.situacao = document.getElementById('filter-situacao').value;
            
            // Se mudou o checkbox de inativos, recarregar dados
            const incluirInativos = document.getElementById('filter-inativos')?.checked || false;
            
            // Acessar localStorage de forma segura
            let estava = false;
            try {
                if (typeof localStorage !== 'undefined' && localStorage) {
                    estava = localStorage.getItem('filtro-inativos') === 'true';
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel ler localStorage:', e.message);
            }
            
            if (incluirInativos !== estava) {
                // Salvar localStorage de forma segura
                try {
                    if (typeof localStorage !== 'undefined' && localStorage) {
                        localStorage.setItem('filtro-inativos', incluirInativos);
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel salvar localStorage:', e.message);
                }
                carregarDados();
            } else {
                renderizarTabAtiva();
                calcularTotaisEstoque();
            }
        }

        function calcularTotaisEstoque() {
            let totalProdutos = 0;
            let totalValor = 0;
            let totalLotes = 0;
            let produtosBaixos = 0;
            
            todosProdutos.forEach(p => {
                if (filtroAtual.marca && p.marca_nome !== filtroAtual.marca) return;
                if (filtroAtual.categoria && p.categoria_id !== filtroAtual.categoria) return;
                
                totalProdutos++;
                const valorTotal = (p.estoque_atual || 0) * (p.preco_custo || 0);
                totalValor += valorTotal;
                
                const lotesProduct = todosLotes.filter(l => l.produto_id === p.id && l.ativo);
                totalLotes += lotesProduct.length;
                
                if ((p.estoque_atual || 0) <= (p.estoque_minimo || 0)) {
                    produtosBaixos++;
                }
            });
            
            document.getElementById('card-total-produtos').textContent = totalProdutos;
            document.getElementById('card-total-valor').textContent = formatCurrency(totalValor);
            document.getElementById('card-total-lotes').textContent = totalLotes;
            document.getElementById('card-produtos-baixos').textContent = produtosBaixos;
        }

        async function carregarDados() {
            showLoading(true);
            try {
                // Carregar com op√ß√£o de incluir inativos se checkbox estiver marcado
                const incluirInativos = document.getElementById('filter-inativos')?.checked || false;
                todosProdutos = await listProdutos({ incluirInativos });
                
                const { data: lotes, error: erroLotes } = await supabase
                    .from('produto_lotes')
                    .select('*, produto:produtos(id, nome, marca_id, marca:marcas(id, nome))')
                    .eq('ativo', true)
                    .order('created_at', { ascending: false });
                
                if (erroLotes) throw erroLotes;
                todosLotes = lotes || [];
                
                todasMovimentacoes = await listMovimentacoes({ limit: 500 });
                
                renderizarTabAtiva();
                calcularTotaisEstoque();
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                handleError(error, 'Erro ao carregar dados');
            } finally {
                showLoading(false);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-600', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            renderizarTabAtiva();
        }

        function renderizarTabAtiva() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            
            switch(activeTab) {
                case 'estoque-produto':
                    renderEstoqueProduto();
                    break;
                case 'estoque-lote':
                    renderEstoqueLote();
                    break;
                case 'mov-produto':
                    renderMovimentacoes();
                    break;
            }
        }

        function renderEstoqueProduto() {
            let produtos = [...todosProdutos];
            
            if (filtroAtual.marca) {
                produtos = produtos.filter(p => p.marca_nome === filtroAtual.marca);
            }
            if (filtroAtual.categoria) {
                produtos = produtos.filter(p => p.categoria_id === filtroAtual.categoria);
            }
            if (filtroAtual.situacao) {
                produtos = produtos.filter(p => getSituacaoEstoque(p).tipo === filtroAtual.situacao);
            }
            
            const tbody = document.getElementById('tbody-estoque-produto');
            
            if (produtos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Nenhum produto encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = produtos.map(p => {
                const situacao = getSituacaoEstoque(p);
                const valorTotal = (p.estoque_atual || 0) * (p.preco_custo || 0);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${p.codigo || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${p.marca_nome || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${p.categoria_nome || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 font-medium">${p.nome}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${p.unidade_medida_padrao || 'UN'}</td>
                        <td class="px-6 py-4 text-sm"><span class="font-semibold ${situacao.color}">${(p.estoque_atual || 0).toFixed(2)}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-600">${(p.estoque_minimo || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm">${situacao.badge}</td>
                        <td class="px-6 py-4 text-sm">${formatCurrency(p.preco_custo || 0)}</td>
                        <td class="px-6 py-4 text-sm font-medium">${formatCurrency(valorTotal)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderEstoqueLote() {
            let lotes = [...todosLotes];
            
            if (filtroAtual.marca) {
                lotes = lotes.filter(l => l.produto?.marca?.nome === filtroAtual.marca);
            }
            
            const tbody = document.getElementById('tbody-estoque-lote');
            
            if (lotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhum lote encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = lotes.map(l => {
                const status = l.data_vencimento && new Date(l.data_vencimento) < new Date()
                    ? '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Vencido</span>'
                    : '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Ativo</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-700">${l.produto?.marca?.nome || '-'}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${l.produto?.nome || '-'}</td>
                        <td class="px-6 py-4 text-sm font-medium text-blue-600">${l.numero_lote}</td>
                        <td class="px-6 py-4 text-sm"><span class="font-semibold text-green-600">${(l.quantidade || 0).toFixed(2)}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-600">${l.data_fabricacao ? new Date(l.data_fabricacao).toLocaleDateString('pt-BR') : '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${l.data_vencimento ? new Date(l.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                        <td class="px-6 py-4 text-sm">${status}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${l.localizacao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderMovimentacoes() {
            let movimentacoes = [...todasMovimentacoes];
            
            if (filtroAtual.marca) {
                const produtosIds = todosProdutos.filter(p => p.marca_nome === filtroAtual.marca).map(p => p.id);
                movimentacoes = movimentacoes.filter(m => produtosIds.includes(m.produto_id));
            }
            
            const tbody = document.getElementById('tbody-mov-produto');
            
            if (movimentacoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhuma movimenta√ß√£o encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = movimentacoes.map(m => {
                // Verificar se √© entrada ou sa√≠da baseado no prefixo do tipo
                const isEntrada = m.tipo_movimento?.startsWith('ENTRADA') || false;
                const tipoBadge = isEntrada
                    ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Entrada</span>'
                    : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Sa√≠da</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-600">${formatDateTime(m.created_at)}</td>
                        <td class="px-6 py-4 text-sm">${tipoBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${m.produto?.nome || '-'}</td>
                        <td class="px-6 py-4 text-sm font-medium">${(m.quantidade || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${m.referencia_tipo || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${m.usuario?.full_name || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${m.motivo || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getSituacaoEstoque(produto) {
            const estoque = produto.estoque_atual || 0;
            const minimo = produto.estoque_minimo || 0;
            
            if (estoque === 0) {
                return {
                    tipo: 'ZERADO',
                    badge: '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Zerado</span>',
                    color: 'text-red-600'
                };
            } else if (estoque <= minimo) {
                return {
                    tipo: 'BAIXO',
                    badge: '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">Baixo</span>',
                    color: 'text-yellow-600'
                };
            } else {
                return {
                    tipo: 'OK',
                    badge: '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">OK</span>',
                    color: 'text-green-600'
                };
            }
        }

        function exportarExcel() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            const timestamp = new Date().toLocaleString('pt-BR').replace(/[/:]/g, '-');
            let dados = [];
            let nomeArquivo = '';

            switch(activeTab) {
                case 'estoque-produto':
                    dados = obterDadosEstoqueProduto();
                    nomeArquivo = `Estoque_Produto_${timestamp}.xlsx`;
                    break;
                case 'estoque-lote':
                    dados = obterDadosEstoqueLote();
                    nomeArquivo = `Estoque_Lote_${timestamp}.xlsx`;
                    break;
                case 'mov-produto':
                    dados = obterDadosMovimentacoes();
                    nomeArquivo = `Movimentacoes_${timestamp}.xlsx`;
                    break;
            }

            if (dados.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dados');
            XLSX.writeFile(wb, nomeArquivo);
        }

        function exportarPDF() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            const timestamp = new Date().toLocaleString('pt-BR');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text('Gerenciamento de Estoque', 14, 15);
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${timestamp}`, 14, 22);
            doc.setTextColor(0, 0, 0);

            let startY = 28;

            switch(activeTab) {
                case 'estoque-produto':
                    exportarTabelaPDF(doc, 'Estoque por Produto', obterDadosEstoqueProdutoTabela(), startY);
                    break;
                case 'estoque-lote':
                    exportarTabelaPDF(doc, 'Estoque por Lote', obterDadosEstoqueLoteTabela(), startY);
                    break;
                case 'mov-produto':
                    exportarTabelaPDF(doc, 'Movimenta√ß√µes', obterDadosMovimentacoesTabela(), startY);
                    break;
            }

            doc.save(`Estoque_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarTabelaPDF(doc, titulo, dados, startY) {
            doc.setFontSize(11);
            doc.text(titulo, 14, startY);

            doc.autoTable({
                startY: startY + 5,
                head: [dados.headers],
                body: dados.rows,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 8 }
            });
        }

        function obterDadosEstoqueProduto() {
            let produtos = [...todosProdutos];
            
            if (filtroAtual.marca) {
                produtos = produtos.filter(p => p.marca_nome === filtroAtual.marca);
            }
            if (filtroAtual.categoria) {
                produtos = produtos.filter(p => p.categoria_id === filtroAtual.categoria);
            }

            return produtos.map(p => {
                const situacao = getSituacaoEstoque(p);
                const valorTotal = (p.estoque_atual || 0) * (p.preco_custo || 0);
                
                return {
                    'C√≥digo': p.codigo || '-',
                    'Marca': p.marca_nome || '-',
                    'Categoria': p.categoria_nome || '-',
                    'Produto': p.nome,
                    'Estoque Atual': (p.estoque_atual || 0).toFixed(2),
                    'Estoque M√≠nimo': (p.estoque_minimo || 0).toFixed(2),
                    'Situa√ß√£o': situacao.tipo,
                    'Pre√ßo Custo': `R$ ${(p.preco_custo || 0).toFixed(2)}`,
                    'Valor Total': `R$ ${valorTotal.toFixed(2)}`
                };
            });
        }

        function obterDadosEstoqueProdutoTabela() {
            const dados = obterDadosEstoqueProduto();
            return {
                headers: ['C√≥digo', 'Marca', 'Categoria', 'Produto', 'Est. Atual', 'Est. M√≠n', 'Sit', 'P. Custo', 'Val Total'],
                rows: dados.map(d => [
                    d.C√≥digo, d.Marca, d.Categoria, d.Produto, 
                    d['Estoque Atual'], d['Estoque M√≠nimo'], d.Situa√ß√£o, 
                    d['Pre√ßo Custo'], d['Valor Total']
                ])
            };
        }

        function obterDadosEstoqueLote() {
            let lotes = [...todosLotes];
            
            if (filtroAtual.marca) {
                lotes = lotes.filter(l => l.produto?.marca === filtroAtual.marca);
            }

            return lotes.map(l => ({
                'Marca': l.produto?.marca?.nome || '-',
                'Produto': l.produto?.nome || '-',
                'Lote': l.numero_lote,
                'Quantidade': (l.quantidade || 0).toFixed(2),
                'Fabrica√ß√£o': l.data_fabricacao ? new Date(l.data_fabricacao).toLocaleDateString('pt-BR') : '-',
                'Vencimento': l.data_vencimento ? new Date(l.data_vencimento).toLocaleDateString('pt-BR') : '-',
                'Localiza√ß√£o': l.localizacao || '-'
            }));
        }

        function obterDadosEstoqueLoteTabela() {
            const dados = obterDadosEstoqueLote();
            return {
                headers: ['Marca', 'Produto', 'Lote', 'Qtd', 'Fabrica√ß√£o', 'Vencimento', 'Local'],
                rows: dados.map(d => [d.Marca, d.Produto, d.Lote, d.Quantidade, d.Fabrica√ß√£o, d.Vencimento, d.Localiza√ß√£o])
            };
        }

        function obterDadosMovimentacoes() {
            let movs = [...todasMovimentacoes];
            
            if (filtroAtual.marca) {
                const produtosIds = todosProdutos.filter(p => p.marca_nome === filtroAtual.marca).map(p => p.id);
                movs = movs.filter(m => produtosIds.includes(m.produto_id));
            }

            return movs.map(m => ({
                'Data': formatDateTime(m.created_at),
                'Tipo': m.tipo_movimento,
                'Produto': m.produto?.nome || '-',
                'Quantidade': (m.quantidade || 0).toFixed(2),
                'Motivo': m.motivo || '-',
                'Usu√°rio': m.usuario?.full_name || '-'
            }));
        }

        function obterDadosMovimentacoesTabela() {
            const dados = obterDadosMovimentacoes();
            return {
                headers: ['Data', 'Tipo', 'Produto', 'Qtd', 'Motivo', 'Usu√°rio'],
                rows: dados.map(d => [d.Data, d.Tipo, d.Produto, d.Quantidade, d.Motivo, d.Usu√°rio])
            };
        }

        function formatDateTime(date) {
            return new Date(date).toLocaleString('pt-BR');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
