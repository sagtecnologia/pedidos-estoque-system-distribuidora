<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Lucros - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">An√°lise de Lucros</h2>
                <p class="text-gray-600 mt-2">An√°lise detalhada de margem e lucro por marca, produto e sabor</p>
            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marca</label>
                        <select id="filter-marca" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="carregarProdutosFiltro()">
                            <option value="">Todas as marcas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Produto</label>
                        <select id="filter-produto" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="carregarSaboresFiltro()" disabled>
                            <option value="">Todos os produtos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sabor</label>
                        <select id="filter-sabor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()" disabled>
                            <option value="">Todos os sabores</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio</label>
                        <input type="date" id="filter-data-inicio" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                        <input type="date" id="filter-data-fim" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="aplicarFiltros()">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="aplicarFiltros()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        üîç Filtrar
                    </button>
                    <button onclick="limparFiltros()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        üîÑ Limpar
                    </button>
                    <button onclick="exportarRelatorio()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        üì• Exportar PDF
                    </button>
                </div>
            </div>

            <!-- Cards Resumo -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Receita Total</p>
                            <p id="card-receita" class="text-2xl font-bold text-gray-900">R$ 0,00</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Custo Total</p>
                            <p id="card-custo" class="text-2xl font-bold text-gray-900">R$ 0,00</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Lucro Total</p>
                            <p id="card-lucro" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Margem M√©dia</p>
                            <p id="card-margem" class="text-2xl font-bold text-purple-600">0%</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition" onclick="window.location.href='/pages/vendas-pendentes.html'">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">A Receber</p>
                            <p id="card-pendente" class="text-2xl font-bold text-orange-600">R$ 0,00</p>
                            <p id="card-pendente-count" class="text-xs text-gray-500 mt-1">0 vendas</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button onclick="switchTab('por-marca')" id="tab-por-marca" class="tab-button active py-4 px-6 font-medium text-sm border-b-2 border-blue-600 text-blue-600">
                            üè∑Ô∏è Por Marca
                        </button>
                        <button onclick="switchTab('por-produto')" id="tab-por-produto" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üì¶ Por Produto
                        </button>
                        <button onclick="switchTab('por-sabor')" id="tab-por-sabor" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üçì Por Sabor
                        </button>
                        <button onclick="switchTab('detalhado')" id="tab-detalhado" class="tab-button py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            üìä Detalhado
                        </button>
                    </nav>
                </div>

                <!-- Tab: Por Marca -->
                <div id="content-por-marca" class="tab-content p-6">
                    <h3 class="text-lg font-semibold mb-4">Lucro Consolidado por Marca</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd Vendida</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Receita</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">% Total</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-por-marca" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Por Produto -->
                <div id="content-por-produto" class="tab-content p-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Lucro por Produto</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd Vendida</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Receita</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-por-produto" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Por Sabor -->
                <div id="content-por-sabor" class="tab-content p-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Lucro Detalhado por Sabor</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sabor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd Vendida</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Receita</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Margem</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-por-sabor" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Detalhado -->
                <div id="content-detalhado" class="tab-content p-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">An√°lise Detalhada de Vendas</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pedido</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sabor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo Un.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custo Un.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro Un.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lucro Total</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-detalhado" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-700">Carregando...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/services/produtos.js"></script>
    <script src="../js/services/pedidos.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    
    <script>
        let vendasFinalizadas = [];
        let todosProdutos = [];
        let filtroAtual = {
            marca: '',
            produto: '',
            sabor: '',
            dataInicio: '',
            dataFim: ''
        };

        (async () => {
            await checkAuth();
            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();
            
            // Definir data padr√£o (√∫ltimo m√™s)
            const hoje = new Date();
            const umMesAtras = new Date();
            umMesAtras.setMonth(hoje.getMonth() - 1);
            
            document.getElementById('filter-data-inicio').value = umMesAtras.toISOString().split('T')[0];
            document.getElementById('filter-data-fim').value = hoje.toISOString().split('T')[0];
            
            await carregarMarcasFiltro();
            await carregarDados();
        })();

        async function carregarMarcasFiltro() {
            const marcas = await getMarcas();
            const select = document.getElementById('filter-marca');
            select.innerHTML = '<option value="">Todas as marcas</option>';
            marcas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca;
                option.textContent = marca;
                select.appendChild(option);
            });
        }

        async function carregarProdutosFiltro() {
            const marca = document.getElementById('filter-marca').value;
            const selectProduto = document.getElementById('filter-produto');
            const selectSabor = document.getElementById('filter-sabor');
            
            selectProduto.innerHTML = '<option value="">Todos os produtos</option>';
            selectSabor.innerHTML = '<option value="">Todos os sabores</option>';
            selectSabor.disabled = true;
            
            if (!marca) {
                selectProduto.disabled = true;
                aplicarFiltros();
                return;
            }
            
            const produtos = todosProdutos.filter(p => p.marca === marca);
            produtos.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nome;
                selectProduto.appendChild(option);
            });
            
            selectProduto.disabled = false;
            aplicarFiltros();
        }

        async function carregarSaboresFiltro() {
            const produtoId = document.getElementById('filter-produto').value;
            const selectSabor = document.getElementById('filter-sabor');
            
            selectSabor.innerHTML = '<option value="">Todos os sabores</option>';
            
            if (!produtoId) {
                selectSabor.disabled = true;
                aplicarFiltros();
                return;
            }
            
            const sabores = await getSaboresProduto(produtoId);
            sabores.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.sabor;
                selectSabor.appendChild(option);
            });
            
            selectSabor.disabled = false;
            aplicarFiltros();
        }

        function limparFiltros() {
            document.getElementById('filter-marca').value = '';
            document.getElementById('filter-produto').value = '';
            document.getElementById('filter-produto').disabled = true;
            document.getElementById('filter-sabor').value = '';
            document.getElementById('filter-sabor').disabled = true;
            
            const hoje = new Date();
            const umMesAtras = new Date();
            umMesAtras.setMonth(hoje.getMonth() - 1);
            document.getElementById('filter-data-inicio').value = umMesAtras.toISOString().split('T')[0];
            document.getElementById('filter-data-fim').value = hoje.toISOString().split('T')[0];
            
            filtroAtual = { marca: '', produto: '', sabor: '', dataInicio: '', dataFim: '' };
            aplicarFiltros();
        }

        function aplicarFiltros() {
            filtroAtual.marca = document.getElementById('filter-marca').value;
            filtroAtual.produto = document.getElementById('filter-produto').value;
            filtroAtual.sabor = document.getElementById('filter-sabor').value;
            filtroAtual.dataInicio = document.getElementById('filter-data-inicio').value;
            filtroAtual.dataFim = document.getElementById('filter-data-fim').value;
            
            calcularResumo();
            renderizarTabAtiva();
        }

        async function carregarDados() {
            showLoading(true);
            try {
                // Carregar produtos
                todosProdutos = await listProdutos();
                
                // Carregar vendas finalizadas com itens
                const { data: pedidos, error } = await supabase
                    .from('pedidos')
                    .select(`
                        *,
                        cliente:clientes(nome),
                        solicitante:users!pedidos_solicitante_id_fkey(full_name)
                    `)
                    .eq('tipo_pedido', 'VENDA')
                    .eq('status', 'FINALIZADO')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Buscar itens de cada pedido
                vendasFinalizadas = await Promise.all(pedidos.map(async p => {
                    const itens = await getItensPedido(p.id);
                    return { ...p, itens };
                }));
                
                calcularResumo();
                renderizarTabAtiva();
                await carregarValoresPendentes();
            } catch (error) {
                handleError(error, 'Erro ao carregar dados');
            } finally {
                showLoading(false);
            }
        }

        function calcularResumo() {
            const vendas = filtrarVendas();
            
            let receitaTotal = 0;
            let custoTotal = 0;
            
            vendas.forEach(venda => {
                venda.itens.forEach(item => {
                    const produto = todosProdutos.find(p => p.id === item.produto_id);
                    if (produto) {
                        receitaTotal += item.preco_unitario * item.quantidade;
                        custoTotal += (produto.preco_compra || 0) * item.quantidade;
                    }
                });
            });
            
            const lucroTotal = receitaTotal - custoTotal;
            const margemMedia = receitaTotal > 0 ? (lucroTotal / receitaTotal * 100) : 0;
            
            document.getElementById('card-receita').textContent = formatCurrency(receitaTotal);
            document.getElementById('card-custo').textContent = formatCurrency(custoTotal);
            document.getElementById('card-lucro').textContent = formatCurrency(lucroTotal);
            document.getElementById('card-margem').textContent = margemMedia.toFixed(1) + '%';
        }

        function filtrarVendas() {
            let vendas = [...vendasFinalizadas];
            
            // Filtro de data
            if (filtroAtual.dataInicio) {
                vendas = vendas.filter(v => new Date(v.created_at) >= new Date(filtroAtual.dataInicio));
            }
            if (filtroAtual.dataFim) {
                const dataFim = new Date(filtroAtual.dataFim);
                dataFim.setHours(23, 59, 59);
                vendas = vendas.filter(v => new Date(v.created_at) <= dataFim);
            }
            
            return vendas;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-600', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            renderizarTabAtiva();
        }

        function renderizarTabAtiva() {
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            
            switch(activeTab) {
                case 'por-marca':
                    renderPorMarca();
                    break;
                case 'por-produto':
                    renderPorProduto();
                    break;
                case 'por-sabor':
                    renderPorSabor();
                    break;
                case 'detalhado':
                    renderDetalhado();
                    break;
            }
        }

        function renderPorMarca() {
            const vendas = filtrarVendas();
            const lucrosPorMarca = {};
            
            vendas.forEach(venda => {
                venda.itens.forEach(item => {
                    const produto = todosProdutos.find(p => p.id === item.produto_id);
                    if (!produto) return;
                    
                    // Aplicar filtros
                    if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return;
                    if (filtroAtual.produto && produto.id !== filtroAtual.produto) return;
                    if (filtroAtual.sabor && item.sabor_id !== filtroAtual.sabor) return;
                    
                    const marca = produto.marca || 'SEM MARCA';
                    if (!lucrosPorMarca[marca]) {
                        lucrosPorMarca[marca] = { quantidade: 0, receita: 0, custo: 0 };
                    }
                    
                    lucrosPorMarca[marca].quantidade += item.quantidade;
                    lucrosPorMarca[marca].receita += item.preco_unitario * item.quantidade;
                    lucrosPorMarca[marca].custo += (produto.preco_compra || 0) * item.quantidade;
                });
            });
            
            const tbody = document.getElementById('tbody-por-marca');
            const dados = Object.entries(lucrosPorMarca).map(([marca, dados]) => ({
                marca,
                ...dados,
                lucro: dados.receita - dados.custo,
                margem: dados.receita > 0 ? (dados.receita - dados.custo) / dados.receita * 100 : 0
            })).sort((a, b) => b.lucro - a.lucro);
            
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            const lucroTotal = dados.reduce((sum, d) => sum + d.lucro, 0);
            
            tbody.innerHTML = dados.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${d.marca}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${d.quantidade.toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(d.receita)}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${formatCurrency(d.custo)}</td>
                    <td class="px-6 py-4 text-sm font-bold text-green-600">${formatCurrency(d.lucro)}</td>
                    <td class="px-6 py-4 text-sm text-purple-600">${d.margem.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${(d.lucro / lucroTotal * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        function renderPorProduto() {
            const vendas = filtrarVendas();
            const lucrosPorProduto = {};
            
            vendas.forEach(venda => {
                venda.itens.forEach(item => {
                    const produto = todosProdutos.find(p => p.id === item.produto_id);
                    if (!produto) return;
                    
                    // Aplicar filtros
                    if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return;
                    if (filtroAtual.produto && produto.id !== filtroAtual.produto) return;
                    
                    const key = produto.id;
                    if (!lucrosPorProduto[key]) {
                        lucrosPorProduto[key] = { 
                            marca: produto.marca,
                            produto: produto.nome,
                            quantidade: 0, 
                            receita: 0, 
                            custo: 0 
                        };
                    }
                    
                    lucrosPorProduto[key].quantidade += item.quantidade;
                    lucrosPorProduto[key].receita += item.preco_unitario * item.quantidade;
                    lucrosPorProduto[key].custo += (produto.preco_compra || 0) * item.quantidade;
                });
            });
            
            const tbody = document.getElementById('tbody-por-produto');
            const dados = Object.values(lucrosPorProduto).map(d => ({
                ...d,
                lucro: d.receita - d.custo,
                margem: d.receita > 0 ? (d.receita - d.custo) / d.receita * 100 : 0
            })).sort((a, b) => b.lucro - a.lucro);
            
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = dados.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm text-gray-700">${d.marca || '-'}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${d.produto}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${d.quantidade.toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(d.receita)}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${formatCurrency(d.custo)}</td>
                    <td class="px-6 py-4 text-sm font-bold text-green-600">${formatCurrency(d.lucro)}</td>
                    <td class="px-6 py-4 text-sm text-purple-600">${d.margem.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        async function renderPorSabor() {
            const vendas = filtrarVendas();
            const lucrosPorSabor = {};
            
            for (const venda of vendas) {
                for (const item of venda.itens) {
                    const produto = todosProdutos.find(p => p.id === item.produto_id);
                    if (!produto || !item.sabor_id) continue;
                    
                    // Aplicar filtros
                    if (filtroAtual.marca && produto.marca !== filtroAtual.marca) continue;
                    if (filtroAtual.produto && produto.id !== filtroAtual.produto) continue;
                    if (filtroAtual.sabor && item.sabor_id !== filtroAtual.sabor) continue;
                    
                    const key = `${produto.id}-${item.sabor_id}`;
                    if (!lucrosPorSabor[key]) {
                        lucrosPorSabor[key] = {
                            marca: produto.marca,
                            produto: produto.nome,
                            sabor: item.sabor?.sabor || 'Carregando...',
                            quantidade: 0,
                            receita: 0,
                            custo: 0
                        };
                    }
                    
                    lucrosPorSabor[key].quantidade += item.quantidade;
                    lucrosPorSabor[key].receita += item.preco_unitario * item.quantidade;
                    lucrosPorSabor[key].custo += (produto.preco_compra || 0) * item.quantidade;
                }
            }
            
            const tbody = document.getElementById('tbody-por-sabor');
            const dados = Object.values(lucrosPorSabor).map(d => ({
                ...d,
                lucro: d.receita - d.custo,
                margem: d.receita > 0 ? (d.receita - d.custo) / d.receita * 100 : 0
            })).sort((a, b) => b.lucro - a.lucro);
            
            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = dados.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm text-gray-700">${d.marca || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${d.produto}</td>
                    <td class="px-6 py-4 text-sm font-medium text-blue-600">${d.sabor}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${d.quantidade.toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(d.receita)}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${formatCurrency(d.custo)}</td>
                    <td class="px-6 py-4 text-sm font-bold text-green-600">${formatCurrency(d.lucro)}</td>
                    <td class="px-6 py-4 text-sm text-purple-600">${d.margem.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        function renderDetalhado() {
            const vendas = filtrarVendas();
            const tbody = document.getElementById('tbody-detalhado');
            const linhas = [];
            
            vendas.forEach(venda => {
                venda.itens.forEach(item => {
                    const produto = todosProdutos.find(p => p.id === item.produto_id);
                    if (!produto) return;
                    
                    // Aplicar filtros
                    if (filtroAtual.marca && produto.marca !== filtroAtual.marca) return;
                    if (filtroAtual.produto && produto.id !== filtroAtual.produto) return;
                    if (filtroAtual.sabor && item.sabor_id !== filtroAtual.sabor) return;
                    
                    const custoUnitario = produto.preco_compra || 0;
                    const lucroUnitario = item.preco_unitario - custoUnitario;
                    const lucroTotal = lucroUnitario * item.quantidade;
                    
                    linhas.push({
                        data: venda.created_at,
                        numero: venda.numero,
                        cliente: venda.cliente?.nome || '-',
                        produto: produto.nome,
                        sabor: item.sabor?.sabor || '-',
                        quantidade: item.quantidade,
                        preco: item.preco_unitario,
                        custo: custoUnitario,
                        lucroUn: lucroUnitario,
                        lucroTotal: lucroTotal
                    });
                });
            });
            
            if (linhas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = linhas.map(l => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm text-gray-600">${formatDate(l.data)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${l.numero}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${l.cliente}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${l.produto}</td>
                    <td class="px-6 py-4 text-sm text-blue-600">${l.sabor}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${l.quantidade}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(l.preco)}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${formatCurrency(l.custo)}</td>
                    <td class="px-6 py-4 text-sm text-green-600">${formatCurrency(l.lucroUn)}</td>
                    <td class="px-6 py-4 text-sm font-bold text-green-600">${formatCurrency(l.lucroTotal)}</td>
                </tr>
            `).join('');
        }

        async function carregarValoresPendentes() {
            try {
                const { data, error } = await supabase
                    .from('pedidos')
                    .select('valor_pendente')
                    .eq('tipo_pedido', 'VENDA')
                    .eq('status', 'FINALIZADO')
                    .in('pagamento_status', ['PENDENTE', 'PARCIAL']);
                
                if (error) throw error;
                
                const total = data.reduce((sum, v) => sum + (v.valor_pendente || 0), 0);
                const count = data.length;
                
                document.getElementById('card-pendente').textContent = formatCurrency(total);
                document.getElementById('card-pendente-count').textContent = `${count} ${count === 1 ? 'venda' : 'vendas'}`;
            } catch (error) {
                console.error('Erro ao carregar valores pendentes:', error);
            }
        }

        function exportarRelatorio() {
            showToast('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info');
        }
    </script>
</body>
</html>
