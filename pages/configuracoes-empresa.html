<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes da Empresa - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner { animation: spin 1s linear infinite; }
        .modal-backdrop { backdrop-filter: blur(2px); }
        .btn-action { padding: 0.5rem; border-radius: 0.375rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .table-row-hover:hover { background-color: #f9fafb; transition: background-color 0.2s; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h2 class="text-4xl font-bold text-gray-900">
                        <i class="fas fa-building mr-3 text-teal-600"></i>Configura√ß√µes da Empresa
                    </h2>
                    <p class="text-gray-600 mt-2">Gerencie informa√ß√µes, identidade visual e integra√ß√µes</p>
                </div>
                <button type="button" onclick="salvarConfiguracoesEmpresa()" 
                    class="px-6 py-3 bg-gradient-to-r from-teal-600 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold">
                    <i class="fas fa-save mr-2"></i>Salvar Configura√ß√µes
                </button>
            </div>

            <!-- Loading Spinner -->
            <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 flex items-center space-x-3 shadow-xl">
                    <div class="w-8 h-8 border-4 border-teal-600 border-t-transparent rounded-full spinner"></div>
                    <span class="text-gray-700 font-medium">Processando...</span>
                </div>
            </div>

            <form id="form-empresa" onsubmit="salvarConfiguracoesEmpresa(event)" class="space-y-6">
                <!-- Navega√ß√£o por Tabs -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="border-b border-gray-200 px-6">
                        <nav class="flex space-x-1 -mb-px overflow-x-auto">
                            <button type="button" data-tab="tab-basico" 
                                class="tab-btn px-6 py-4 border-b-2 border-teal-600 text-teal-600 font-semibold whitespace-nowrap">
                                <i class="fas fa-building mr-2"></i>Dados B√°sicos
                            </button>
                            <button type="button" data-tab="tab-endereco" 
                                class="tab-btn px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                                <i class="fas fa-map-marker-alt mr-2"></i>Endere√ßo
                            </button>
                            <button type="button" data-tab="tab-fiscal" 
                                class="tab-btn px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                                <i class="fas fa-file-invoice mr-2"></i>Dados Fiscais
                            </button>
                            <button type="button" data-tab="tab-nfe" 
                                class="tab-btn px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                                <i class="fas fa-receipt mr-2"></i>NF-e / NFC-e
                            </button>
                            <button type="button" data-tab="tab-pdv" 
                                class="tab-btn px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                                <i class="fas fa-cash-register mr-2"></i>PDV
                            </button>
                            <button type="button" data-tab="tab-integracao" 
                                class="tab-btn px-6 py-4 border-b-2 border-transparent text-gray-600 hover:text-gray-800 whitespace-nowrap">
                                <i class="fas fa-plug mr-2"></i>Integra√ß√µes
                            </button>
                        </nav>
                    </div>

                    <!-- Conte√∫do das Tabs -->
                    <div class="p-6 max-h-[70vh] overflow-y-auto">
                        <!-- TAB: Dados B√°sicos -->
                        <div id="tab-basico" class="tab-content">
                            <!-- Logo da Empresa -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Logo da Empresa</h3>
                    
                    <div class="flex items-center space-x-6">
                        <div class="flex-shrink-0">
                            <div id="logo-preview" class="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload de Logo</label>
                            <input type="file" id="logo-input" accept="image/*" class="hidden">
                            <div class="flex space-x-3">
                                <button type="button" onclick="document.getElementById('logo-input').click()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    üì§ Escolher Imagem
                                </button>
                                <button type="button" id="btn-remove-logo" onclick="removerLogo()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">PNG, JPG ou GIF. M√°ximo 2MB.</p>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes B√°sicas -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes B√°sicas</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Fantasia *</label>
                            <input type="text" id="nome_empresa" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Raz√£o Social</label>
                            <input type="text" id="razao_social" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                            <input type="text" id="cnpj" placeholder="00.000.000/0000-00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                            <input type="tel" id="telefone" placeholder="(00) 0000-0000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                            <input type="url" id="website" placeholder="https://" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Endere√ßo -->
            <div id="tab-endereco" class="tab-content hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Endere√ßo Completo</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo Completo</label>
                            <input type="text" id="endereco" placeholder="Rua, n√∫mero, complemento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                            <input type="text" id="cidade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                                <select id="estado" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                    <option value="">Selecione</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                                <input type="text" id="cep" placeholder="00000-000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Dados Fiscais -->
                <div id="tab-fiscal" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üìã Dados Fiscais</h3>
                    <p class="text-sm text-gray-600 mb-4">Informa√ß√µes fiscais obrigat√≥rias para emiss√£o de NFC-e/NF-e</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Inscri√ß√£o Estadual *</label>
                            <input type="text" id="inscricao_estadual" placeholder="000.000.000.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Inscri√ß√£o Municipal</label>
                            <input type="text" id="inscricao_municipal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Regime Tribut√°rio *</label>
                            <select id="regime_tributario" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <option value="1">1 - Simples Nacional</option>
                                <option value="2">2 - Simples Nacional (Excesso)</option>
                                <option value="3">3 - Regime Normal</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CNAE Principal</label>
                            <input type="text" id="cnae" placeholder="4723700" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo Munic√≠pio (IBGE)</label>
                            <input type="text" id="codigo_municipio" placeholder="3550308" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">C√≥digo IBGE de 7 d√≠gitos</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero (Endere√ßo)</label>
                            <input type="text" id="endereco_numero" placeholder="123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                            <input type="text" id="bairro" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Logradouro</label>
                            <input type="text" id="logradouro" placeholder="Rua, Avenida, etc." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- TAB: NF-e / NFC-e -->
                <div id="tab-nfe" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üßæ Integra√ß√£o Focus NFe</h3>
                    <p class="text-sm text-gray-600 mb-4">Configura√ß√µes para emiss√£o de NFC-e e NF-e via Focus NFe</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ambiente Focus NFe *</label>
                            <select id="focusnfe_ambiente" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <option value="2">2 - Homologa√ß√£o (Testes)</option>
                                <option value="1">1 - Produ√ß√£o</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <div id="nfe-status" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-600">
                                <i class="fas fa-circle text-gray-400 mr-2"></i> N√£o configurado
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Token de API Focus NFe *</label>
                            <div class="flex gap-2">
                                <input type="password" id="focusnfe_token" placeholder="Seu token da API Focus NFe" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <button type="button" onclick="togglePasswordVisibility('focusnfe_token')" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                    <i class="fas fa-eye" id="focusnfe_token-icon"></i>
                                </button>
                                <button type="button" onclick="testarConexaoNFe()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    <i class="fas fa-plug mr-2"></i>Testar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Obtenha em: <a href="https://focusnfe.com.br" target="_blank" class="text-teal-600 underline">focusnfe.com.br</a></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S√©rie NFC-e</label>
                            <input type="number" id="nfce_serie" value="1" min="1" max="999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S√©rie NF-e</label>
                            <input type="number" id="nfe_serie" value="1" min="1" max="999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pr√≥ximo N√∫mero NFC-e</label>
                            <input type="number" id="nfce_numero" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pr√≥ximo N√∫mero NF-e</label>
                            <input type="number" id="nfe_numero" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Configura√ß√µes CSC (NFC-e) -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">üîë CSC - C√≥digo de Seguran√ßa do Contribuinte (NFC-e)</h4>
                        <p class="text-sm text-gray-600 mb-3">Obrigat√≥rio para emiss√£o de NFC-e. Obtido no portal da SEFAZ.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CSC ID (Token ID)</label>
                                <input type="text" id="csc_id" placeholder="000001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">ID do token CSC (geralmente 000001)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CSC Token (C√≥digo)</label>
                                <div class="flex gap-2">
                                    <input type="password" id="csc_token" placeholder="C√≥digo CSC da SEFAZ" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                    <button type="button" onclick="togglePasswordVisibility('csc_token')" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                        <i class="fas fa-eye" id="csc_token-icon"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Token CSC fornecido pela SEFAZ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Certificado Digital -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">üîê Certificado Digital A1</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo do Certificado (.pfx)</label>
                                <input type="file" id="certificado_input" accept=".pfx,.p12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha do Certificado</label>
                                <input type="password" id="certificado_senha" placeholder="Senha do .pfx" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            </div>

                            <div class="md:col-span-2">
                                <div id="certificado-info" class="p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-2"></i> Nenhum certificado carregado
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="button" onclick="enviarCertificado()" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                                <i class="fas fa-upload mr-2"></i>Enviar Certificado para Focus NFe
                            </button>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h4 class="text-sm font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Importante:</h4>
                        <ul class="text-sm text-yellow-800 space-y-1">
                            <li>‚Ä¢ Use ambiente de <strong>Homologa√ß√£o</strong> para testes</li>
                            <li>‚Ä¢ O certificado A1 deve estar v√°lido (verifique a data de expira√ß√£o)</li>
                            <li>‚Ä¢ O certificado √© enviado e armazenado no Focus NFe, n√£o neste sistema</li>
                            <li>‚Ä¢ Consulte seu contador para os dados fiscais corretos</li>
                        </ul>
                    </div>
                </div>

                <!-- TAB: PDV -->
                <div id="tab-pdv" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üñ•Ô∏è Configura√ß√µes do PDV</h3>
                    <p class="text-sm text-gray-600 mb-4">Op√ß√µes para o Ponto de Venda</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <div class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <input type="checkbox" id="pdv_emitir_nfce_automatico" class="w-5 h-5 text-teal-600 rounded">
                                <label for="pdv_emitir_nfce_automatico" class="text-sm font-semibold text-blue-900">
                                    <i class="fas fa-file-invoice mr-2"></i>Emitir NFC-e automaticamente ao finalizar venda no PDV
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 ml-1">Se marcado, a NFC-e ser√° emitida automaticamente ap√≥s finalizar a venda</p>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="habilitar_nfce" class="w-4 h-4 text-teal-600 rounded">
                            <label for="habilitar_nfce" class="text-sm font-medium text-gray-700">Habilitar m√≥dulo de NFC-e</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="habilitar_cupom_fiscal" class="w-4 h-4 text-teal-600 rounded">
                            <label for="habilitar_cupom_fiscal" class="text-sm font-medium text-gray-700">Habilitar impress√£o de cupom fiscal</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_imprimir_cupom" checked class="w-4 h-4 text-teal-600 rounded">
                            <label for="pdv_imprimir_cupom" class="text-sm font-medium text-gray-700">Imprimir cupom ap√≥s venda</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_permitir_venda_zerado" class="w-4 h-4 text-teal-600 rounded">
                            <label for="pdv_permitir_venda_zerado" class="text-sm font-medium text-gray-700">Permitir venda com estoque zerado</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_desconto_maximo" class="w-4 h-4 text-teal-600 rounded">
                            <label for="pdv_desconto_maximo" class="text-sm font-medium text-gray-700">Limitar desconto m√°ximo</label>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Desconto M√°ximo (%)</label>
                            <input type="number" id="pdv_desconto_limite" value="10" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem no Cupom</label>
                            <input type="text" id="pdv_mensagem_cupom" placeholder="Obrigado pela prefer√™ncia!" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Alertas e Avisos -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">‚ö†Ô∏è Alertas e Notifica√ß√µes</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="alerta_estoque_minimo" class="w-4 h-4 text-teal-600 rounded">
                                <label for="alerta_estoque_minimo" class="text-sm font-medium text-gray-700">Alertar quando estoque atingir m√≠nimo</label>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dias para alertar validade de produtos</label>
                                <input type="number" id="dias_alerta_validade" value="30" min="1" max="365" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Alertar quando faltar X dias para vencer</p>
                            </div>
                        </div>
                    </div>

                    <!-- Personaliza√ß√£o Visual -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">üé® Personaliza√ß√£o Visual</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cor Prim√°ria (Hex)</label>
                                <div class="flex gap-2">
                                    <input type="color" id="cor_primaria_picker" class="h-10 w-16 border border-gray-300 rounded cursor-pointer">
                                    <input type="text" id="cor_primaria" placeholder="#0D9488" maxlength="7" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cor Secund√°ria (Hex)</label>
                                <div class="flex gap-2">
                                    <input type="color" id="cor_secundaria_picker" class="h-10 w-16 border border-gray-300 rounded cursor-pointer">
                                    <input type="text" id="cor_secundaria" placeholder="#06B6D4" maxlength="7" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Integra√ß√µes -->
                <div id="tab-integracao" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üîå Integra√ß√£o WhatsApp API</h3>
                    <p class="text-sm text-gray-600 mb-4">Configure para envio autom√°tico de PDFs via WhatsApp</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Provedor da API</label>
                            <select id="whatsapp_api_provider" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <option value="">N√£o configurado</option>
                                <option value="evolution">Evolution API</option>
                                <option value="twilio">Twilio</option>
                                <option value="baileys">Baileys</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Origem (com DDI)</label>
                            <input type="text" id="whatsapp_numero_origem" placeholder="5511999999999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Formato: 55 + DDD + n√∫mero (sem espa√ßos ou caracteres)</p>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL da API</label>
                            <input type="url" id="whatsapp_api_url" placeholder="https://api.exemplo.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key / Token</label>
                            <input type="password" id="whatsapp_api_key" placeholder="Seu token de API" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID da Inst√¢ncia (Evolution API)</label>
                            <input type="text" id="whatsapp_instance_id" placeholder="nome-da-instancia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg">
                        <h4 class="text-sm font-semibold text-teal-900 mb-2">üìò APIs Recomendadas:</h4>
                        <ul class="text-sm text-teal-800 space-y-1">
                            <li><strong>Evolution API</strong> - <a href="https://evolution-api.com" target="_blank" class="underline">evolution-api.com</a> (Gratuita, auto-hospedada)</li>
                            <li><strong>Twilio</strong> - <a href="https://www.twilio.com/whatsapp" target="_blank" class="underline">twilio.com/whatsapp</a> (Paga, oficial)</li>
                        </ul>
                    </div>
                </div>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/rbac.js"></script>
    <script src="../js/services/empresa.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    
    <script>
        let logoAtual = null;
        let logoFile = null;

        // ========== INICIALIZA√á√ÉO ==========
        (async () => {
            await checkAuth();
            
            // Proteger com RBAC
            if (!(await RBACSystem.protegerPagina(['ADMIN']))) {
                return;
            }

            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();
            await loadEmpresaConfig();

            // Configurar navega√ß√£o por tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        })();

        // ========== FUN√á√ïES DE TAB ==========
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-teal-600', 'text-teal-600', 'font-semibold', 'bg-red-100', 'text-red-700');
                btn.classList.add('border-transparent', 'text-gray-600');
                btn.style.animation = '';
            });
            document.getElementById(tabId)?.classList.remove('hidden');
            const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-gray-600');
                activeBtn.classList.add('border-teal-600', 'text-teal-600', 'font-semibold');
            }
        }

        // ========== VALIDA√á√ÉO E SAVE ==========
        async function salvarConfiguracoesEmpresa(event) {
            if (event) event.preventDefault();
            
            // Valida√ß√£o de campos obrigat√≥rios
            const erros = [];
            const nomeEmpresa = document.getElementById('nome_empresa')?.value?.trim();
            if (!nomeEmpresa) erros.push({ campo: 'Nome Fantasia', aba: 'Dados B√°sicos' });
            
            if (erros.length > 0) {
                mostrarErrosValidacao(erros);
                return;
            }
            
            const configData = {
                nome_empresa: nomeEmpresa,
                razao_social: document.getElementById('razao_social').value?.trim() || null,
                cnpj: document.getElementById('cnpj').value?.trim() || null,
                telefone: document.getElementById('telefone').value?.trim() || null,
                email: document.getElementById('email').value?.trim() || null,
                website: document.getElementById('website').value?.trim() || null,
                endereco: document.getElementById('endereco').value?.trim() || null,
                cidade: document.getElementById('cidade').value?.trim() || null,
                estado: document.getElementById('estado').value || null,
                cep: document.getElementById('cep').value?.trim() || null,
                inscricao_estadual: document.getElementById('inscricao_estadual').value?.trim() || null,
                inscricao_municipal: document.getElementById('inscricao_municipal').value?.trim() || null,
                regime_tributario: document.getElementById('regime_tributario').value || null,
                cnae: document.getElementById('cnae').value?.trim() || null,
                codigo_municipio: document.getElementById('codigo_municipio').value?.trim() || null,
                endereco_numero: document.getElementById('endereco_numero').value?.trim() || null,
                bairro: document.getElementById('bairro').value?.trim() || null,
                logradouro: document.getElementById('logradouro').value?.trim() || null,
                // Focus NFe
                focusnfe_token: document.getElementById('focusnfe_token').value?.trim() || null,
                focusnfe_ambiente: parseInt(document.getElementById('focusnfe_ambiente').value) || 2,
                nfce_serie: parseInt(document.getElementById('nfce_serie').value) || 1,
                nfe_serie: parseInt(document.getElementById('nfe_serie').value) || 1,
                nfce_numero: parseInt(document.getElementById('nfce_numero').value) || 1,
                nfe_numero: parseInt(document.getElementById('nfe_numero').value) || 1,
                // CSC - NFC-e
                csc_id: document.getElementById('csc_id').value?.trim() || null,
                csc_token: document.getElementById('csc_token').value?.trim() || null,
                // Certificado (campos que existem no banco)
                senha_certificado: document.getElementById('certificado_senha').value?.trim() || null,
                // PDV
                pdv_emitir_nfce_automatico: document.getElementById('pdv_emitir_nfce_automatico').checked,
                habilitar_nfce: document.getElementById('habilitar_nfce').checked,
                habilitar_cupom_fiscal: document.getElementById('habilitar_cupom_fiscal').checked,
                pdv_imprimir_cupom: document.getElementById('pdv_imprimir_cupom').checked,
                pdv_permitir_venda_zerado: document.getElementById('pdv_permitir_venda_zerado').checked,
                pdv_desconto_maximo: document.getElementById('pdv_desconto_maximo').checked,
                pdv_desconto_limite: parseFloat(document.getElementById('pdv_desconto_limite').value) || 10,
                pdv_mensagem_cupom: document.getElementById('pdv_mensagem_cupom').value?.trim() || null,
                // Alertas
                alerta_estoque_minimo: document.getElementById('alerta_estoque_minimo').checked,
                dias_alerta_validade: parseInt(document.getElementById('dias_alerta_validade').value) || 30,
                // Cores
                cor_primaria: document.getElementById('cor_primaria').value?.trim() || null,
                cor_secundaria: document.getElementById('cor_secundaria').value?.trim() || null,
                // WhatsApp
                whatsapp_api_provider: document.getElementById('whatsapp_api_provider').value || null,
                whatsapp_numero_origem: document.getElementById('whatsapp_numero_origem').value?.trim() || null,
                whatsapp_api_url: document.getElementById('whatsapp_api_url').value?.trim() || null,
                whatsapp_api_key: document.getElementById('whatsapp_api_key').value?.trim() || null,
                whatsapp_instance_id: document.getElementById('whatsapp_instance_id').value?.trim() || null
            };

            try {
                showLoading(true);
                const result = await updateEmpresaConfig(configData);
                
                if (logoFile) {
                    await uploadLogo(logoFile);
                }
                
                showToast('Configura√ß√µes salvas com sucesso!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                showToast('Erro ao salvar configura√ß√µes: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function mostrarErrosValidacao(erros) {
            const abasComErro = [...new Set(erros.map(e => e.aba))];
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full">
                    <div class="bg-red-600 text-white p-4 rounded-t-lg">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Campos Obrigat√≥rios N√£o Preenchidos
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>Aten√ß√£o:</strong> Preencha todos os campos obrigat√≥rios marcados com *.
                            </p>
                        </div>
                        <p class="text-gray-700 font-semibold mb-3">Voc√™ precisa preencher:</p>
                        ${abasComErro.map(aba => `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg border-l-4 border-red-500">
                                <div class="font-bold text-red-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-folder-open"></i>Aba: ${aba}
                                </div>
                                <ul class="space-y-1 ml-6">
                                    ${erros.filter(e => e.aba === aba).map(err => `
                                        <li class="text-sm text-gray-700 flex items-start gap-2">
                                            <i class="fas fa-chevron-right text-red-500 mt-1"></i>
                                            <span>${err.campo}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                    <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-end">
                        <button onclick="this.closest('.fixed').remove()"
                            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition-colors">
                            <i class="fas fa-check mr-2"></i>Entendi, vou corrigir
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.querySelectorAll('[data-tab]').forEach(btn => {
                const tabName = btn.getAttribute('data-tab');
                const abaConfig = {
                    'tab-basico': 'Dados B√°sicos',
                    'tab-endereco': 'Endere√ßo',
                    'tab-fiscal': 'Dados Fiscais',
                    'tab-nfe': 'NF-e / NFC-e',
                    'tab-pdv': 'PDV',
                    'tab-integracao': 'Integra√ß√µes'
                };
                if (abasComErro.includes(abaConfig[tabName])) {
                    btn.classList.add('bg-red-100', 'text-red-700', 'font-bold');
                    btn.style.animation = 'pulse 2s infinite';
                }
            });
            
            const primeiraAbaErro = erros[0].aba;
            const mapAba = {
                'Dados B√°sicos': 'tab-basico',
                'Endere√ßo': 'tab-endereco',
                'Dados Fiscais': 'tab-fiscal',
                'NF-e / NFC-e': 'tab-nfe',
                'PDV': 'tab-pdv',
                'Integra√ß√µes': 'tab-integracao'
            };
            const btnAba = document.querySelector(`[data-tab="${mapAba[primeiraAbaErro]}"]`);
            if (btnAba) btnAba.click();
        }

        // ========== CARREGAR DADOS ==========
        async function loadEmpresaConfig() {
            try {
                showLoading(true);
                const config = await getEmpresaConfig();
                if (config) {
                    document.getElementById('nome_empresa').value = config.nome_empresa || '';
                    document.getElementById('razao_social').value = config.razao_social || '';
                    document.getElementById('cnpj').value = config.cnpj || '';
                    document.getElementById('telefone').value = config.telefone || '';
                    document.getElementById('email').value = config.email || '';
                    document.getElementById('website').value = config.website || '';
                    document.getElementById('endereco').value = config.endereco || '';
                    document.getElementById('cidade').value = config.cidade || '';
                    document.getElementById('estado').value = config.estado || '';
                    document.getElementById('cep').value = config.cep || '';
                    document.getElementById('inscricao_estadual').value = config.inscricao_estadual || '';
                    document.getElementById('inscricao_municipal').value = config.inscricao_municipal || '';
                    document.getElementById('regime_tributario').value = config.regime_tributario || '1';
                    document.getElementById('cnae').value = config.cnae || '';
                    document.getElementById('codigo_municipio').value = config.codigo_municipio || '';
                    document.getElementById('endereco_numero').value = config.endereco_numero || '';
                    document.getElementById('bairro').value = config.bairro || '';
                    document.getElementById('logradouro').value = config.logradouro || '';
                    // Focus NFe
                    document.getElementById('focusnfe_token').value = config.focusnfe_token || '';
                    document.getElementById('focusnfe_ambiente').value = config.focusnfe_ambiente || 2;
                    document.getElementById('nfce_serie').value = config.nfce_serie || 1;
                    document.getElementById('nfe_serie').value = config.nfe_serie || 1;
                    document.getElementById('nfce_numero').value = config.nfce_numero || 1;
                    document.getElementById('nfe_numero').value = config.nfe_numero || 1;
                    // CSC
                    document.getElementById('csc_id').value = config.csc_id || '';
                    document.getElementById('csc_token').value = config.csc_token || '';
                    // PDV
                    document.getElementById('pdv_emitir_nfce_automatico').checked = config.pdv_emitir_nfce_automatico || false;
                    document.getElementById('habilitar_nfce').checked = config.habilitar_nfce || false;
                    document.getElementById('habilitar_cupom_fiscal').checked = config.habilitar_cupom_fiscal || false;
                    document.getElementById('pdv_imprimir_cupom').checked = config.pdv_imprimir_cupom !== false;
                    document.getElementById('pdv_permitir_venda_zerado').checked = config.pdv_permitir_venda_zerado || false;
                    document.getElementById('pdv_desconto_maximo').checked = config.pdv_desconto_maximo || false;
                    document.getElementById('pdv_desconto_limite').value = config.pdv_desconto_limite || 10;
                    document.getElementById('pdv_mensagem_cupom').value = config.pdv_mensagem_cupom || '';
                    document.getElementById('whatsapp_api_provider').value = config.whatsapp_api_provider || '';
                    document.getElementById('whatsapp_numero_origem').value = config.whatsapp_numero_origem || '';
                    document.getElementById('whatsapp_api_url').value = config.whatsapp_api_url || '';
                    document.getElementById('whatsapp_api_key').value = config.whatsapp_api_key || '';
                    document.getElementById('whatsapp_instance_id').value = config.whatsapp_instance_id || '';
                    // Certificado
                    document.getElementById('certificado_senha').value = config.senha_certificado || '';
                    // Alertas
                    document.getElementById('alerta_estoque_minimo').checked = config.alerta_estoque_minimo || false;
                    document.getElementById('dias_alerta_validade').value = config.dias_alerta_validade || 30;
                    // Cores
                    document.getElementById('cor_primaria').value = config.cor_primaria || '#0D9488';
                    document.getElementById('cor_primaria_picker').value = config.cor_primaria || '#0D9488';
                    document.getElementById('cor_secundaria').value = config.cor_secundaria || '#06B6D4';
                    document.getElementById('cor_secundaria_picker').value = config.cor_secundaria || '#06B6D4';
                    
                    // Exibir informa√ß√µes do certificado se existir
                    console.log('Verificando certificado:', {
                        temCertificado: !!config.certificado_digital,
                        validade: config.certificado_validade
                    });
                    
                    if (config.certificado_digital) {
                        const validadeInfo = config.certificado_validade 
                            ? ` - Validade: ${new Date(config.certificado_validade).toLocaleDateString('pt-BR')}` 
                            : '';
                        document.getElementById('certificado-info').innerHTML = `
                            <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-certificate text-green-600"></i>
                                        <span class="text-sm text-green-700 font-medium">Certificado digital configurado</span>
                                    </div>
                                    <div class="text-xs text-green-600 mt-1">
                                        ${validadeInfo}
                                    </div>
                                </div>
                                <button onclick="removerCertificado()" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                    
                    if (config.logo_url) {
                        document.getElementById('logo-preview').innerHTML = `<img src="${config.logo_url}" class="w-full h-full object-contain">`;
                        document.getElementById('btn-remove-logo').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            } finally {
                showLoading(false);
            }
        }

        // ========== UTILIT√ÅRIOS ==========
        // M√°scara para CNPJ
        document.getElementById('cnpj').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                e.target.value = value;
            }
        });

        // M√°scara para CEP
        document.getElementById('cep').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/^(\d{5})(\d)/, '$1-$2');
                e.target.value = value;
            }
        });

        // M√°scara para Telefone
        document.getElementById('telefone').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                } else {
                    value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            }
        });

        // Preview da logo
        document.getElementById('logo-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showToast('Apenas imagens s√£o permitidas', 'error');
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    showToast('A imagem deve ter no m√°ximo 2MB', 'error');
                    return;
                }

                logoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('logo-preview').innerHTML = `
                        <img src="${e.target.result}" alt="Logo" class="w-full h-full object-contain">
                    `;
                    document.getElementById('btn-remove-logo').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        function removerLogo() {
            logoFile = null;
            logoAtual = null;
            document.getElementById('logo-input').value = '';
            document.getElementById('logo-preview').innerHTML = `
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            `;
            document.getElementById('btn-remove-logo').classList.add('hidden');
        }

        async function testarConexaoNFe() {
            const token = document.getElementById('focusnfe_token').value;
            const ambiente = document.getElementById('focusnfe_ambiente').value;
            
            if (!token) {
                showToast('Informe o token da API Focus NFe', 'error');
                return;
            }

            try {
                showLoading(true);
                
                // Endpoint Focus NFe para teste: consultar empresa
                const baseUrl = ambiente === '1' || ambiente === 1 
                    ? 'https://api.focusnfe.com.br' 
                    : 'https://homologacao.focusnfe.com.br';
                
                const response = await fetch(`${baseUrl}/v2/empresas`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${btoa(token + ':')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast('‚úì Conex√£o bem-sucedida! Token v√°lido.', 'success');
                    
                    // Exibir informa√ß√µes da empresa se dispon√≠vel
                    if (data.cnpj) {
                        console.log('Empresa Focus NFe:', data);
                    }
                } else if (response.status === 401) {
                    showToast('Token inv√°lido ou sem permiss√£o', 'error');
                } else {
                    showToast(`Erro na conex√£o: ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao testar conex√£o:', error);
                showToast('Erro ao conectar com Focus NFe: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function enviarCertificado() {
            const fileInput = document.getElementById('certificado_input');
            const senha = document.getElementById('certificado_senha').value;
            const token = document.getElementById('focusnfe_token').value;
            const ambiente = document.getElementById('focusnfe_ambiente').value;

            if (!fileInput.files || !fileInput.files[0]) {
                showToast('Selecione o arquivo do certificado (.pfx)', 'error');
                return;
            }

            if (!senha) {
                showToast('Informe a senha do certificado', 'error');
                return;
            }

            if (!token) {
                showToast('Informe o token da API Focus NFe primeiro', 'error');
                return;
            }

            try {
                showLoading(true);
                const file = fileInput.files[0];
                
                // Converter certificado para base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                await new Promise((resolve, reject) => {
                    reader.onload = async () => {
                        try {
                            const base64 = reader.result.split(',')[1];
                            
                            // Enviar para Focus NFe
                            const baseUrl = ambiente === '1' 
                                ? 'https://api.focusnfe.com.br' 
                                : 'https://homologacao.focusnfe.com.br';
                            
                            const response = await fetch(`${baseUrl}/v2/certificados`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Basic ${btoa(token + ':')}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    certificado: base64,
                                    senha: senha
                                })
                            });

                            const result = await response.json();
                            
                            if (response.ok) {
                                // Salvar informa√ß√µes do certificado no banco
                                const configData = {
                                    certificado_digital: base64,
                                    senha_certificado: senha,
                                    certificado_validade: result.validade || null
                                };
                                
                                console.log('Salvando certificado no banco:', {
                                    temCertificado: !!base64,
                                    tamanhoCertificado: base64?.length,
                                    temSenha: !!senha,
                                    validade: result.validade
                                });
                                
                                const savedConfig = await updateEmpresaConfig(configData);
                                console.log('Certificado salvo com sucesso:', savedConfig);
                                
                                const validadeInfo = result.validade 
                                    ? ` - Validade: ${new Date(result.validade).toLocaleDateString('pt-BR')}` 
                                    : '';
                                
                                document.getElementById('certificado-info').innerHTML = `
                                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-certificate text-green-600"></i>
                                                <span class="text-sm text-green-700 font-medium">Certificado enviado com sucesso!</span>
                                            </div>
                                            <div class="text-xs text-green-600 mt-1">
                                                ${file.name}${validadeInfo}
                                            </div>
                                        </div>
                                        <button onclick="removerCertificado()" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                                
                                showToast('‚úì Certificado enviado e configurado com sucesso!', 'success');
                            } else {
                                const errorMsg = result.mensagem || result.erro || 'Erro ao enviar certificado';
                                console.error('Erro da Focus NFe:', result);
                                throw new Error(errorMsg);
                            }
                            
                            resolve();
                        } catch (err) {
                            console.error('Erro ao processar certificado:', err);
                            reject(err);
                        }
                    };
                    
                    reader.onerror = () => {
                        console.error('Erro ao ler arquivo');
                        reject(new Error('Erro ao ler arquivo'));
                    };
                });
                
            } catch (error) {
                console.error('Erro ao enviar certificado:', error);
                const errorMsg = error.message.includes('CORS') || error.message.includes('Failed to fetch')
                    ? 'Erro de CORS - Use uma extens√£o CORS Unblock ou configure via backend'
                    : error.message;
                showToast('Erro ao enviar certificado: ' + errorMsg, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function removerCertificado() {
            if (!confirm('Deseja realmente remover o certificado?')) return;
            
            try {
                showLoading(true);
                const configData = {
                    certificado_digital: null,
                    senha_certificado: null,
                    certificado_validade: null
                };
                
                await updateEmpresaConfig(configData);
                
                document.getElementById('certificado_input').value = '';
                document.getElementById('certificado_senha').value = '';
                document.getElementById('certificado-info').innerHTML = '';
                
                showToast('Certificado removido com sucesso', 'success');
            } catch (error) {
                console.error('Erro ao remover certificado:', error);
                showToast('Erro ao remover certificado: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Fun√ß√£o para alternar visibilidade de senhas
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Sincronizar color pickers com inputs de texto
        document.addEventListener('DOMContentLoaded', () => {
            const corPrimariaPicker = document.getElementById('cor_primaria_picker');
            const corPrimariaInput = document.getElementById('cor_primaria');
            const corSecundariaPicker = document.getElementById('cor_secundaria_picker');
            const corSecundariaInput = document.getElementById('cor_secundaria');

            if (corPrimariaPicker && corPrimariaInput) {
                corPrimariaPicker.addEventListener('input', (e) => {
                    corPrimariaInput.value = e.target.value;
                });
                corPrimariaInput.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        corPrimariaPicker.value = e.target.value;
                    }
                });
            }

            if (corSecundariaPicker && corSecundariaInput) {
                corSecundariaPicker.addEventListener('input', (e) => {
                    corSecundariaInput.value = e.target.value;
                });
                corSecundariaInput.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        corSecundariaPicker.value = e.target.value;
                    }
                });
            }
        });
    </script>
</body>
</html>
