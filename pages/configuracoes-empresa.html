<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes da Empresa - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-building mr-3 text-purple-600"></i>Configura√ß√µes da Empresa
                </h2>
                <p class="text-gray-600 mt-1">Gerencie as informa√ß√µes e identidade visual da empresa</p>
            </div>

            <form id="form-empresa" class="space-y-6">
                <!-- Logo da Empresa -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Logo da Empresa</h3>
                    
                    <div class="flex items-center space-x-6">
                        <div class="flex-shrink-0">
                            <div id="logo-preview" class="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload de Logo</label>
                            <input type="file" id="logo-input" accept="image/*" class="hidden">
                            <div class="flex space-x-3">
                                <button type="button" onclick="document.getElementById('logo-input').click()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    üì§ Escolher Imagem
                                </button>
                                <button type="button" id="btn-remove-logo" onclick="removerLogo()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">PNG, JPG ou GIF. M√°ximo 2MB.</p>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes B√°sicas -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes B√°sicas</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Fantasia *</label>
                            <input type="text" id="nome_empresa" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Raz√£o Social</label>
                            <input type="text" id="razao_social" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                            <input type="text" id="cnpj" placeholder="00.000.000/0000-00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                            <input type="tel" id="telefone" placeholder="(00) 0000-0000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                            <input type="url" id="website" placeholder="https://" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Endere√ßo</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo Completo</label>
                            <input type="text" id="endereco" placeholder="Rua, n√∫mero, complemento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                            <input type="text" id="cidade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                                <select id="estado" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Selecione</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CEP</label>
                                <input type="text" id="cep" placeholder="00000-000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dados Fiscais da Empresa -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üìã Dados Fiscais</h3>
                    <p class="text-sm text-gray-600 mb-4">Informa√ß√µes fiscais obrigat√≥rias para emiss√£o de NFC-e/NF-e</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Inscri√ß√£o Estadual *</label>
                            <input type="text" id="inscricao_estadual" placeholder="000.000.000.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Inscri√ß√£o Municipal</label>
                            <input type="text" id="inscricao_municipal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Regime Tribut√°rio *</label>
                            <select id="regime_tributario" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="1">1 - Simples Nacional</option>
                                <option value="2">2 - Simples Nacional (Excesso)</option>
                                <option value="3">3 - Regime Normal</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CNAE Principal</label>
                            <input type="text" id="cnae" placeholder="4723700" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo Munic√≠pio (IBGE)</label>
                            <input type="text" id="codigo_municipio" placeholder="3550308" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">C√≥digo IBGE de 7 d√≠gitos</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero (Endere√ßo)</label>
                            <input type="text" id="endereco_numero" placeholder="123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                            <input type="text" id="bairro" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Logradouro</label>
                            <input type="text" id="logradouro" placeholder="Rua, Avenida, etc." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Focus NFe API -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üßæ Integra√ß√£o Focus NFe</h3>
                    <p class="text-sm text-gray-600 mb-4">Configura√ß√µes para emiss√£o de NFC-e e NF-e via Focus NFe</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ambiente *</label>
                            <select id="nfe_ambiente" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2">2 - Homologa√ß√£o (Testes)</option>
                                <option value="1">1 - Produ√ß√£o</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <div id="nfe-status" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-600">
                                <i class="fas fa-circle text-gray-400 mr-2"></i> N√£o configurado
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Token de API Focus NFe *</label>
                            <div class="flex gap-2">
                                <input type="password" id="nfe_token" placeholder="Seu token da API Focus NFe" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button type="button" onclick="testarConexaoNFe()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    <i class="fas fa-plug mr-2"></i>Testar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Obtenha em: <a href="https://focusnfe.com.br" target="_blank" class="text-blue-600 underline">focusnfe.com.br</a></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S√©rie NFC-e</label>
                            <input type="number" id="nfce_serie" value="1" min="1" max="999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S√©rie NF-e</label>
                            <input type="number" id="nfe_serie" value="1" min="1" max="999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pr√≥ximo N√∫mero NFC-e</label>
                            <input type="number" id="nfce_numero" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pr√≥ximo N√∫mero NF-e</label>
                            <input type="number" id="nfe_numero" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Certificado Digital -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">üîê Certificado Digital A1</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo do Certificado (.pfx)</label>
                                <input type="file" id="certificado_input" accept=".pfx,.p12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha do Certificado</label>
                                <input type="password" id="certificado_senha" placeholder="Senha do .pfx" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <div class="md:col-span-2">
                                <div id="certificado-info" class="p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-2"></i> Nenhum certificado carregado
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="button" onclick="enviarCertificado()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-upload mr-2"></i>Enviar Certificado para Focus NFe
                            </button>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h4 class="text-sm font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Importante:</h4>
                        <ul class="text-sm text-yellow-800 space-y-1">
                            <li>‚Ä¢ Use ambiente de <strong>Homologa√ß√£o</strong> para testes</li>
                            <li>‚Ä¢ O certificado A1 deve estar v√°lido (verifique a data de expira√ß√£o)</li>
                            <li>‚Ä¢ O certificado √© enviado e armazenado no Focus NFe, n√£o neste sistema</li>
                            <li>‚Ä¢ Consulte seu contador para os dados fiscais corretos</li>
                        </ul>
                    </div>
                </div>

                <!-- Configura√ß√µes PDV -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üñ•Ô∏è Configura√ß√µes do PDV</h3>
                    <p class="text-sm text-gray-600 mb-4">Op√ß√µes para o Ponto de Venda</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_emitir_nfce" class="w-4 h-4 text-blue-600 rounded">
                            <label for="pdv_emitir_nfce" class="text-sm font-medium text-gray-700">Emitir NFC-e automaticamente nas vendas</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_imprimir_cupom" checked class="w-4 h-4 text-blue-600 rounded">
                            <label for="pdv_imprimir_cupom" class="text-sm font-medium text-gray-700">Imprimir cupom ap√≥s venda</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_permitir_venda_zerado" class="w-4 h-4 text-blue-600 rounded">
                            <label for="pdv_permitir_venda_zerado" class="text-sm font-medium text-gray-700">Permitir venda com estoque zerado</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="pdv_desconto_maximo" class="w-4 h-4 text-blue-600 rounded">
                            <label for="pdv_desconto_maximo" class="text-sm font-medium text-gray-700">Limitar desconto m√°ximo</label>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Desconto M√°ximo (%)</label>
                            <input type="number" id="pdv_desconto_limite" value="10" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem no Cupom</label>
                            <input type="text" id="pdv_mensagem_cupom" placeholder="Obrigado pela prefer√™ncia!" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- WhatsApp API -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">üîå Integra√ß√£o WhatsApp API</h3>
                    <p class="text-sm text-gray-600 mb-4">Configure para envio autom√°tico de PDFs via WhatsApp</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Provedor da API</label>
                            <select id="whatsapp_api_provider" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">N√£o configurado</option>
                                <option value="evolution">Evolution API</option>
                                <option value="twilio">Twilio</option>
                                <option value="baileys">Baileys</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Origem (com DDI)</label>
                            <input type="text" id="whatsapp_numero_origem" placeholder="5511999999999" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Formato: 55 + DDD + n√∫mero (sem espa√ßos ou caracteres)</p>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL da API</label>
                            <input type="url" id="whatsapp_api_url" placeholder="https://api.exemplo.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">API Key / Token</label>
                            <input type="password" id="whatsapp_api_key" placeholder="Seu token de API" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID da Inst√¢ncia (Evolution API)</label>
                            <input type="text" id="whatsapp_instance_id" placeholder="nome-da-instancia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="text-sm font-semibold text-blue-900 mb-2">üìò APIs Recomendadas:</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li><strong>Evolution API</strong> - <a href="https://evolution-api.com" target="_blank" class="underline">evolution-api.com</a> (Gratuita, auto-hospedada)</li>
                            <li><strong>Twilio</strong> - <a href="https://www.twilio.com/whatsapp" target="_blank" class="underline">twilio.com/whatsapp</a> (Paga, oficial)</li>
                        </ul>
                    </div>
                </div>

                <!-- Bot√µes -->
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="window.location.href='/pages/dashboard.html'" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        üíæ Salvar Configura√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-700">Salvando...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/services/empresa.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    
    <script>
        let logoAtual = null;
        let logoFile = null;

        (async () => {
            await checkAuth();
            
            // Verificar se √© ADMIN
            const user = await getCurrentUser();
            if (user.role !== 'ADMIN') {
                showToast('Acesso negado. Apenas administradores podem acessar esta p√°gina.', 'error');
                setTimeout(() => window.location.href = '/pages/dashboard.html', 2000);
                return;
            }

            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();
            await loadEmpresaConfig();
        })();

        // M√°scara para CNPJ
        document.getElementById('cnpj').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                e.target.value = value;
            }
        });

        // M√°scara para CEP
        document.getElementById('cep').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/^(\d{5})(\d)/, '$1-$2');
                e.target.value = value;
            }
        });

        // M√°scara para Telefone
        document.getElementById('telefone').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                } else {
                    value = value.replace(/^(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            }
        });

        // Preview da logo
        document.getElementById('logo-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showToast('Apenas imagens s√£o permitidas', 'error');
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    showToast('A imagem deve ter no m√°ximo 2MB', 'error');
                    return;
                }

                logoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('logo-preview').innerHTML = `
                        <img src="${e.target.result}" alt="Logo" class="w-full h-full object-contain">
                    `;
                    document.getElementById('btn-remove-logo').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        function removerLogo() {
            logoFile = null;
            logoAtual = null;
            document.getElementById('logo-input').value = '';
            document.getElementById('logo-preview').innerHTML = `
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            `;
            document.getElementById('btn-remove-logo').classList.add('hidden');
        }

        async function loadEmpresaConfig() {
            try {
                const config = await getEmpresaConfig();
                if (config) {
                    document.getElementById('nome_empresa').value = config.nome_empresa || '';
                    document.getElementById('razao_social').value = config.razao_social || '';
                    document.getElementById('cnpj').value = config.cnpj || '';
                    document.getElementById('telefone').value = config.telefone || '';
                    document.getElementById('email').value = config.email || '';
                    document.getElementById('website').value = config.website || '';
                    document.getElementById('endereco').value = config.endereco || '';
                    document.getElementById('cidade').value = config.cidade || '';
                    document.getElementById('estado').value = config.estado || '';
                    document.getElementById('cep').value = config.cep || '';
                    
                    // Dados Fiscais
                    document.getElementById('inscricao_estadual').value = config.inscricao_estadual || '';
                    document.getElementById('inscricao_municipal').value = config.inscricao_municipal || '';
                    document.getElementById('regime_tributario').value = config.regime_tributario || '1';
                    document.getElementById('cnae').value = config.cnae || '';
                    document.getElementById('codigo_municipio').value = config.codigo_municipio || '';
                    document.getElementById('endereco_numero').value = config.endereco_numero || '';
                    document.getElementById('bairro').value = config.bairro || '';
                    document.getElementById('logradouro').value = config.logradouro || '';
                    
                    // Focus NFe
                    document.getElementById('nfe_ambiente').value = config.nfe_ambiente || '2';
                    document.getElementById('nfe_token').value = config.nfe_token || '';
                    document.getElementById('nfce_serie').value = config.nfce_serie || 1;
                    document.getElementById('nfe_serie').value = config.nfe_serie || 1;
                    document.getElementById('nfce_numero').value = config.nfce_numero || 1;
                    document.getElementById('nfe_numero').value = config.nfe_numero || 1;
                    
                    // PDV
                    document.getElementById('pdv_emitir_nfce').checked = config.pdv_emitir_nfce || false;
                    document.getElementById('pdv_imprimir_cupom').checked = config.pdv_imprimir_cupom !== false;
                    document.getElementById('pdv_permitir_venda_zerado').checked = config.pdv_permitir_venda_zerado || false;
                    document.getElementById('pdv_desconto_maximo').checked = config.pdv_desconto_maximo || false;
                    document.getElementById('pdv_desconto_limite').value = config.pdv_desconto_limite || 10;
                    document.getElementById('pdv_mensagem_cupom').value = config.pdv_mensagem_cupom || '';
                    
                    // Configura√ß√µes WhatsApp API
                    document.getElementById('whatsapp_api_provider').value = config.whatsapp_api_provider || '';
                    document.getElementById('whatsapp_numero_origem').value = config.whatsapp_numero_origem || '';
                    document.getElementById('whatsapp_api_url').value = config.whatsapp_api_url || '';
                    document.getElementById('whatsapp_api_key').value = config.whatsapp_api_key || '';
                    document.getElementById('whatsapp_instance_id').value = config.whatsapp_instance_id || '';

                    if (config.logo_url) {
                        logoAtual = config.logo_url;
                        document.getElementById('logo-preview').innerHTML = `
                            <img src="${config.logo_url}" alt="Logo" class="w-full h-full object-contain">
                        `;
                        document.getElementById('btn-remove-logo').classList.remove('hidden');
                    }
                    
                    // Atualizar status NFe
                    atualizarStatusNFe(config);
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }
        
        function atualizarStatusNFe(config) {
            const statusEl = document.getElementById('nfe-status');
            if (config.nfe_token) {
                statusEl.innerHTML = '<i class="fas fa-circle text-green-500 mr-2"></i> Configurado';
                statusEl.className = 'px-4 py-2 bg-green-100 rounded-lg text-green-800';
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle text-gray-400 mr-2"></i> N√£o configurado';
                statusEl.className = 'px-4 py-2 bg-gray-100 rounded-lg text-gray-600';
            }
        }
        
        async function testarConexaoNFe() {
            const token = document.getElementById('nfe_token').value;
            if (!token) {
                showToast('Informe o token da API', 'error');
                return;
            }
            
            try {
                showLoading(true);
                // Testar conex√£o com Focus NFe
                const ambiente = document.getElementById('nfe_ambiente').value;
                const baseUrl = ambiente === '1' 
                    ? 'https://api.focusnfe.com.br' 
                    : 'https://homologacao.focusnfe.com.br';
                
                const response = await fetch(`${baseUrl}/v2/nfce?ref=teste`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic ' + btoa(token + ':')
                    }
                });
                
                if (response.status === 401) {
                    showToast('Token inv√°lido', 'error');
                } else if (response.ok || response.status === 404) {
                    showToast('Conex√£o OK! Token v√°lido.', 'success');
                    document.getElementById('nfe-status').innerHTML = '<i class="fas fa-circle text-green-500 mr-2"></i> Conectado';
                    document.getElementById('nfe-status').className = 'px-4 py-2 bg-green-100 rounded-lg text-green-800';
                } else {
                    showToast('Erro na conex√£o: ' + response.status, 'error');
                }
            } catch (error) {
                showToast('Erro ao conectar: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function enviarCertificado() {
            const token = document.getElementById('nfe_token').value;
            const arquivo = document.getElementById('certificado_input').files[0];
            const senha = document.getElementById('certificado_senha').value;
            
            if (!token) {
                showToast('Configure o token da API primeiro', 'error');
                return;
            }
            if (!arquivo) {
                showToast('Selecione o arquivo do certificado', 'error');
                return;
            }
            if (!senha) {
                showToast('Informe a senha do certificado', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                const ambiente = document.getElementById('nfe_ambiente').value;
                const baseUrl = ambiente === '1' 
                    ? 'https://api.focusnfe.com.br' 
                    : 'https://homologacao.focusnfe.com.br';
                
                // Converter arquivo para base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(arquivo);
                });
                
                const response = await fetch(`${baseUrl}/v2/empresas/certificado`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(token + ':'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        arquivo_base64: base64,
                        senha: senha
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast('Certificado enviado com sucesso!', 'success');
                    document.getElementById('certificado-info').innerHTML = `
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Certificado v√°lido at√©: ${data.validade || 'N/A'}
                    `;
                    document.getElementById('certificado-info').className = 'p-4 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800';
                } else {
                    const erro = await response.json();
                    showToast('Erro: ' + (erro.mensagem || 'Falha ao enviar'), 'error');
                }
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        document.getElementById('form-empresa').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);

            try {
                let logoUrl = logoAtual;

                // Se houver nova logo, fazer upload
                if (logoFile) {
                    console.log('Fazendo upload da nova logo...');
                    // Deletar logo antiga se existir
                    if (logoAtual) {
                        console.log('Deletando logo antiga:', logoAtual);
                        await deleteLogo(logoAtual);
                    }
                    logoUrl = await uploadLogo(logoFile);
                    console.log('Logo enviada com sucesso:', logoUrl);
                } else if (!logoAtual) {
                    logoUrl = null;
                }

                const empresaData = {
                    nome_empresa: document.getElementById('nome_empresa').value,
                    razao_social: document.getElementById('razao_social').value || null,
                    cnpj: document.getElementById('cnpj').value || null,
                    telefone: document.getElementById('telefone').value || null,
                    email: document.getElementById('email').value || null,
                    website: document.getElementById('website').value || null,
                    endereco: document.getElementById('endereco').value || null,
                    cidade: document.getElementById('cidade').value || null,
                    estado: document.getElementById('estado').value || null,
                    cep: document.getElementById('cep').value || null,
                    logo_url: logoUrl,
                    // Dados Fiscais
                    inscricao_estadual: document.getElementById('inscricao_estadual').value || null,
                    inscricao_municipal: document.getElementById('inscricao_municipal').value || null,
                    regime_tributario: document.getElementById('regime_tributario').value || '1',
                    cnae: document.getElementById('cnae').value || null,
                    codigo_municipio: document.getElementById('codigo_municipio').value || null,
                    endereco_numero: document.getElementById('endereco_numero').value || null,
                    bairro: document.getElementById('bairro').value || null,
                    logradouro: document.getElementById('logradouro').value || null,
                    // Focus NFe
                    nfe_ambiente: document.getElementById('nfe_ambiente').value || '2',
                    nfe_token: document.getElementById('nfe_token').value || null,
                    nfce_serie: parseInt(document.getElementById('nfce_serie').value) || 1,
                    nfe_serie: parseInt(document.getElementById('nfe_serie').value) || 1,
                    nfce_numero: parseInt(document.getElementById('nfce_numero').value) || 1,
                    nfe_numero: parseInt(document.getElementById('nfe_numero').value) || 1,
                    // PDV
                    pdv_emitir_nfce: document.getElementById('pdv_emitir_nfce').checked,
                    pdv_imprimir_cupom: document.getElementById('pdv_imprimir_cupom').checked,
                    pdv_permitir_venda_zerado: document.getElementById('pdv_permitir_venda_zerado').checked,
                    pdv_desconto_maximo: document.getElementById('pdv_desconto_maximo').checked,
                    pdv_desconto_limite: parseFloat(document.getElementById('pdv_desconto_limite').value) || 10,
                    pdv_mensagem_cupom: document.getElementById('pdv_mensagem_cupom').value || null,
                    // WhatsApp
                    whatsapp_api_provider: document.getElementById('whatsapp_api_provider').value || null,
                    whatsapp_numero_origem: document.getElementById('whatsapp_numero_origem').value || null,
                    whatsapp_api_url: document.getElementById('whatsapp_api_url').value || null,
                    whatsapp_api_key: document.getElementById('whatsapp_api_key').value || null,
                    whatsapp_instance_id: document.getElementById('whatsapp_instance_id').value || null
                };

                console.log('Salvando configura√ß√µes:', empresaData);
                const result = await updateEmpresaConfig(empresaData);
                console.log('Configura√ß√µes salvas:', result);
                
                showToast('Configura√ß√µes salvas com sucesso!', 'success');
                
                // Atualizar vari√°veis locais
                logoAtual = logoUrl;
                logoFile = null;
                
                // Recarregar para atualizar logo no navbar
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error('Erro completo:', error);
                handleError(error, 'Erro ao salvar configura√ß√µes');
            } finally {
                showLoading(false);
            }
        });
    </script>
</body>
</html>
