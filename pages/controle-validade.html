<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Validade - Sistema Distribuidora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .row-vencido { background-color: #fee2e2; }
        .row-critico { background-color: #fef3c7; }
        .row-alerta { background-color: #dbeafe; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-calendar-times mr-4 text-red-600"></i>Controle de Validade
                        </h1>
                        <p class="text-gray-600 mt-2">Monitore produtos próximos ao vencimento</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="carregarDados()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-redo"></i> Atualizar
                        </button>
                        <button onclick="abrirModalAdicionarLote()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:shadow-lg transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> Adicionar Lote
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cards de Resumo -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-red-500 cursor-pointer hover:shadow-xl transition" onclick="filtrarPorUrgencia('vencido')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h6 class="text-gray-600 text-sm font-medium mb-2">Produtos Vencidos</h6>
                            <h2 class="text-4xl font-bold text-red-600" id="count-vencidos">0</h2>
                        </div>
                        <div class="text-red-500">
                            <i class="fas fa-exclamation-triangle text-5xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-orange-500 cursor-pointer hover:shadow-xl transition" onclick="filtrarPorUrgencia('critico')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h6 class="text-gray-600 text-sm font-medium mb-2">Críticos (≤7 dias)</h6>
                            <h2 class="text-4xl font-bold text-orange-600" id="count-criticos">0</h2>
                        </div>
                        <div class="text-orange-500">
                            <i class="fas fa-exclamation-circle text-5xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-yellow-500 cursor-pointer hover:shadow-xl transition" onclick="filtrarPorUrgencia('alerta')">
                    <div class="flex justify-between items-center">
                        <div>
                            <h6 class="text-gray-600 text-sm font-medium mb-2">Alertas (≤30 dias)</h6>
                            <h2 class="text-4xl font-bold text-yellow-600" id="count-alertas">0</h2>
                        </div>
                        <div class="text-yellow-500">
                            <i class="fas fa-info-circle text-5xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Produto</label>
                        <input type="text" id="filtro-produto" placeholder="Nome ou código" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Urgência</label>
                        <select id="filtro-urgencia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas</option>
                            <option value="vencido">Vencidos</option>
                            <option value="critico">Críticos</option>
                            <option value="alerta">Alertas</option>
                            <option value="normal">Normal</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="filtro-categoria" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dias</label>
                        <input type="number" id="filtro-dias" value="30" min="1" max="365" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="aplicarFiltros()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Lotes -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fabricação</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dias Restantes</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-vencimentos" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Carregando...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Adicionar Lote -->
    <div id="modalAdicionarLote" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Adicionar Lote</h3>
                <button onclick="fecharModalAdicionarLote()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-adicionar-lote" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Produto *</label>
                    <select id="lote-produto" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número do Lote *</label>
                    <input type="text" id="lote-numero" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade *</label>
                    <input type="number" id="lote-quantidade" min="0.01" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Fabricação</label>
                    <input type="date" id="lote-fabricacao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                    <input type="date" id="lote-vencimento" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </form>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="fecharModalAdicionarLote()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button onclick="salvarLote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Salvar Lote
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Detalhes do Lote -->
    <div id="modalDetalhesLote" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Detalhes do Lote</h3>
                <button onclick="fecharModalDetalhesLote()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detalhes-lote-content" class="space-y-3">
                <!-- Conteúdo dinâmico -->
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="fecharModalDetalhesLote()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../js/services/vencimentos.js"></script>
    
    <script>
        let todosLotes = [];
        let lotesFiltrados = [];

        // Inicializar página
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await checkAuth();
                
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
                await initNavbar();
                await initSidebar();
                
                await carregarDados();
                await carregarProdutosSelect();
                await carregarCategoriasSelect();
                
                setInterval(() => carregarDados(), 5 * 60 * 1000);
            } catch (error) {
                console.error('Erro ao inicializar controle de validade:', error);
                window.location.href = '/index.html';
            }
        });

        async function carregarDados() {
            try {
                const dias = parseInt(document.getElementById('filtro-dias')?.value || 30);
                todosLotes = await ServicoVencimentoService.buscarProdutosProximosVencimento(dias);
                lotesFiltrados = [...todosLotes];
                
                const contagem = await ServicoVencimentoService.contarPorUrgencia();
                document.getElementById('count-vencidos').textContent = contagem.vencidos;
                document.getElementById('count-criticos').textContent = contagem.criticos;
                document.getElementById('count-alertas').textContent = contagem.alertas;
                
                renderizarTabela(lotesFiltrados);
            } catch (erro) {
                console.error('Erro ao carregar dados:', erro);
                alert('Erro ao carregar dados de vencimento');
            }
        }

        function renderizarTabela(lotes) {
            const tbody = document.getElementById('tabela-vencimentos');
            
            if (lotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Nenhum produto encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = lotes.map(lote => {
                const produto = lote.produto;
                const categoria = produto?.categorias?.nome || 'Sem categoria';
                const rowClass = lote.urgencia === 'vencido' ? 'row-vencido' : 
                                 lote.urgencia === 'critico' ? 'row-critico' : 
                                 lote.urgencia === 'alerta' ? 'row-alerta' : '';
                
                const badgeColors = {
                    'vencido': 'bg-red-600 text-white',
                    'critico': 'bg-orange-500 text-white',
                    'alerta': 'bg-yellow-400 text-gray-800',
                    'normal': 'bg-green-500 text-white'
                };
                
                const badgeClass = badgeColors[lote.urgencia] || 'bg-gray-500 text-white';
                const textoUrgencia = ServicoVencimentoService.obterTextoUrgencia(lote.urgencia, lote.diasRestantes);
                
                return `
                    <tr class="${rowClass} hover:bg-gray-100 cursor-pointer transition" onclick="abrirDetalhesLote(${lote.id})">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${produto.codigo_produto || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${produto.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${categoria}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-500 text-white">${lote.numero_lote}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lote.quantidade_atual.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatarData(lote.data_fabricacao)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatarData(lote.data_vencimento)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                            ${lote.diasRestantes >= 0 ? lote.diasRestantes : Math.abs(lote.diasRestantes)} dias
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${badgeClass}">${textoUrgencia}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="event.stopPropagation(); abrirDetalhesLote(${lote.id})" class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function aplicarFiltros() {
            const dias = parseInt(document.getElementById('filtro-dias').value);
            await carregarDados();
            
            const filtroProduto = document.getElementById('filtro-produto').value.toLowerCase();
            const filtroUrgencia = document.getElementById('filtro-urgencia').value;
            const filtroCategoria = document.getElementById('filtro-categoria').value;

            lotesFiltrados = todosLotes.filter(lote => {
                const matchProduto = !filtroProduto || 
                    lote.produto.nome.toLowerCase().includes(filtroProduto) ||
                    lote.produto.codigo_produto?.toLowerCase().includes(filtroProduto);
                
                const matchUrgencia = !filtroUrgencia || lote.urgencia === filtroUrgencia;
                const matchCategoria = !filtroCategoria || lote.produto.categoria_id == filtroCategoria;

                return matchProduto && matchUrgencia && matchCategoria;
            });

            renderizarTabela(lotesFiltrados);
        }

        function filtrarPorUrgencia(urgencia) {
            document.getElementById('filtro-urgencia').value = urgencia;
            aplicarFiltros();
        }

        async function carregarProdutosSelect() {
            const { data: produtos } = await supabase
                .from('produtos')
                .select('id, nome, codigo_produto')
                .eq('ativo', true)
                .order('nome');

            const select = document.getElementById('lote-produto');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                produtos.map(p => `<option value="${p.id}">${p.codigo_produto || ''} - ${p.nome}</option>`).join('');
        }

        async function carregarCategoriasSelect() {
            const { data: categorias } = await supabase
                .from('categorias')
                .select('id, nome')
                .order('nome');

            const select = document.getElementById('filtro-categoria');
            select.innerHTML += categorias.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
        }

        function abrirModalAdicionarLote() {
            document.getElementById('modalAdicionarLote').classList.remove('hidden');
        }

        function fecharModalAdicionarLote() {
            document.getElementById('modalAdicionarLote').classList.add('hidden');
            document.getElementById('form-adicionar-lote').reset();
        }

        async function salvarLote() {
            try {
                const dadosLote = {
                    produto_id: document.getElementById('lote-produto').value,
                    numero_lote: document.getElementById('lote-numero').value,
                    quantidade_inicial: parseFloat(document.getElementById('lote-quantidade').value),
                    data_fabricacao: document.getElementById('lote-fabricacao').value || null,
                    data_vencimento: document.getElementById('lote-vencimento').value
                };

                if (!dadosLote.produto_id || !dadosLote.numero_lote || !dadosLote.data_vencimento) {
                    alert('Preencha os campos obrigatórios');
                    return;
                }

                await ServicoVencimentoService.adicionarLote(dadosLote);
                fecharModalAdicionarLote();
                await carregarDados();
                
                const sucesso = document.createElement('div');
                sucesso.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                sucesso.innerHTML = `
                    <div class="bg-white p-8 rounded-lg max-w-md text-center">
                        <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2">Lote Adicionado!</h3>
                        <p class="text-gray-600 mb-6">O lote foi registrado com sucesso</p>
                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                            OK
                        </button>
                    </div>
                `;
                document.body.appendChild(sucesso);
                setTimeout(() => sucesso.remove(), 3000);
            } catch (erro) {
                console.error('Erro ao salvar lote:', erro);
                alert('Erro ao salvar lote: ' + erro.message);
            }
        }

        async function abrirDetalhesLote(loteId) {
            const lote = todosLotes.find(l => l.id === loteId);
            if (!lote) return;

            const produto = lote.produto;
            
            const badgeColors = {
                'vencido': 'bg-red-600 text-white',
                'critico': 'bg-orange-500 text-white',
                'alerta': 'bg-yellow-400 text-gray-800',
                'normal': 'bg-green-500 text-white'
            };
            
            const badgeClass = badgeColors[lote.urgencia] || 'bg-gray-500 text-white';
            
            const html = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <p class="text-sm text-gray-600">Produto</p>
                        <p class="text-lg font-bold text-gray-900">${produto.nome}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Código</p>
                        <p class="font-medium">${produto.codigo_produto || '-'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Lote</p>
                        <p><span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-500 text-white">${lote.numero_lote}</span></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Quantidade</p>
                        <p class="font-medium">${lote.quantidade_atual.toFixed(2)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Quantidade Inicial</p>
                        <p class="font-medium">${lote.quantidade_inicial.toFixed(2)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fabricação</p>
                        <p class="font-medium">${formatarData(lote.data_fabricacao)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Vencimento</p>
                        <p class="font-medium">${formatarData(lote.data_vencimento)}</p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-sm text-gray-600 mb-2">Status</p>
                        <span class="px-4 py-2 text-sm font-semibold rounded-full ${badgeClass}">
                            ${ServicoVencimentoService.obterTextoUrgencia(lote.urgencia, lote.diasRestantes)}
                        </span>
                    </div>
                </div>
            `;

            document.getElementById('detalhes-lote-content').innerHTML = html;
            document.getElementById('modalDetalhesLote').classList.remove('hidden');
        }

        function fecharModalDetalhesLote() {
            document.getElementById('modalDetalhesLote').classList.add('hidden');
        }

        function formatarData(data) {
            if (!data) return '-';
            return new Date(data).toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>
