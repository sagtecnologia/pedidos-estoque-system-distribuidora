<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-shopping-cart mr-3 text-green-600"></i>Vendas
                    </h2>
                    <p class="text-gray-600 mt-1">Gerenciamento de vendas</p>
                </div>
                <button onclick="novaVenda()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                    + Nova Venda
                </button>
            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-8 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filter-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadVendas()">
                            <option value="">Todos os status</option>
                            <option value="RASCUNHO">Rascunho</option>
                            <option value="ENVIADO">Enviado</option>
                            <option value="APROVADO">Aprovado</option>
                            <option value="REJEITADO">Rejeitado</option>
                            <option value="FINALIZADO">Finalizado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="filter-cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadVendas()">
                            <option value="">Todos os clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="filter-categoria" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadVendas()">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marca</label>
                        <select id="filter-marca" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadVendas()">
                            <option value="">Todas as marcas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero</label>
                        <input type="text" id="search" placeholder="Buscar n√∫mero..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" onkeyup="loadVendas()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio</label>
                        <input type="datetime-local" id="filter-data-inicio" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadVendas()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                        <input type="datetime-local" id="filter-data-fim" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadVendas()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="limparFiltros()" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Limpar</button>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">N√∫mero</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendedor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="vendas-tbody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>
                        </tbody>
                        <tfoot id="vendas-tfoot" class="bg-gray-50 border-t-2 border-gray-300">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-sm font-semibold text-gray-900 text-right">TOTAL:</td>
                                <td class="px-6 py-4 text-sm font-bold text-gray-900" id="total-quantidade">0</td>
                                <td class="px-6 py-4 text-sm font-bold text-gray-900" id="total-valor">R$ 0,00</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Nova Venda -->
    <div id="modal-nova-venda" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Nova Venda</h3>
                <button onclick="closeModal('modal-nova-venda')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="form-nova-venda" class="px-6 py-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente*</label>
                        <select id="venda-cliente" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Selecione um cliente...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                        <textarea id="venda-observacoes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Informa√ß√µes sobre a entrega, forma de pagamento, etc..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('modal-nova-venda')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Criar Venda</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-700">Carregando...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/services/servico-fiscal.js"></script>
    <script src="../js/services/focus-nfe.js"></script>
    <script src="../js/services/nuvem-fiscal.js"></script>
    <script src="../js/services/fiscal.js"></script>
    <script src="../js/services/pedidos.js"></script>
    <script src="../js/services/clientes.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../components/modal.js"></script>
    
    <script>
        let currentUser = null;

        (async () => {
            try {
                await checkAuth();
                currentUser = await getCurrentUser();
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
                await initNavbar();
                await initSidebar();
            } catch (error) {
                console.error('Erro ao inicializar vendas:', error);
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
            }
            
            // Definir data padr√£o (dia atual) em formato datetime-local YYYY-MM-DDTHH:mm
            const hoje = new Date();
            const hojeInicio = new Date(hoje);
            const hojeFim = new Date(hoje);
            hojeInicio.setHours(0, 0, 0, 0);   // 00:00 do dia de hoje
            hojeFim.setHours(23, 59, 0, 0);     // 23:59 do dia de hoje
            
            // Formatar para datetime-local com timezone Bras√≠lia
            const formatarDateTimeLocal = (d) => {
                const formatter = new Intl.DateTimeFormat('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'America/Sao_Paulo',
                    hour12: false
                });
                const parts = formatter.formatToParts(d);
                const year = parts.find(p => p.type === 'year').value;
                const month = parts.find(p => p.type === 'month').value;
                const day = parts.find(p => p.type === 'day').value;
                const hour = parts.find(p => p.type === 'hour').value;
                const minute = parts.find(p => p.type === 'minute').value;
                return `${year}-${month}-${day}T${hour}:${minute}`;
            };
            
            document.getElementById('filter-data-inicio').value = formatarDateTimeLocal(hojeInicio);
            document.getElementById('filter-data-fim').value = formatarDateTimeLocal(hojeFim);
            
            await loadClientesSelect();
            await loadCategoriasSelect();
            await loadMarcasSelect();
            await loadVendas();
        })();

        // Carregar clientes no select
        async function loadClientesSelect() {
            try {
                showLoading(true);
                const clientes = await getClientes();
                
                // Select do modal
                const select = document.getElementById('venda-cliente');
                select.innerHTML = '<option value="">Selecione um cliente...</option>';
                clientes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.nome}${c.cpf_cnpj ? ' - ' + c.cpf_cnpj : ''}`;
                    select.appendChild(option);
                });
                
                // Select do filtro
                const filterSelect = document.getElementById('filter-cliente');
                filterSelect.innerHTML = '<option value="">Todos os clientes</option>';
                clientes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.nome;
                    filterSelect.appendChild(option);
                });
            } finally {
                showLoading(false);
            }
        }

        // Carregar categorias no select
        async function loadCategoriasSelect() {
            try {
                const { data: categorias } = await supabase
                    .from('categorias')
                    .select('id, nome')
                    .order('nome');
                
                const select = document.getElementById('filter-categoria');
                select.innerHTML = '<option value="">Todas as categorias</option>';
                (categorias || []).forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carregar marcas no select
        async function loadMarcasSelect() {
            try {
                const { data: marcas } = await supabase
                    .from('marcas')
                    .select('id, nome')
                    .order('nome');
                
                const select = document.getElementById('filter-marca');
                select.innerHTML = '<option value="">Todas as marcas</option>';
                (marcas || []).forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.textContent = m.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar marcas:', error);
            }
        }

        // Carregar vendas
        async function loadVendas() {
            const status = document.getElementById('filter-status').value;
            const search = document.getElementById('search').value;
            const clienteId = document.getElementById('filter-cliente').value;
            const categoriaId = document.getElementById('filter-categoria').value;
            const marcaId = document.getElementById('filter-marca').value;
            const dataInicio = document.getElementById('filter-data-inicio').value;
            const dataFim = document.getElementById('filter-data-fim').value;
            
            showLoading(true);
            
            try {
                // 1Ô∏è‚É£ Carregar todas as vendas com filtros
                let query = supabase
                    .from('vendas')
                    .select('*');
                
                if (status) {
                    query = query.eq('status', status);
                }
                
                if (clienteId) {
                    query = query.eq('cliente_id', clienteId);
                }
                
                if (search) {
                    query = query.ilike('numero', `%${search}%`);
                }
                
                if (dataInicio) {
                    // Converter datetime-local para ISO (Supabase espera ISO 8601)
                    const dataInicioObj = new Date(dataInicio);
                    query = query.gte('created_at', dataInicioObj.toISOString());
                }
                
                if (dataFim) {
                    // Converter datetime-local para ISO e adicionar at√© o final do minuto
                    const dataFimObj = new Date(dataFim);
                    dataFimObj.setSeconds(59);
                    query = query.lte('created_at', dataFimObj.toISOString());
                }
                
                let { data: vendas, error } = await query.order('created_at', { ascending: false }).limit(500);
                
                if (error) throw error;
                
                if (!vendas || vendas.length === 0) {
                    renderVendas([]);
                    return;
                }
                
                console.log(`üìä Vendas carregadas: ${vendas.length}`);
                
                // 2Ô∏è‚É£ Se houver filtros de categoria ou marca, fazer filtragem por produtos
                if (categoriaId || marcaId) {
                    const vendaIds = vendas.map(v => v.id);
                    
                    // Buscar todos os itens destas vendas
                    const { data: todosItens } = await supabase
                        .from('venda_itens')
                        .select('venda_id, produto_id')
                        .in('venda_id', vendaIds);
                    
                    if (!todosItens || todosItens.length === 0) {
                        renderVendas([]);
                        return;
                    }
                    
                    const produtoIds = [...new Set(todosItens.map(i => i.produto_id).filter(Boolean))];
                    
                    // Buscar produtos com categoria e marca
                    let produtosQuery = supabase
                        .from('produtos')
                        .select('id, categoria_id, marca_id');
                    
                    if (produtoIds.length > 0) {
                        produtosQuery = produtosQuery.in('id', produtoIds);
                    }
                    
                    const { data: produtos } = await produtosQuery;
                    
                    // Filtrar produtos por categoria e marca
                    const produtosValidos = new Set();
                    (produtos || []).forEach(p => {
                        const passaCategoriaFiltro = !categoriaId || p.categoria_id === parseInt(categoriaId);
                        const passaMarcaFiltro = !marcaId || p.marca_id === parseInt(marcaId);
                        
                        if (passaCategoriaFiltro && passaMarcaFiltro) {
                            produtosValidos.add(p.id);
                        }
                    });
                    
                    // Filtrar vendas que t√™m itens com produtos v√°lidos
                    const vendasComProdutosValidos = new Set();
                    (todosItens || []).forEach(item => {
                        if (produtosValidos.has(item.produto_id)) {
                            vendasComProdutosValidos.add(item.venda_id);
                        }
                    });
                    
                    // Manter s√≥ as vendas que t√™m produtos v√°lidos
                    vendas = vendas.filter(v => vendasComProdutosValidos.has(v.id));
                    
                    if (vendas.length === 0) {
                        renderVendas([]);
                        return;
                    }
                }
                
                // 3Ô∏è‚É£ Batch load clientes
                const clienteIds = [...new Set(vendas.map(v => v.cliente_id).filter(Boolean))];
                const { data: clientes } = clienteIds.length > 0 
                    ? await supabase
                        .from('clientes')
                        .select('id, nome')
                        .in('id', clienteIds)
                    : { data: [] };
                const clientesMap = Object.fromEntries((clientes || []).map(c => [c.id, c]));
                
                // 4Ô∏è‚É£ Batch load operadores (users)
                const vendedorIds = [...new Set(vendas.map(v => v.vendedor_id).filter(Boolean))];
                const { data: operadores } = vendedorIds.length > 0
                    ? await supabase
                        .from('users')
                        .select('id, full_name')
                        .in('id', vendedorIds)
                    : { data: [] };
                const operadoresMap = Object.fromEntries((operadores || []).map(o => [o.id, o]));
                
                // 5Ô∏è‚É£ Batch load venda_itens
                const vendaIds = vendas.map(v => v.id);
                const { data: itensVendas } = await supabase
                    .from('venda_itens')
                    .select('venda_id, quantidade')
                    .in('venda_id', vendaIds);
                
                // Agrupar itens por venda
                const itensMap = {};
                (itensVendas || []).forEach(item => {
                    if (!itensMap[item.venda_id]) {
                        itensMap[item.venda_id] = [];
                    }
                    itensMap[item.venda_id].push(item);
                });
                
                // 6Ô∏è‚É£ Montar relacionamentos em JavaScript
                vendas.forEach(venda => {
                    venda.cliente = clientesMap[venda.cliente_id] || null;
                    venda.operador = operadoresMap[venda.vendedor_id] || null;
                    venda.venda_itens = itensMap[venda.id] || [];
                });
                
                console.log(`‚úÖ Dados carregados e montados: ${vendas.length} vendas com relacionamentos`);
                renderVendas(vendas);
            } catch (error) {
                handleError(error, 'Erro ao carregar vendas');
            } finally {
                showLoading(false);
            }
        }
        
        // Limpar filtros
        function limparFiltros() {
            const hoje = new Date();
            const hojeInicio = new Date(hoje);
            const hojeFim = new Date(hoje);
            hojeInicio.setHours(0, 0, 0, 0);
            hojeFim.setHours(23, 59, 0, 0);

            const formatarDateTimeLocal = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };

            document.getElementById('filter-status').value = '';
            document.getElementById('filter-cliente').value = '';
            document.getElementById('filter-categoria').value = '';
            document.getElementById('filter-marca').value = '';
            document.getElementById('search').value = '';
            document.getElementById('filter-data-inicio').value = formatarDateTimeLocal(hojeInicio);
            document.getElementById('filter-data-fim').value = formatarDateTimeLocal(hojeFim);
            loadVendas();
        }

        // Renderizar vendas
        function renderVendas(vendas) {
            const tbody = document.getElementById('vendas-tbody');
            
            if (vendas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhuma venda encontrada</td></tr>';
                document.getElementById('total-quantidade').textContent = '0';
                document.getElementById('total-valor').textContent = 'R$ 0,00';
                return;
            }

            let somaQuantidade = 0;
            let somaValor = 0;

            tbody.innerHTML = vendas.map(venda => {
                // Calcular quantidade total de itens
                const quantidadeTotal = (venda.venda_itens || []).reduce((sum, item) => sum + (item.quantidade || 0), 0);
                
                // Verificar se tem nota fiscal emitida (usando nomes corretos dos campos)
                const temNotaFiscal = Boolean(
                    venda.numero_nfce || 
                    venda.chave_acesso_nfce || 
                    venda.status_fiscal === 'EMITIDA_NFCE'
                );
                const statusVenda = (venda.status || '').toUpperCase();
                const vendaFinalizada = statusVenda === 'FINALIZADA' || statusVenda === 'FINALIZADO';
                
                // Debug: Log dos dados fiscais - SEMPRE para vendas finalizadas
                if (vendaFinalizada) {
                    console.log(`[DEBUG] Venda ${venda.numero}:`, {
                        id: venda.id,
                        status: venda.status,
                        status_fiscal: venda.status_fiscal,
                        numero_nfce: venda.numero_nfce,
                        chave_acesso_nfce: venda.chave_acesso_nfce,
                        protocolo_nfce: venda.protocolo_nfce,
                        // Verifica√ß√µes individuais
                        'tem numero_nfce?': !!venda.numero_nfce,
                        'tem chave_acesso_nfce?': !!venda.chave_acesso_nfce,
                        'status_fiscal === EMITIDA_NFCE?': venda.status_fiscal === 'EMITIDA_NFCE',
                        temNotaFiscal: temNotaFiscal,
                        botaoQueDeveAparecer: temNotaFiscal ? 'IMPRIMIR' : 'GERAR'
                    });
                }
                
                // Acumular totais
                somaQuantidade += quantidadeTotal;
                somaValor += (venda.total || 0);
                
                // Badge de pagamento pendente
                let badgePagamento = '';
                if (venda.status === 'FINALIZADO' && (venda.pagamento_status === 'PENDENTE' || venda.pagamento_status === 'PARCIAL')) {
                    const icon = venda.pagamento_status === 'PARCIAL' ? 'fa-clock' : 'fa-exclamation-circle';
                    const color = venda.pagamento_status === 'PARCIAL' ? 'orange' : 'red';
                    badgePagamento = `<i class="fas ${icon} text-${color}-600 ml-2" title="Pagamento ${venda.pagamento_status === 'PARCIAL' ? 'Parcial' : 'Pendente'}: ${formatCurrency(venda.valor_pendente || 0)}"></i>`;
                }
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${venda.numero}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${venda.solicitante?.full_name || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${venda.cliente?.nome || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        ${quantidadeTotal}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">
                        ${formatCurrency(venda.total || 0)}${badgePagamento}
                    </td>
                    <td class="px-6 py-4">
                        ${getStatusBadge(venda.status)}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${formatDate(venda.created_at)}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex gap-2">
                            <a href="/pages/venda-detalhe.html?id=${venda.id}" class="text-blue-600 hover:text-blue-800" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </a>
                            ${vendaFinalizada ? (
                                temNotaFiscal ? `
                                    <button onclick="imprimirNotaFiscal('${venda.id}', '${venda.chave_acesso_nfce || ''}')" class="text-indigo-600 hover:text-indigo-800" title="Imprimir NFC-e">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button onclick="cancelarNotaFiscal('${venda.id}', '${venda.chave_acesso_nfce || ''}')" class="text-red-600 hover:text-red-800" title="Cancelar NFC-e">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                ` : `
                                    <button onclick="gerarNotaFiscal('${venda.id}')" class="text-green-600 hover:text-green-800" title="Gerar NFC-e">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                `
                            ) : ''}
                        </div>
                    </td>
                </tr>
            `;
            }).join('');

            // Atualizar totais no rodap√©
            document.getElementById('total-quantidade').textContent = somaQuantidade;
            document.getElementById('total-valor').textContent = formatCurrency(somaValor);
        }

        // Badge de status
        function getStatusBadge(status) {
            const badges = {
                'RASCUNHO': '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Rascunho</span>',
                'ENVIADO': '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Enviado</span>',
                'APROVADO': '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Aprovado</span>',
                'REJEITADO': '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Rejeitado</span>',
                'FINALIZADO': '<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">Finalizado</span>'
            };
            return badges[status] || status;
        }

        // Nova venda
        function novaVenda() {
            openModal('modal-nova-venda');
        }

        // Form nova venda
        document.getElementById('form-nova-venda').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                showLoading(true);
                const clienteId = document.getElementById('venda-cliente').value;
                const observacoes = document.getElementById('venda-observacoes').value || null;
                
                if (!clienteId) {
                    showToast('Selecione um cliente', 'error');
                    return;
                }

                // Obter usu√°rio atual
                const user = await getCurrentUser();
                
                // Gerar n√∫mero √∫nico para venda
                const numero = `VD${Date.now().toString().slice(-8)}`;

                // Criar venda diretamente na tabela vendas
                const { data: venda, error } = await supabase
                    .from('vendas')
                    .insert([{
                        numero: numero,
                        cliente_id: clienteId,
                        vendedor_id: user.id,
                        status: 'ABERTA',
                        subtotal: 0,
                        desconto_valor: 0,
                        total: 0,
                        observacoes: observacoes
                    }])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Erro ao criar venda:', error);
                    throw error;
                }
                
                if (venda) {
                    closeModal('modal-nova-venda');
                    window.location.href = `/pages/venda-detalhe.html?id=${venda.id}`;
                }
            } finally {
                showLoading(false);
            }
        });

        // Gerar Nota Fiscal (NFC-e)
        async function gerarNotaFiscal(vendaId) {
            try {
                showLoading(true);
                
                // Buscar dados da venda
                const { data: venda, error: erroVenda } = await supabase
                    .from('vendas')
                    .select('*')
                    .eq('id', vendaId)
                    .single();

                if (erroVenda || !venda) {
                    console.error('Erro ao buscar venda:', erroVenda);
                    alert('Erro ao carregar dados da venda');
                    return;
                }
                
                // Verificar se j√° tem nota emitida
                if (venda.nfce_referencia || venda.status_fiscal === 'EMITIDA_NFCE') {
                    alert('Esta venda j√° possui nota fiscal emitida!\n\nUse o bot√£o de imprimir para visualizar o DANFE.');
                    return;
                }

                // Buscar itens da venda
                const { data: itens, error: erroItens } = await supabase
                    .from('venda_itens')
                    .select('*')
                    .eq('venda_id', vendaId);

                if (erroItens) {
                    console.error('Erro ao buscar itens:', erroItens);
                    alert('Erro ao carregar itens da venda: ' + erroItens.message);
                    return;
                }
                
                if (!itens || itens.length === 0) {
                    alert('Esta venda n√£o possui itens para emitir nota fiscal');
                    return;
                }
                
                // Buscar produtos para cada item separadamente
                for (let item of itens) {
                    if (item.produto_id) {
                        const { data: produto } = await supabase
                            .from('produtos')
                            .select('id, nome, codigo_barras, sku, ncm, cfop, cst_icms, aliquota_icms')
                            .eq('id', item.produto_id)
                            .single();
                        
                        item.produtos = produto;
                    }
                }


                // Usar forma_pagamento que j√° vem na venda (tabela pagamentos n√£o precisa existir)
                const pagamentosParaNFe = [{
                    tipo: venda.forma_pagamento || 'DINHEIRO',
                    valor: venda.total
                }];

                // Buscar cliente (opcional)
                let cliente = null;
                if (venda.cliente_id) {
                    const { data: clienteData } = await supabase
                        .from('clientes')
                        .select('*')
                        .eq('id', venda.cliente_id)
                        .single();
                    cliente = clienteData;
                }

                console.log('üì¶ Venda:', venda);
                console.log('üìã Itens:', itens);
                console.log('üí∞ Pagamentos:', pagamentosParaNFe);
                console.log('üìÑ Dados fiscais atuais:', {
                    status_fiscal: venda.status_fiscal,
                    numero_nfce: venda.numero_nfce,
                    chave_acesso_nfce: venda.chave_acesso_nfce,
                    protocolo_nfce: venda.protocolo_nfce
                });

                // Emitir NFC-e via API Fiscal configurada (Focus NFe ou Nuvem Fiscal)
                const resultado = await FiscalService.emitirNFCeDireto(venda, itens, pagamentosParaNFe, cliente);

                console.log('üì§ Resultado da emiss√£o:', resultado);

                // Verificar sucesso
                if (resultado.success || resultado.status === 'autorizado') {
                    // Atualizar status da venda
                    await supabase
                        .from('vendas')
                        .update({
                            status_fiscal: 'EMITIDA_NFCE',
                            numero_nfce: resultado.numero,
                            chave_acesso_nfce: resultado.chave_nfe,
                            protocolo_nfce: resultado.protocolo
                        })
                        .eq('id', vendaId);

                    alert(`‚úÖ NFC-e emitida com sucesso!

N√∫mero: ${resultado.numero}
S√©rie: ${resultado.serie}
Chave: ${resultado.chave_nfe}
Protocolo: ${resultado.protocolo}

Deseja baixar o DANFE (PDF)?`);

                    // Baixar DANFE automaticamente
                    if (confirm('Baixar DANFE agora?')) {
                        if (resultado.caminho_danfe) {
                            window.open(resultado.caminho_danfe, '_blank');
                        }
                    }

                    // Recarregar lista
                    loadVendas();
                } else {
                    // Erro na emiss√£o
                    const mensagem = resultado.mensagem_sefaz || resultado.mensagem || 'Erro desconhecido';
                    throw new Error('Rejei√ß√£o: ' + mensagem);
                }

            } catch (error) {
                console.error('‚ùå Erro na emiss√£o:', error);
                alert('‚ùå Erro na emiss√£o: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // Imprimir/Consultar nota fiscal existente
        async function imprimirNotaFiscal(vendaId, chaveAcesso) {
            try {
                showLoading(true);
                
                if (!chaveAcesso || chaveAcesso === 'undefined' || chaveAcesso === '') {
                    // Buscar chave de acesso do banco
                    const { data: venda } = await supabase
                        .from('vendas')
                        .select('chave_acesso_nfce, numero_nfce')
                        .eq('id', vendaId)
                        .single();
                    
                    chaveAcesso = venda?.chave_acesso_nfce;
                }
                
                if (!chaveAcesso) {
                    alert('Esta venda n√£o possui chave de acesso da NFC-e');
                    return;
                }
                
                console.log('üîç Consultando NFC-e com chave:', chaveAcesso);
                
                // Consultar nota usando a chave de acesso
                const resultado = await FiscalService.consultarDocumento(chaveAcesso, 'nfce');
                
                // Nuvem Fiscal usa m√©todo obterPDF() com autentica√ß√£o
                if (resultado.caminho_danfe === 'USE_OBTER_PDF_METHOD' && resultado.obterPDF) {
                    const pdfUrl = await resultado.obterPDF();
                    window.open(pdfUrl, '_blank');
                    showToast('DANFE aberto em nova aba', 'success');
                } else if (resultado.caminho_danfe) {
                    window.open(resultado.caminho_danfe, '_blank');
                    showToast('DANFE aberto em nova aba', 'success');
                } else {
                    alert('N√£o foi poss√≠vel obter o DANFE desta nota fiscal');
                }
            } catch (error) {
                console.error('‚ùå Erro ao consultar NFC-e:', error);
                alert('Erro ao consultar nota: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Cancelar NFC-e
        async function cancelarNotaFiscal(vendaId, chaveAcesso) {
            try {
                // Buscar dados da venda
                const { data: venda, error: vendaError } = await supabase
                    .from('vendas')
                    .select('chave_acesso_nfce, numero_nfce, data_venda, status_fiscal')
                    .eq('id', vendaId)
                    .single();

                if (vendaError) throw vendaError;
                if (!venda.chave_acesso_nfce) {
                    alert('Esta venda n√£o possui nota fiscal emitida');
                    return;
                }

                // Verificar prazo de cancelamento (30 minutos para NFC-e)
                const dataEmissao = new Date(venda.data_venda);
                const agora = new Date();
                const diferencaMinutos = (agora - dataEmissao) / 1000 / 60;

                if (diferencaMinutos > 30) {
                    alert(`‚ö†Ô∏è Prazo para cancelamento expirado!\n\nNFC-e pode ser cancelada em at√© 30 minutos ap√≥s a emiss√£o.\nTempo decorrido: ${Math.round(diferencaMinutos)} minutos`);
                    return;
                }

                // Solicitar justificativa
                const justificativa = prompt('üìù Informe a justificativa do cancelamento:\n\n(m√≠nimo 15 caracteres)');
                
                if (!justificativa) return;
                
                if (justificativa.length < 15) {
                    alert('A justificativa deve ter no m√≠nimo 15 caracteres');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è Confirma o cancelamento da NFC-e?\n\nN√∫mero: ${venda.numero_nfce}\nJustificativa: ${justificativa}`)) {
                    return;
                }

                showLoading(true);

                // Cancelar via API Fiscal configurada
                const resultado = await FiscalService.cancelarDocumento(chaveAcesso, justificativa, 'nfce');

                if (resultado.status === 'cancelado') {
                    // Atualizar status no banco
                    await supabase
                        .from('vendas')
                        .update({
                            status_fiscal: 'CANCELADA_NFCE'
                        })
                        .eq('id', vendaId);

                    alert('‚úÖ NFC-e cancelada com sucesso!');
                    loadVendas(); // Recarregar lista
                } else {
                    throw new Error('Erro ao cancelar nota: ' + (resultado.mensagem_sefaz || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao cancelar NFC-e:', error);
                alert('Erro ao cancelar nota: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
