<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribui√ß√£o de NFC-e - Notas de Sa√≠da</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Estado indeterminate do checkbox */
        input[type="checkbox"]:indeterminate {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* Anima√ß√£o suave para painel fiscal */
        #painel_fiscal {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16 pb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- HEADER -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-cube mr-3 text-blue-600"></i>Distribui√ß√£o de NFC-e
                </h2>
                <p class="text-gray-600 mt-1">Emitir notas de sa√≠da para produtos que chegaram com NF-e</p>
            </div>

            <!-- FILTROS -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio</label>
                        <input type="datetime-local" id="filtro_data_inicio" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data/Hora Fim</label>
                        <input type="datetime-local" id="filtro_data_fim" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fornecedor</label>
                        <input type="text" id="filtro_fornecedor" placeholder="Buscar por nome..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex items-end">
                        <button onclick="buscarEntradas()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            <i class="fas fa-search mr-2"></i>Buscar
                        </button>
                    </div>
                </div>
            </div>

            <!-- MENSAGENS -->
            <div id="msg_info_container" class="hidden mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-800">
                <span id="msg_info_text"></span>
            </div>

            <!-- AREA DE CARREGAMENTO -->
            <div id="area_carregando" class="hidden mb-6 p-8 bg-white rounded-lg shadow text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
                <p class="text-gray-600">Carregando entradas...</p>
            </div>

            <!-- ENTRADAS -->
            <div id="area_entradas" class="hidden mb-6">
                <!-- Controles Gerais -->
                <div class="bg-white rounded-lg shadow p-4 mb-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="selecionar_todos" onchange="selecionarTodos(this.checked)" class="w-5 h-5 text-blue-600 rounded cursor-pointer">
                            <span class="font-medium text-gray-700">Selecionar Todos os Itens</span>
                        </label>
                    </div>
                    <button onclick="toggleConfiguracoesFiscais()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
                        <i class="fas fa-cog mr-2"></i>Configura√ß√µes Fiscais
                    </button>
                </div>

                <!-- Configura√ß√µes Fiscais (Colaps√°vel) -->
                <div id="painel_fiscal" class="hidden bg-white rounded-lg shadow p-6 mb-4">
                    <h3 class="text-lg font-bold mb-4 text-gray-900">
                        <i class="fas fa-file-invoice mr-2 text-blue-600"></i>Configura√ß√µes Fiscais - Aplicar a Todos Selecionados
                    </h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Dica:</strong> Selecione os CST que deseja aplicar aos itens marcados. Campos vazios manter√£o o valor original do produto.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CST ICMS</label>
                            <select id="cst_icms_global" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Manter original</option>
                                <option value="00">00 - Tributada Integralmente</option>
                                <option value="10">10 - Tributada com cobran√ßa do ICMS por ST</option>
                                <option value="20">20 - Com redu√ß√£o de base de c√°lculo</option>
                                <option value="30">30 - Isenta ou n√£o tributada com cobran√ßa do ICMS por ST</option>
                                <option value="40">40 - Isenta</option>
                                <option value="41">41 - N√£o tributada</option>
                                <option value="50">50 - Suspens√£o</option>
                                <option value="51">51 - Diferimento</option>
                                <option value="60">60 - ICMS cobrado anteriormente por ST</option>
                                <option value="70">70 - Com redu√ß√£o de BC e cobran√ßa do ICMS por ST</option>
                                <option value="90">90 - Outros</option>
                                <option value="101" selected>101 - Simples Nacional - Tributada com permiss√£o de cr√©dito</option>
                                <option value="102">102 - Simples Nacional - Tributada sem permiss√£o de cr√©dito</option>
                                <option value="103">103 - Simples Nacional - Isen√ß√£o do ICMS para faixa de receita bruta</option>
                                <option value="201">201 - Simples Nacional - Tributada com permiss√£o de cr√©dito e com cobran√ßa do ICMS por ST</option>
                                <option value="202">202 - Simples Nacional - Tributada sem permiss√£o de cr√©dito e com cobran√ßa do ICMS por ST</option>
                                <option value="203">203 - Simples Nacional - Isen√ß√£o do ICMS para faixa de receita bruta e com cobran√ßa do ICMS por ST</option>
                                <option value="300">300 - Simples Nacional - Imune</option>
                                <option value="400">400 - Simples Nacional - N√£o tributada</option>
                                <option value="500">500 - Simples Nacional - ICMS cobrado anteriormente por ST ou por antecipa√ß√£o</option>
                                <option value="900">900 - Simples Nacional - Outros</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CST PIS</label>
                            <select id="cst_pis_global" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Manter original</option>
                                <option value="01">01 - Opera√ß√£o Tribut√°vel com Al√≠quota B√°sica</option>
                                <option value="02">02 - Opera√ß√£o Tribut√°vel com Al√≠quota Diferenciada</option>
                                <option value="03">03 - Opera√ß√£o Tribut√°vel com Al√≠quota por Unidade de Medida</option>
                                <option value="04">04 - Opera√ß√£o Tribut√°vel Monof√°sica</option>
                                <option value="05">05 - Opera√ß√£o Tribut√°vel por Substitui√ß√£o Tribut√°ria</option>
                                <option value="06">06 - Opera√ß√£o Tribut√°vel a Al√≠quota Zero</option>
                                <option value="07">07 - Opera√ß√£o Isenta da Contribui√ß√£o</option>
                                <option value="08">08 - Opera√ß√£o sem Incid√™ncia da Contribui√ß√£o</option>
                                <option value="09">09 - Opera√ß√£o com Suspens√£o da Contribui√ß√£o</option>
                                <option value="49">49 - Outras Opera√ß√µes de Sa√≠da</option>
                                <option value="99" selected>99 - Outras Opera√ß√µes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CST COFINS</label>
                            <select id="cst_cofins_global" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Manter original</option>
                                <option value="01">01 - Opera√ß√£o Tribut√°vel com Al√≠quota B√°sica</option>
                                <option value="02">02 - Opera√ß√£o Tribut√°vel com Al√≠quota Diferenciada</option>
                                <option value="03">03 - Opera√ß√£o Tribut√°vel com Al√≠quota por Unidade de Medida</option>
                                <option value="04">04 - Opera√ß√£o Tribut√°vel Monof√°sica</option>
                                <option value="05">05 - Opera√ß√£o Tribut√°vel por Substitui√ß√£o Tribut√°ria</option>
                                <option value="06">06 - Opera√ß√£o Tribut√°vel a Al√≠quota Zero</option>
                                <option value="07">07 - Opera√ß√£o Isenta da Contribui√ß√£o</option>
                                <option value="08">08 - Opera√ß√£o sem Incid√™ncia da Contribui√ß√£o</option>
                                <option value="09">09 - Opera√ß√£o com Suspens√£o da Contribui√ß√£o</option>
                                <option value="49">49 - Outras Opera√ß√µes de Sa√≠da</option>
                                <option value="99" selected>99 - Outras Opera√ß√µes</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="salvar_cst_cadastro" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">
                                <i class="fas fa-save mr-1 text-yellow-600"></i>
                                <strong>Salvar CST no cadastro dos produtos</strong> (altera√ß√µes permanentes)
                            </span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1 ml-6">
                            Quando marcado, os CST configurados ser√£o salvos no cadastro dos produtos, n√£o sendo necess√°rio reconfigur√°-los em futuras emiss√µes.
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="aplicarCstTodos()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                            <i class="fas fa-check mr-2"></i>Aplicar aos Itens Selecionados
                        </button>
                        <button onclick="toggleConfiguracoesFiscais()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium">
                            Fechar
                        </button>
                    </div>
                </div>

                <div id="entradas_grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Pedidos de compra ser√£o renderizados aqui -->
                </div>
            </div>

            <!-- RESUMO E BOT√ïES -->
            <div id="area_resumo" class="hidden bg-white rounded-lg shadow p-6 mb-6 sticky bottom-0 z-10 border-t-4 border-blue-600">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-600">Itens Selecionados</p>
                        <p class="text-2xl font-bold text-gray-900" id="resumo_itens">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Quantidade Total</p>
                        <p class="text-2xl font-bold text-gray-900" id="resumo_quantidade">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Valor Total</p>
                        <p class="text-2xl font-bold text-green-600" id="resumo_valor">R$ 0,00</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <input type="text" id="descricao_nota" placeholder="Distribui√ß√£o" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                        <input type="text" id="observacoes_nota" placeholder="Opcional" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div class="flex gap-3">
                    <button class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed" id="btn_emitir" onclick="emitirNFCe()">
                        <i class="fas fa-check mr-2"></i>Emitir NFC-e
                    </button>
                    <button class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium" onclick="limparSelecoes()">
                        <i class="fas fa-times mr-2"></i>Limpar
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL SUCESSO -->
    <div id="modal_sucesso" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="text-center mb-6">
                <div class="inline-block p-3 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check text-3xl text-green-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">NFC-e Emitida!</h3>
            </div>
            <div class="space-y-3 text-sm mb-6 bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between">
                    <span class="text-gray-600">N√∫mero/S√©rie:</span>
                    <span class="font-mono font-bold" id="sucesso_numero">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Chave:</span>
                    <span class="font-mono text-xs" id="sucesso_chave">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Protocolo:</span>
                    <span class="font-mono font-bold" id="sucesso_protocolo">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Itens:</span>
                    <span class="font-bold" id="sucesso_itens">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Valor:</span>
                    <span class="font-bold text-green-600" id="sucesso_valor">R$ 0,00</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="imprimirDANFE()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
                    <i class="fas fa-print mr-2"></i>Imprimir DANFE
                </button>
                <button onclick="fecharModal('modal_sucesso'); location.reload();" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">
                    Nova Emiss√£o
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ERRO -->
    <div id="modal_erro" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="text-center mb-6">
                <div class="inline-block p-3 bg-red-100 rounded-full mb-4">
                    <i class="fas fa-exclamation text-3xl text-red-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Erro na Emiss√£o</h3>
            </div>
            <div class="bg-red-50 p-4 rounded-lg mb-6 max-h-40 overflow-y-auto">
                <p class="text-sm text-red-800" id="erro_mensagem">-</p>
            </div>
            <button onclick="fecharModal('modal_erro')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                Fechar
            </button>
        </div>
    </div>

    <!-- SUPABASE E CONFIG -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>

    <!-- SERVI√áOS -->
    <script src="../js/services/distribuicao-nfe.js"></script>
    <script src="../js/services/fiscal.js"></script>
    <script src="../js/services/nuvem-fiscal.js"></script>
    <script src="../js/services/focus-nfe.js"></script>
    <script src="../js/services/empresa.js"></script>

    <!-- COMPONENTES -->
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>

    <script>
        let currentUser = null;

        (async () => {
            try {
                await checkAuth();
                currentUser = await getCurrentUser();
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
                await initNavbar();
                await initSidebar();
            } catch (error) {
                console.error('Erro ao inicializar distribui√ß√£o:', error);
                document.getElementById('navbar').innerHTML = createNavbar();
                document.getElementById('sidebar-container').innerHTML = createSidebar();
            }
            
            // Definir datas padr√£o (√∫ltimos 30 dias)
            const dataFim = new Date();
            const dataInicio = new Date(dataFim.getTime() - 30 * 24 * 60 * 60 * 1000);

            document.getElementById('filtro_data_inicio').value = dataInicio.toISOString().split('T')[0];
            document.getElementById('filtro_data_fim').value = dataFim.toISOString().split('T')[0];
        })();

        // Estado global
        let estadoGlobal = {
            entradas: [],
            itensSelecionados: new Map(), // Map<itemId, { quantidade, preco, cst_icms, cst_pis, cst_cofins }>
            ultimaEmissao: null // Armazena dados da √∫ltima emiss√£o para impress√£o
        };

        // BUSCAR ENTRADAS
        async function buscarEntradas() {
            try {
                const dataInicio = new Date(document.getElementById('filtro_data_inicio').value);
                const dataFim = new Date(document.getElementById('filtro_data_fim').value);
                const filtroFornecedor = document.getElementById('filtro_fornecedor').value.toLowerCase();

                if (!dataInicio || !dataFim) {
                    alert('Selecione as datas para buscar');
                    return;
                }

                mostrarCarregando(true);
                estadoGlobal.itensSelecionados.clear();

                // Buscar entradas
                const entradas = await DistribuicaoNFCe.buscarEntradasPeriodo(dataInicio, dataFim);

                // Filtrar por fornecedor se informado
                let entradasFiltradas = entradas;
                if (filtroFornecedor) {
                    entradasFiltradas = entradas.filter(e =>
                        e.fornecedores?.nome?.toLowerCase().includes(filtroFornecedor) ||
                        e.nf_numero?.includes(filtroFornecedor)
                    );
                }

                estadoGlobal.entradas = entradasFiltradas;

                if (entradasFiltradas.length === 0) {
                    mostrarMensagem('Nenhuma entrada de compra encontrada para o per√≠odo selecionado.', 'warning');
                    mostrarCarregando(false);
                    document.getElementById('area_entradas').classList.add('hidden');
                    document.getElementById('area_resumo').classList.add('hidden');
                    return;
                }

                renderizarEntradas(entradasFiltradas);
                mostrarCarregando(false);
                mostrarMensagem(`${entradasFiltradas.length} pedido(s) encontrado(s) com itens dispon√≠veis para distribui√ß√£o.`);

            } catch (erro) {
                console.error('Erro ao buscar entradas:', erro);
                mostrarCarregando(false);
                mostrarErro('Erro ao buscar entradas: ' + erro.message);
            }
        }

        // RENDERIZAR ENTRADAS
        function renderizarEntradas(entradas) {
            const grid = document.getElementById('entradas_grid');
            grid.innerHTML = '';

            entradas.forEach(pedido => {
                const valorTotal = pedido.pedido_compra_itens.reduce((sum, item) => sum + (item.subtotal || 0), 0);

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow overflow-hidden';
                card.innerHTML = `
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h3 class="font-bold text-gray-900">Pedido #${pedido.numero}</h3>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-sm text-gray-600">
                            <div>üìÖ ${new Date(pedido.data_recebimento).toLocaleDateString('pt-BR')}</div>
                            <div>üíº ${pedido.fornecedores?.nome || 'Sem fornecedor'}</div>
                            <div>üìÑ NF: ${pedido.nf_numero}</div>
                            <div>üí∞ R$ ${valorTotal.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="p-4 space-y-2 max-h-96 overflow-y-auto" id="itens_${pedido.id}">
                        ${renderizarItens(pedido.pedido_compra_itens, pedido.id)}
                    </div>
                `;
                grid.appendChild(card);
            });

            document.getElementById('area_entradas').classList.remove('hidden');
            document.getElementById('area_resumo').classList.remove('hidden');
        }

        // RENDERIZAR ITENS
        function renderizarItens(itens, pedidoId) {
            return itens.map(item => {
                const precoVenda = item.preco_venda_nfe || item.produtos?.preco_venda || (item.subtotal / item.quantidade);
                const totalItem = precoVenda * item.quantidade;

                return `
                    <div class="flex gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                        <input type="checkbox" 
                               class="item-checkbox w-5 h-5 text-blue-600 rounded cursor-pointer"
                               data-item-id="${item.id}"
                               data-quantidade="${item.quantidade}"
                               data-preco-inicial="${precoVenda}"
                               onchange="atualizarSelecao('${item.id}', this.checked, ${item.quantidade}, ${precoVenda})">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900">${item.produto?.nome || 'Produto sem nome'}</p>
                            <p class="text-gray-500">${item.quantidade} ${item.produto?.unidade_medida_padrao || 'UN'}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <input type="number" 
                                   step="0.01" 
                                   value="${precoVenda.toFixed(2)}"
                                   data-input-preco="${item.id}"
                                   onchange="atualizarPrecoItem('${item.id}', this.value)"
                                   disabled
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-right disabled:bg-gray-200 disabled:cursor-not-allowed">
                            <p class="text-green-600 font-bold mt-1" id="total_${item.id}">R$ ${totalItem.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ATUALIZAR PRE√áO
        function atualizarPrecoItem(itemId, novoPreco) {
            const precoNum = parseFloat(novoPreco) || 0;
            if (estadoGlobal.itensSelecionados.has(itemId)) {
                const item = estadoGlobal.itensSelecionados.get(itemId);
                item.preco = precoNum;
                const total = item.quantidade * precoNum;
                document.getElementById(`total_${itemId}`).textContent = `R$ ${total.toFixed(2)}`;
                atualizarResumo();
            }
        }

        // ATUALIZAR SELE√á√ÉO
        function atualizarSelecao(itemId, selecionado, quantidade, preco) {
            const precoNum = parseFloat(preco) || 0;
            const inputPreco = document.querySelector(`input[data-input-preco="${itemId}"]`);

            if (selecionado) {
                // Buscar CST padr√£o do produto se dispon√≠vel
                const itemData = encontrarItemPorId(itemId);
                estadoGlobal.itensSelecionados.set(itemId, { 
                    quantidade, 
                    preco: precoNum,
                    produto_id: itemData?.produto_id, // ‚úÖ Adicionar para salvar CST no cadastro
                    cst_icms: itemData?.produto?.cst_icms || '101',
                    cst_pis: itemData?.produto?.cst_pis || '99',
                    cst_cofins: itemData?.produto?.cst_cofins || '99'
                });
                if (inputPreco) inputPreco.disabled = false;
            } else {
                estadoGlobal.itensSelecionados.delete(itemId);
                if (inputPreco) inputPreco.disabled = true;
            }

            atualizarResumo();
            atualizarCheckboxSelecionarTodos();
        }

        // SELECIONAR TODOS
        function selecionarTodos(selecionar) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked !== selecionar) {
                    checkbox.checked = selecionar;
                    const itemId = checkbox.dataset.itemId;
                    const quantidade = parseFloat(checkbox.dataset.quantidade);
                    const preco = parseFloat(checkbox.dataset.precoInicial);
                    atualizarSelecao(itemId, selecionar, quantidade, preco);
                }
            });
        }

        // ATUALIZAR CHECKBOX SELECIONAR TODOS
        function atualizarCheckboxSelecionarTodos() {
            const checkboxTodos = document.getElementById('selecionar_todos');
            if (!checkboxTodos) return;
            
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const totalCheckboxes = checkboxes.length;
            const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            if (totalCheckboxes === 0) {
                checkboxTodos.checked = false;
                checkboxTodos.indeterminate = false;
            } else if (checkedCheckboxes === totalCheckboxes) {
                checkboxTodos.checked = true;
                checkboxTodos.indeterminate = false;
            } else if (checkedCheckboxes > 0) {
                checkboxTodos.checked = false;
                checkboxTodos.indeterminate = true;
            } else {
                checkboxTodos.checked = false;
                checkboxTodos.indeterminate = false;
            }
        }

        // ENCONTRAR ITEM POR ID
        function encontrarItemPorId(itemId) {
            for (const entrada of estadoGlobal.entradas) {
                const item = entrada.pedido_compra_itens?.find(i => i.id === itemId);
                if (item) return item;
            }
            return null;
        }

        // TOGGLE CONFIGURA√á√ïES FISCAIS
        function toggleConfiguracoesFiscais() {
            const painel = document.getElementById('painel_fiscal');
            painel.classList.toggle('hidden');
        }

        // APLICAR CST A TODOS OS SELECIONADOS
        async function aplicarCstTodos() {
            const cstIcms = document.getElementById('cst_icms_global').value;
            const cstPis = document.getElementById('cst_pis_global').value;
            const cstCofins = document.getElementById('cst_cofins_global').value;
            const salvarCadastro = document.getElementById('salvar_cst_cadastro').checked;

            if (!cstIcms && !cstPis && !cstCofins) {
                alert('Selecione pelo menos um CST para aplicar');
                return;
            }

            let contador = 0;
            let detalhes = [];
            const produtosParaAtualizar = new Map(); // produto_id -> { cst_icms, cst_pis, cst_cofins }
            
            // Aplicar aos itens selecionados (tempor√°rio)
            estadoGlobal.itensSelecionados.forEach((itemData, itemId) => {
                if (cstIcms) itemData.cst_icms = cstIcms;
                if (cstPis) itemData.cst_pis = cstPis;
                if (cstCofins) itemData.cst_cofins = cstCofins;
                contador++;
                
                // Coletar produtos para atualizar no cadastro
                if (salvarCadastro && itemData.produto_id) {
                    if (!produtosParaAtualizar.has(itemData.produto_id)) {
                        produtosParaAtualizar.set(itemData.produto_id, {});
                    }
                    const prodUpdate = produtosParaAtualizar.get(itemData.produto_id);
                    if (cstIcms) prodUpdate.cst_icms = cstIcms;
                    if (cstPis) prodUpdate.cst_pis = cstPis;
                    if (cstCofins) prodUpdate.cst_cofins = cstCofins;
                }
            });

            if (cstIcms) detalhes.push(`ICMS: ${cstIcms}`);
            if (cstPis) detalhes.push(`PIS: ${cstPis}`);
            if (cstCofins) detalhes.push(`COFINS: ${cstCofins}`);

            // Salvar no cadastro se solicitado
            if (salvarCadastro && produtosParaAtualizar.size > 0) {
                try {
                    mostrarMensagem('üíæ Salvando altera√ß√µes no cadastro...', 'info');
                    
                    const promises = Array.from(produtosParaAtualizar.entries()).map(([produtoId, updates]) => {
                        return supabase
                            .from('produtos')
                            .update(updates)
                            .eq('id', produtoId);
                    });
                    
                    const results = await Promise.all(promises);
                    const erros = results.filter(r => r.error);
                    
                    if (erros.length > 0) {
                        console.error('‚ùå Erros ao salvar CST:', erros);
                        mostrarMensagem(`‚ö†Ô∏è CST aplicado a ${contador} item(ns), mas ${erros.length} produto(s) n√£o foram atualizados no cadastro`, 'warning');
                    } else {
                        mostrarMensagem(`‚úÖ CST aplicado a ${contador} item(ns) e salvo no cadastro de ${produtosParaAtualizar.size} produto(s): ${detalhes.join(', ')}`, 'success');
                    }
                } catch (erro) {
                    console.error('Erro ao salvar CST no cadastro:', erro);
                    mostrarMensagem(`‚úÖ CST aplicado temporariamente, mas erro ao salvar no cadastro: ${erro.message}`, 'warning');
                }
            } else {
                mostrarMensagem(`‚úÖ CST aplicado a ${contador} item(ns): ${detalhes.join(', ')}`, 'success');
            }
            
            toggleConfiguracoesFiscais();
        }

        // ATUALIZAR RESUMO
        function atualizarResumo() {
            let totalItens = 0, totalQuantidade = 0, totalValor = 0;

            estadoGlobal.itensSelecionados.forEach(item => {
                totalItens++;
                totalQuantidade += item.quantidade;
                totalValor += item.quantidade * item.preco;
            });

            document.getElementById('resumo_itens').textContent = totalItens;
            document.getElementById('resumo_quantidade').textContent = totalQuantidade.toFixed(3);
            document.getElementById('resumo_valor').textContent = 'R$ ' + totalValor.toFixed(2);
            document.getElementById('btn_emitir').disabled = totalItens === 0;
            
            // Atualizar contador no bot√£o de configura√ß√µes fiscais
            const btnConfig = document.querySelector('button[onclick="toggleConfiguracoesFiscais()"]');
            if (btnConfig && totalItens > 0) {
                btnConfig.innerHTML = `<i class="fas fa-cog mr-2"></i>Configura√ß√µes Fiscais <span class="ml-1 px-2 py-0.5 bg-white text-blue-600 rounded-full text-xs font-bold">${totalItens}</span>`;
            } else if (btnConfig) {
                btnConfig.innerHTML = `<i class="fas fa-cog mr-2"></i>Configura√ß√µes Fiscais`;
            }
        }

        // EMITIR NFC-e
        async function emitirNFCe() {
            try {
                if (estadoGlobal.itensSelecionados.size === 0) {
                    alert('Selecione pelo menos um item');
                    return;
                }

                const itensCliente = Array.from(estadoGlobal.itensSelecionados).map(([itemId, dados]) => ({
                    pedido_item_id: itemId,
                    quantidade: dados.quantidade,
                    preco_venda: dados.preco,
                    cst_icms: dados.cst_icms,
                    cst_pis: dados.cst_pis,
                    cst_cofins: dados.cst_cofins
                }));

                document.getElementById('btn_emitir').disabled = true;
                document.getElementById('btn_emitir').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Emitindo...';

                const resultado = await DistribuicaoNFCe.emitirNFCeDistribuicao({
                    itensCliente,
                    descricaoNota: document.getElementById('descricao_nota').value || 'Distribui√ß√£o de Produtos',
                    observacoes: document.getElementById('observacoes_nota').value
                });

                console.log('‚úÖ [EmitirNFCe] Resultado completo da emiss√£o:', resultado);
                console.log('üìã [EmitirNFCe] nfce_id:', resultado.nfce_id);
                console.log('üìã [EmitirNFCe] documento_fiscal_id:', resultado.documento_fiscal_id);
                
                // Armazenar dados da √∫ltima emiss√£o para impress√£o
                estadoGlobal.ultimaEmissao = resultado;

                // Exibir informa√ß√µes no modal de sucesso
                const numeroSerie = `${resultado.numero_nfce}/${resultado.serie || '1'}`;
                document.getElementById('sucesso_numero').textContent = numeroSerie;
                document.getElementById('sucesso_chave').textContent = resultado.chave_nfe || 'N/A';
                document.getElementById('sucesso_protocolo').textContent = resultado.protocolo || 'Processando...';
                document.getElementById('sucesso_itens').textContent = resultado.total_itens;
                document.getElementById('sucesso_valor').textContent = 'R$ ' + resultado.valor_total.toFixed(2);
                abrirModal('modal_sucesso');

            } catch (erro) {
                console.error('Erro ao emitir:', erro);
                document.getElementById('btn_emitir').disabled = false;
                document.getElementById('btn_emitir').innerHTML = '<i class="fas fa-check mr-2"></i>Emitir NFC-e';
                mostrarErro(erro.message);
            }
        }

        // LIMPAR SELE√á√ïES
        function limparSelecoes() {
            estadoGlobal.itensSelecionados.clear();
            document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
            const checkboxTodos = document.getElementById('selecionar_todos');
            if (checkboxTodos) {
                checkboxTodos.checked = false;
                checkboxTodos.indeterminate = false;
            }
            // Fechar e resetar painel fiscal
            const painelFiscal = document.getElementById('painel_fiscal');
            if (painelFiscal && !painelFiscal.classList.contains('hidden')) {
                painelFiscal.classList.add('hidden');
            }
            resetarCamposFiscais();
            atualizarResumo();
        }

        // RESETAR CAMPOS FISCAIS
        function resetarCamposFiscais() {
            document.getElementById('cst_icms_global').value = '';
            document.getElementById('cst_pis_global').value = '';
            document.getElementById('cst_cofins_global').value = '';
            document.getElementById('salvar_cst_cadastro').checked = false; // Reset checkbox
        }

        // UTILIDADES
        function mostrarCarregando(ativo) {
            document.getElementById('area_carregando').classList.toggle('hidden', !ativo);
        }

        function mostrarMensagem(texto, tipo = 'info') {
            const container = document.getElementById('msg_info_container');
            document.getElementById('msg_info_text').textContent = texto;
            container.classList.remove('hidden');
        }

        function mostrarErro(mensagem) {
            document.getElementById('erro_mensagem').textContent = mensagem;
            abrirModal('modal_erro');
        }

        function abrirModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // IMPRIMIR DANFE
        async function imprimirDANFE() {
            try {
                console.log('üñ®Ô∏è [ImprimirDANFE] Estado global da √∫ltima emiss√£o:', estadoGlobal.ultimaEmissao);
                
                if (!estadoGlobal.ultimaEmissao) {
                    alert('Nenhuma emiss√£o encontrada para impress√£o. Por favor, emita uma NFC-e primeiro.');
                    return;
                }

                const { nfce_id, chave_nfe, numero_nfce, documento_fiscal_id } = estadoGlobal.ultimaEmissao;
                
                console.log('üìã [ImprimirDANFE] Dados extra√≠dos:', { nfce_id, chave_nfe, numero_nfce, documento_fiscal_id });
                
                // Se n√£o tiver nfce_id no estado global, tentar buscar do banco
                let refParaImprimir = nfce_id;
                
                if (!refParaImprimir && documento_fiscal_id) {
                    console.log('üîç [ImprimirDANFE] nfce_id n√£o encontrado no estado, buscando do banco...');
                    try {
                        const { data: docFiscal, error } = await supabase
                            .from('documentos_fiscais')
                            .select('nfce_id, chave_acesso')
                            .eq('id', documento_fiscal_id)
                            .single();
                        
                        if (!error && docFiscal) {
                            refParaImprimir = docFiscal.nfce_id || docFiscal.chave_acesso;
                            console.log('‚úÖ [ImprimirDANFE] Refer√™ncia encontrada no banco:', refParaImprimir);
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è [ImprimirDANFE] Erro ao buscar do banco:', err);
                    }
                }
                
                // Se ainda n√£o tiver, usar chave de acesso como fallback
                if (!refParaImprimir && chave_nfe) {
                    refParaImprimir = chave_nfe;
                    console.log('üìù [ImprimirDANFE] Usando chave de acesso como fallback:', refParaImprimir);
                }
                
                if (!refParaImprimir) {
                    alert('‚ùå Dados insuficientes para impress√£o.\n\nN√£o foi poss√≠vel encontrar:\n- ID da nota na API (nfce_id)\n- Chave de acesso\n- ID do documento fiscal\n\nTente buscar o documento na tela de Documentos Fiscais.');
                    return;
                }

                mostrarMensagem('üñ®Ô∏è Gerando DANFE...', 'info');
                
                const tipo = 'nfce';
                
                try {
                    console.log('üì§ [ImprimirDANFE] Solicitando DANFE - Ref:', refParaImprimir, 'Tipo:', tipo);
                    
                    // Usar FiscalSystem (o servi√ßo est√° importado como fiscal.js)
                    const pdfUrl = await FiscalSystem.baixarDANFE(refParaImprimir, tipo);
                    
                    // Se for um Blob, converter para URL
                    let urlParaAbrir = pdfUrl;
                    if (pdfUrl instanceof Blob) {
                        urlParaAbrir = URL.createObjectURL(pdfUrl);
                    }
                    
                    console.log('‚úÖ [ImprimirDANFE] DANFE gerado com sucesso!');
                    window.open(urlParaAbrir, '_blank');
                    mostrarMensagem('‚úÖ DANFE gerado com sucesso!', 'success');
                } catch (err) {
                    console.error('‚ùå [ImprimirDANFE] Erro ao gerar DANFE:', err);
                    mostrarErro('Erro ao gerar DANFE: ' + (err.message || err));
                }
            } catch (erro) {
                console.error('‚ùå [ImprimirDANFE] Erro geral:', erro);
                mostrarErro('Erro ao imprimir DANFE: ' + erro.message);
            }
        }
    </script>
</body>
</html>
