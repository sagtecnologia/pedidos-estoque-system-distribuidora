<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Venda - Sistema de Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    
    <!-- Servi√ßo Centralizado de Estoque -->
    <script src="../js/services/estoque-central.js"></script>
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <a href="#" id="btn-voltar" class="text-green-600 hover:text-green-800 mb-4 inline-block">‚Üê Voltar</a>
                <div class="flex justify-between items-center">
                    <div>
                        <h2 id="venda-numero" class="text-3xl font-bold text-gray-900">Venda</h2>
                        <p id="venda-status" class="text-gray-600 mt-1"></p>
                    </div>
                    <div id="acoes-venda" class="space-x-2"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Informa√ß√µes da Venda -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Itens -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Itens da Venda</h3>
                            <div class="flex gap-2">
                                <button id="btn-alterar-preco-lote" onclick="abrirModalAlterarPrecoLote()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm" style="display: none;">
                                    üí∞ Alterar Pre√ßo em Lote
                                </button>
                                <button id="btn-add-item" onclick="openModal('modal-item')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                    + Adicionar Item
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qtd</th>
                                        <th id="th-estoque" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estoque</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo Un.</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-tbody">
                                    <tr><td colspan="6" class="px-4 py-4 text-center text-gray-500 text-sm">Nenhum item adicionado</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Observa√ß√µes -->
                    <div class="bg-white rounded-lg shadow p-6" id="observacoes-card">
                        <h3 class="text-lg font-semibold mb-2">Observa√ß√µes</h3>
                        <p id="venda-observacoes" class="text-gray-600 text-sm"></p>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Resumo -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Resumo</h3>
                        <dl class="space-y-3">
                            <div class="flex justify-between">
                                <dt class="text-gray-600">Total:</dt>
                                <dd id="venda-total" class="font-bold text-2xl text-green-600">R$ 0,00</dd>
                            </div>
                            <div class="flex justify-between pt-2 border-t">
                                <dt class="text-gray-600 text-sm">Quantidade Total:</dt>
                                <dd id="venda-quantidade-total" class="font-medium text-gray-700">0 UN</dd>
                            </div>
                            <div id="pagamento-info" class="hidden pt-3 border-t space-y-2">
                                <div class="flex justify-between text-sm">
                                    <dt class="text-gray-600">Valor Pago:</dt>
                                    <dd id="venda-valor-pago" class="font-medium text-green-600">R$ 0,00</dd>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <dt class="text-gray-600">Pendente:</dt>
                                    <dd id="venda-valor-pendente" class="font-medium text-orange-600">R$ 0,00</dd>
                                </div>
                                <div class="flex justify-between pt-2 border-t">
                                    <dt class="text-gray-600 text-xs uppercase">Status Pagamento:</dt>
                                    <dd id="venda-pagamento-status" class="font-semibold"></dd>
                                </div>
                            </div>
                        </dl>
                    </div>

                    <!-- Informa√ß√µes -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Informa√ß√µes</h3>
                        <dl class="space-y-3 text-sm">
                            <div>
                                <dt class="text-gray-500 text-xs uppercase">Vendedor</dt>
                                <dd id="venda-vendedor" class="font-medium mt-1"></dd>
                            </div>
                            <div>
                                <dt class="text-gray-500 text-xs uppercase">Cliente</dt>
                                <dd id="venda-cliente" class="font-medium mt-1"></dd>
                            </div>
                            <div>
                                <dt class="text-gray-500 text-xs uppercase">Data</dt>
                                <dd id="venda-data" class="font-medium mt-1"></dd>
                            </div>
                            <div id="aprovador-info" class="hidden">
                                <dt class="text-gray-500 text-xs uppercase">Aprovador</dt>
                                <dd id="venda-aprovador" class="font-medium mt-1"></dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Observa√ß√µes -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Observa√ß√µes</h3>
                            <button id="btn-editar-obs-venda" onclick="abrirModalObservacoes()" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                        <div id="venda-observacoes" class="text-sm text-gray-600 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Cancelar Venda -->
    <div id="modal-cancelar" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Cancelar Venda</h3>
                <button onclick="closeModal('modal-cancelar')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-600 mb-6">Como deseja cancelar esta venda?</p>
                <div class="space-y-3">
                    <button onclick="cancelarVendaHandler('CANCELADO')" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 text-left">
                        <div class="font-semibold">‚ùå Cancelar Definitivo</div>
                        <div class="text-sm opacity-90">A venda ser√° cancelada e os itens retornar√£o ao estoque</div>
                    </button>
                    <button onclick="cancelarVendaHandler('RASCUNHO')" class="w-full px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-left">
                        <div class="font-semibold">üîÑ Cancelar e Reabrir</div>
                        <div class="text-sm opacity-90">A venda voltar√° para rascunho para edi√ß√£o</div>
                    </button>
                </div>
                <button onclick="closeModal('modal-cancelar')" class="w-full mt-4 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Voltar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Observa√ß√µes -->
    <div id="modal-observacoes" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Editar Observa√ß√µes</h3>
                <button onclick="closeModal('modal-observacoes')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <form id="form-observacoes" class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Observa√ß√µes
                        <span class="text-gray-500 font-normal">(informa√ß√µes sobre estoque, prazos, etc.)</span>
                    </label>
                    <textarea 
                        id="textarea-observacoes" 
                        rows="8" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Digite as observa√ß√µes da venda..."
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">üí° Dica: Aqui voc√™ pode limpar as informa√ß√µes autom√°ticas de estoque ou adicionar novas observa√ß√µes</p>
                </div>

                <div class="flex gap-3">
                    <button 
                        type="button" 
                        onclick="closeModal('modal-observacoes')" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Salvar Observa√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Item -->
    <div id="modal-editar-item" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Editar Item</h3>
                <button onclick="closeModal('modal-editar-item')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <form id="form-editar-item">
                    <input type="hidden" id="editar-item-id">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Produto</label>
                        <input type="text" id="editar-item-nome" readonly class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
                    </div>

                    <div id="editar-estoque-info" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-blue-800">Estoque Dispon√≠vel:</span>
                            <span id="editar-estoque-disponivel" class="font-bold text-blue-900">0 UN</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade*</label>
                        <input type="number" id="editar-item-quantidade" step="1" min="1" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p id="editar-quantidade-aviso" class="text-xs text-red-600 mt-1 hidden">‚ö†Ô∏è Quantidade excede o estoque dispon√≠vel!</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pre√ßo Unit√°rio*</label>
                        <input type="number" id="editar-item-preco" step="0.01" min="0.01" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal:</span>
                            <span id="editar-item-subtotal" class="font-bold text-gray-900">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal('modal-editar-item')" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Salvar Altera√ß√µes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Item -->
    <div id="modal-item" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center px-6 py-4 border-b sticky top-0 bg-white z-10">
                <h3 class="text-lg font-semibold text-gray-900">Adicionar Itens</h3>
                <button onclick="closeModal('modal-item')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="px-6 py-4">
                <!-- Sele√ß√£o de Marca e Produto -->
                <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marca*</label>
                        <select id="item-marca" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="carregarProdutosPorMarca()">
                            <option value="">Selecione a marca...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Produto*</label>
                        <select id="item-produto" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="carregarSaboresProduto()" disabled>
                            <option value="">Selecione o produto...</option>
                        </select>
                    </div>
                </div>

                <!-- Lista de Sabores para Venda -->
                <div id="area-adicionar-sabor" class="hidden">
                    <h4 class="font-semibold text-gray-900 mb-3">Sabores do Produto</h4>
                    <p class="text-sm text-gray-600 mb-3">Informe a quantidade e pre√ßo para os sabores que deseja vender:</p>
                    
                    <!-- Replica√ß√£o de Pre√ßo -->
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-end gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-blue-900 mb-1">Pre√ßo de Venda Padr√£o</label>
                                <input type="number" step="0.01" min="0.01" id="preco-padrao-replicar" 
                                    class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500" 
                                    placeholder="0.00">
                            </div>
                            <div>
                                <button type="button" onclick="replicarPrecoTodosSabores()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium whitespace-nowrap">
                                    Aplicar a Todos
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-blue-700 mt-2">üí° Digite um pre√ßo e clique em "Aplicar a Todos" para replicar para todos os sabores</p>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden max-h-96 overflow-y-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left w-1/3">Sabor</th>
                                    <th class="px-3 py-2 text-left">Estoque Atual</th>
                                    <th class="px-3 py-2 text-left">Quantidade</th>
                                    <th class="px-3 py-2 text-left">Pre√ßo Un.</th>
                                    <th class="px-3 py-2 text-left">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-sabores-lista"></tbody>
                        </table>
                    </div>
                    
                    <!-- Resumo com Quantidade e Total -->
                    <div class="mt-3 space-y-2">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center">
                            <span class="text-sm font-medium text-blue-800">Quantidade Total:</span>
                            <span id="quantidade-modal-total" class="font-bold text-lg text-blue-900">0 UN</span>
                        </div>
                        <div class="p-3 bg-green-50 border border-green-200 rounded-lg flex justify-between items-center">
                            <span class="text-sm font-medium text-green-800">Total da Venda:</span>
                            <span id="total-venda" class="font-bold text-xl text-green-900">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="cancelarEFecharModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="button" onclick="salvarTodosSabores()" id="btn-salvar-todos" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden">Salvar Venda</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Rejeitar -->
    <div id="modal-rejeitar" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Rejeitar Venda</h3>
                <button onclick="closeModal('modal-rejeitar')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="form-rejeitar" class="px-6 py-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da Rejei√ß√£o*</label>
                    <textarea id="motivo-rejeicao" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Descreva o motivo..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('modal-rejeitar')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Rejeitar Venda</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div id="modal-pagamento" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Registrar Pagamento</h3>
                <button onclick="closeModal('modal-pagamento')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="form-pagamento" class="px-6 py-4">
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm text-gray-600">Total da Venda:</span>
                        <span id="pagamento-total" class="font-bold text-lg">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">J√° Pago:</span>
                        <span id="pagamento-ja-pago" class="font-medium text-green-600">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t">
                        <span class="text-sm font-medium text-gray-700">Pendente:</span>
                        <span id="pagamento-pendente" class="font-bold text-lg text-orange-600">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor Recebido*</label>
                        <input type="number" step="0.01" id="valor-pagamento" required min="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="0.00" oninput="atualizarRestante()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Forma de Pagamento</label>
                        <select id="forma-pagamento" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="DINHEIRO">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="CARTAO_CREDITO">Cart√£o de Cr√©dito</option>
                            <option value="CARTAO_DEBITO">Cart√£o de D√©bito</option>
                            <option value="TRANSFERENCIA">Transfer√™ncia</option>
                            <option value="OUTRO">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√£o</label>
                        <textarea id="obs-pagamento" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Observa√ß√µes sobre o pagamento..."></textarea>
                    </div>
                    <div id="info-restante" class="p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <p class="text-sm text-blue-800">Restar√° pendente: <span id="valor-restante" class="font-bold">R$ 0,00</span></p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal('modal-pagamento')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Registrar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Alterar Pre√ßo em Lote -->
    <div id="modal-alterar-preco-lote" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Alterar Pre√ßo em Lote</h3>
                <button onclick="closeModal('modal-alterar-preco-lote')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="form-alterar-preco-lote" class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o Produto*</label>
                    <select id="select-produto-lote" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="atualizarInfoProdutoLote()" required>
                        <option value="">Selecione um produto...</option>
                    </select>
                    <p id="info-itens-produto" class="text-xs text-gray-500 mt-1 hidden"></p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Novo Pre√ßo Unit√°rio*</label>
                    <input type="number" id="novo-preco-lote" step="0.01" min="0.01" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                        placeholder="0.00" oninput="calcularNovoTotalLote()">
                </div>

                <div id="preview-alteracao-lote" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                    <h4 class="font-medium text-sm text-blue-900 mb-2">Pr√©via da Altera√ß√£o:</h4>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Atual:</span>
                            <span id="total-atual-lote" class="font-medium">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Novo Total:</span>
                            <span id="novo-total-lote" class="font-bold text-blue-600">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between pt-2 border-t border-blue-300">
                            <span class="text-gray-600">Diferen√ßa:</span>
                            <span id="diferenca-lote" class="font-bold">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
                    <p class="text-xs text-yellow-800">‚ö†Ô∏è Esta a√ß√£o ir√° atualizar o pre√ßo de TODOS os itens (sabores) deste produto na venda.</p>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('modal-alterar-preco-lote')" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Aplicar Altera√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg"><div class="spinner mx-auto"></div><p class="mt-4 text-gray-700">Carregando...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/services/pedidos.js"></script>
    <script src="../js/services/produtos.js"></script>
    <script src="../js/services/impressao.js"></script>
    <script src="../js/services/whatsapp.js"></script>
    <script src="../js/services/focus-nfe.js"></script>
    <script src="../js/services/nuvem-fiscal.js"></script>
    <script src="../js/services/fiscal.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../components/modal.js"></script>
    
    <script>
        let vendaId = null;
        let venda = null;
        let itens = [];
        let produtos = [];
        let currentUser = null;
        let empresaConfig = null;
        let saboresTemporarios = []; // Lista tempor√°ria de sabores antes de salvar
        let produtoAtual = null; // Produto selecionado no modal

        (async () => {
            await checkAuth();
            currentUser = await getCurrentUser();
            
            // Carregar configura√ß√µes da empresa
            empresaConfig = await getEmpresaConfig();
            
            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();
            
            // Obter ID da venda
            const params = new URLSearchParams(window.location.search);
            vendaId = params.get('id');
            const origem = params.get('origem');
            
            // Configurar p√°gina de retorno
            window.voltarParaLista = function() {
                if (origem === 'pendentes') {
                    window.location.href = '/pages/vendas-pendentes.html';
                } else {
                    window.location.href = '/pages/vendas.html';
                }
            };
            
            // Configurar bot√£o voltar
            document.getElementById('btn-voltar').onclick = function(e) {
                e.preventDefault();
                voltarParaLista();
            };
            
            if (!vendaId) {
                showToast('Venda n√£o encontrada', 'error');
                setTimeout(() => voltarParaLista(), 2000);
                return;
            }
            
            await loadVenda();
            await loadMarcasSelect();
        })();

        // Carregar marcas no select
        async function loadMarcasSelect() {
            try {
                showLoading(true);
                const marcas = await getMarcas();
                const selectMarca = document.getElementById('item-marca');
                selectMarca.innerHTML = '<option value="">Selecione a marca...</option>';
                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca.id;
                    option.textContent = marca.nome;
                    selectMarca.appendChild(option);
                });
            } finally {
                showLoading(false);
            }
        }

        // Carregar produtos ao selecionar marca
        async function carregarProdutosPorMarca() {
            const marca = document.getElementById('item-marca').value;
            const selectProduto = document.getElementById('item-produto');
            const areaSabores = document.getElementById('area-adicionar-sabor');
            
            console.log('Marca selecionada:', marca);
            
            // Resetar select de produto
            selectProduto.innerHTML = '<option value="">Selecione o produto...</option>';
            
            // Ocultar √°rea de sabores e limpar tabela
            if (areaSabores) {
                areaSabores.classList.add('hidden');
                const tbody = document.getElementById('tbody-sabores-lista');
                if (tbody) tbody.innerHTML = '';
            }
            
            if (!marca) {
                selectProduto.disabled = true;
                return;
            }
            
            try {
                showLoading(true);
                const produtos = await getProdutosPorMarca(marca);
                console.log('Produtos encontrados:', produtos);
                
                if (produtos.length === 0) {
                    showToast('Nenhum produto encontrado para esta marca', 'warning');
                    selectProduto.disabled = true;
                    return;
                }
                
                produtos.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nome}`;
                    option.dataset.preco = p.preco_venda || p.preco || 0;
                    option.dataset.exigeEstoque = p.exige_estoque !== false ? 'true' : 'false'; // Default true
                    selectProduto.appendChild(option);
                });
                
                selectProduto.disabled = false;
                console.log('Select produto habilitado');
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                showToast('Erro ao carregar produtos', 'error');
                selectProduto.disabled = true;
            } finally {
                showLoading(false);
            }
        }

        // Carregar sabores ao selecionar produto
        async function carregarSaboresProduto() {
            const produtoId = document.getElementById('item-produto').value;
            const areaAdicionar = document.getElementById('area-adicionar-sabor');
            
            if (!produtoId) {
                areaAdicionar.classList.add('hidden');
                return;
            }
            
            try {
                showLoading(true);
                // Pegar dados do produto selecionado
                const selectProduto = document.getElementById('item-produto');
                const option = selectProduto.options[selectProduto.selectedIndex];
                produtoAtual = {
                    id: produtoId,
                    nome: option.textContent,
                    preco: parseFloat(option.dataset.preco || 0),
                    exige_estoque: option.dataset.exigeEstoque !== 'false' // Default true
                };
                
                const sabores = await getSaboresProduto(produtoId);
                if (sabores.length === 0) {
                    showToast('Este produto n√£o possui sabores cadastrados', 'warning');
                    areaAdicionar.classList.add('hidden');
                    return;
                }
                
                // Ordenar sabores alfabeticamente
                sabores.sort((a, b) => a.sabor.localeCompare(b.sabor));
                
                // Renderizar lista de sabores
                await renderListaSabores(sabores);
                
                // Mostrar √°rea e bot√£o de salvar
                areaAdicionar.classList.remove('hidden');
                document.getElementById('btn-salvar-todos').classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        }

        // Renderizar lista de sabores com campos de quantidade
        async function renderListaSabores(sabores) {
            const tbody = document.getElementById('tbody-sabores-lista');
            
            // Buscar itens j√° adicionados neste pedido para descontar do estoque dispon√≠vel
            const itensJaAdicionados = {};
            for (const item of itens) {
                if (item.sabor_id) {
                    itensJaAdicionados[item.sabor_id] = (itensJaAdicionados[item.sabor_id] || 0) + item.quantidade;
                }
            }
            
            // Calcular estoque dispon√≠vel considerando itens j√° adicionados
            const saboresComEstoqueDisponivel = sabores.map(s => {
                const quantidadeJaUsada = itensJaAdicionados[s.id] || 0;
                const estoqueDisponivel = s.quantidade - quantidadeJaUsada;
                return {
                    ...s,
                    estoqueDisponivel: Math.max(0, estoqueDisponivel),
                    estoqueOriginal: s.quantidade
                };
            });
            
            // Filtrar apenas sabores com estoque dispon√≠vel > 0
            const saboresComEstoque = saboresComEstoqueDisponivel.filter(s => s.estoqueDisponivel > 0);
            
            if (saboresComEstoque.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Nenhum sabor com estoque dispon√≠vel</td></tr>';
                document.getElementById('btn-salvar-todos').classList.add('hidden');
                return;
            }
            
            tbody.innerHTML = saboresComEstoque.map(s => `
                <tr class="border-t hover:bg-gray-50">
                    <td class="px-3 py-3 font-medium">${s.sabor}</td>
                    <td class="px-3 py-3 text-gray-600">
                        <span class="font-semibold">${s.estoqueDisponivel} UN</span>
                        <span class="text-xs text-gray-500 block">Total: ${s.estoqueOriginal} UN</span>
                    </td>
                    <td class="px-3 py-3">
                        <input type="number" 
                            step="1" 
                            min="0" 
                            max="${s.estoqueDisponivel}"
                            value="0"
                            data-sabor-id="${s.id}"
                            data-sabor-nome="${s.sabor}"
                            data-estoque="${s.estoqueDisponivel}"
                            class="sabor-quantidade w-24 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-green-500" 
                            placeholder="0"
                            oninput="validarEstoqueVenda(this); calcularTotalVenda()">
                    </td>
                    <td class="px-3 py-3">
                        <input type="number" 
                            step="0.01" 
                            min="0.01" 
                            value="${produtoAtual.preco.toFixed(2)}"
                            data-sabor-id="${s.id}"
                            class="sabor-preco w-24 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-green-500" 
                            placeholder="0.00"
                            oninput="calcularTotalVenda()">
                    </td>
                    <td class="px-3 py-3">
                        <span class="sabor-subtotal font-medium text-gray-900" data-sabor-id="${s.id}">R$ 0,00</span>
                    </td>
                </tr>
            `).join('');
            
            calcularTotalVenda();
        }

        // Validar estoque dispon√≠vel para venda
        function validarEstoqueVenda(input) {
            const quantidade = parseFloat(input.value) || 0;
            const estoqueDisponivel = parseFloat(input.dataset.estoque || 0);
            
            // üîì Pular valida√ß√£o se exige_estoque = false (servi√ßos, vouchers, etc)
            if (produtoAtual && produtoAtual.exige_estoque === false) {
                console.log(`‚ÑπÔ∏è Produto ${produtoAtual.nome} n√£o exige valida√ß√£o de estoque`);
                return; // N√£o validar
            }
            
            if (quantidade > estoqueDisponivel) {
                input.value = estoqueDisponivel;
                showToast(`Estoque insuficiente! Dispon√≠vel: ${estoqueDisponivel} UN`, 'warning');
            }
        }

        // Calcular total da venda
        function calcularTotalVenda() {
            let total = 0;
            let quantidadeTotal = 0;
            
            const quantidadeInputs = document.querySelectorAll('.sabor-quantidade');
            quantidadeInputs.forEach(input => {
                const saborId = input.dataset.saborId;
                const quantidade = parseFloat(input.value) || 0;
                const precoInput = document.querySelector(`.sabor-preco[data-sabor-id="${saborId}"]`);
                const preco = parseFloat(precoInput.value) || 0;
                const subtotal = quantidade * preco;
                
                // Atualizar subtotal do sabor
                const subtotalSpan = document.querySelector(`.sabor-subtotal[data-sabor-id="${saborId}"]`);
                subtotalSpan.textContent = formatCurrency(subtotal);
                
                total += subtotal;
                quantidadeTotal += quantidade;
            });
            
            document.getElementById('total-venda').textContent = formatCurrency(total);
            document.getElementById('quantidade-modal-total').textContent = `${Math.round(quantidadeTotal)} UN`;
        }
        
        // Replicar pre√ßo para todos os sabores
        function replicarPrecoTodosSabores() {
            const precoReplicar = parseFloat(document.getElementById('preco-padrao-replicar').value);
            
            if (!precoReplicar || precoReplicar <= 0) {
                showToast('Informe um pre√ßo v√°lido para replicar', 'warning');
                return;
            }
            
            // Aplicar o pre√ßo em todos os inputs de pre√ßo
            const precoInputs = document.querySelectorAll('.sabor-preco');
            precoInputs.forEach(input => {
                input.value = precoReplicar.toFixed(2);
            });
            
            // Recalcular totais
            calcularTotalVenda();
            
            showToast(`Pre√ßo R$ ${precoReplicar.toFixed(2)} aplicado a todos os sabores!`, 'success');
        }

        // Atualizar estoque quando selecionar sabor (n√£o usado mais)
        function atualizarEstoqueSabor() {
            // Fun√ß√£o mantida para compatibilidade mas n√£o √© mais usada
        }

        // Adicionar sabor na lista tempor√°ria (n√£o usado mais)
        function adicionarSaborNaLista() {
            // Fun√ß√£o mantida para compatibilidade mas n√£o √© mais usada
        }
        
        // Renderizar lista de sabores tempor√°rios (n√£o usado mais)
        function renderSaboresTemporarios() {
            // Fun√ß√£o mantida para compatibilidade mas n√£o √© mais usada
        }
        
        // Remover sabor da lista tempor√°ria (n√£o usado mais)
        function removerSaborTemporario(index) {
            // Fun√ß√£o mantida para compatibilidade mas n√£o √© mais usada
        }
        
        // Salvar todos os sabores de uma vez
        async function salvarTodosSabores() {
            // ‚úÖ PROTE√á√ÉO: Impedir cliques duplos
            const btnSalvar = document.getElementById('btn-salvar-todos');
            if (btnSalvar.disabled) {
                console.warn('‚ö†Ô∏è Salvamento j√° em andamento, ignorando clique duplo');
                return;
            }
            
            btnSalvar.disabled = true;
            btnSalvar.textContent = '‚è≥ Salvando...';
            btnSalvar.classList.add('opacity-50', 'cursor-not-allowed');
            
            showLoading(true);
            try {
                // Coletar todos os sabores com quantidade > 0
                const quantidadeInputs = document.querySelectorAll('.sabor-quantidade');
                const saboresParaSalvar = [];
                
                quantidadeInputs.forEach(input => {
                    const quantidade = parseFloat(input.value) || 0;
                    if (quantidade > 0) {
                        const saborId = input.dataset.saborId;
                        const saborNome = input.dataset.saborNome;
                        const estoqueDisponivel = parseFloat(input.dataset.estoque || 0);
                        const precoInput = document.querySelector(`.sabor-preco[data-sabor-id="${saborId}"]`);
                        const preco = parseFloat(precoInput.value) || 0;
                        
                        if (preco > 0) {
                            // Validar estoque novamente antes de salvar
                            if (quantidade > estoqueDisponivel) {
                                throw new Error(`Estoque insuficiente para ${saborNome}! Dispon√≠vel: ${estoqueDisponivel}`);
                            }
                            
                            saboresParaSalvar.push({
                                sabor_id: saborId,
                                sabor_nome: saborNome,
                                quantidade: quantidade,
                                preco_unitario: preco
                            });
                        }
                    }
                });
                
                if (saboresParaSalvar.length === 0) {
                    showToast('Informe a quantidade e pre√ßo para pelo menos um sabor', 'warning');
                    return;
                }
                
                console.log('üì¶ Salvando', saboresParaSalvar.length, 'sabor(es)...');
                
                // Salvar cada sabor
                for (const sabor of saboresParaSalvar) {
                    const itemData = {
                        produto_id: produtoAtual.id,
                        sabor_id: sabor.sabor_id,
                        quantidade: sabor.quantidade,
                        preco_unitario: sabor.preco_unitario
                    };
                    
                    console.log('  ‚Üí Adicionando:', sabor.sabor_nome, '-', sabor.quantidade, 'UN');
                    
                    const result = await addItemPedido(vendaId, itemData);
                    if (!result) {
                        throw new Error('Erro ao adicionar item');
                    }
                }
                
                console.log('‚úÖ Todos os sabores salvos com sucesso!');
                showToast(`${saboresParaSalvar.length} sabor(es) adicionado(s) com sucesso!`, 'success');
                
                // ‚úÖ RECALCULAR O TOTAL DO PEDIDO
                console.log('üîÑ Recalculando total da venda...');
                await recalcularTotalPedido(vendaId);
                
                // Resetar modal
                cancelarEFecharModal();
                
                // Recarregar venda
                await loadVenda();
            } catch (error) {
                handleError(error, 'Erro ao salvar sabores');
            } finally {
                showLoading(false);
                // Reabilitar bot√£o
                btnSalvar.disabled = false;
                btnSalvar.textContent = 'Salvar Venda';
                btnSalvar.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Cancelar e fechar modal
        function cancelarEFecharModal() {
            saboresTemporarios = [];
            produtoAtual = null;
            document.getElementById('item-marca').value = '';
            document.getElementById('item-produto').value = '';
            document.getElementById('item-produto').disabled = true;
            document.getElementById('item-produto').innerHTML = '<option value="">Selecione o produto...</option>';
            document.getElementById('tbody-sabores-lista').innerHTML = '';
            document.getElementById('total-venda').textContent = 'R$ 0,00';
            document.getElementById('area-adicionar-sabor').classList.add('hidden');
            document.getElementById('btn-salvar-todos').classList.add('hidden');
            closeModal('modal-item');
        }

        // Validar estoque dispon√≠vel (n√£o usado mais)
        function validarEstoqueDisponivel() {
            // Fun√ß√£o mantida para compatibilidade mas n√£o √© mais usada
        }

        async function loadVenda() {
            try {
                showLoading(true);
                
                // Buscar venda diretamente da tabela vendas
                const { data: vendaData, error: vendaError } = await supabase
                    .from('vendas')
                    .select(`
                        *,
                        operador:users!vendas_operador_id_fkey(id, full_name),
                        cliente:clientes(id, nome)
                    `)
                    .eq('id', vendaId)
                    .single();
                
                if (vendaError || !vendaData) {
                    console.error('Erro ao carregar venda:', vendaError);
                    showToast('Venda n√£o encontrada', 'error');
                    setTimeout(() => window.location.href = '/pages/vendas.html', 2000);
                    return;
                }
                
                venda = vendaData;
                
                console.log('üîç Carregando itens da venda (vers√£o corrigida)...');
                
                // Buscar itens da venda
                const { data: itensData, error: itensError } = await supabase
                    .from('venda_itens')
                    .select('*')
                    .eq('venda_id', vendaId);
                
                console.log('üì¶ Itens carregados:', itensData?.length || 0);
                
                if (itensError) {
                    console.error('‚ùå Erro ao carregar itens:', itensError);
                    itens = [];
                } else {
                    itens = itensData || [];
                    
                    console.log('üîÑ Carregando produtos para cada item...');
                    
                    // Buscar produtos para cada item separadamente
                    for (let item of itens) {
                        if (item.produto_id) {
                            const { data: produto, error: prodError } = await supabase
                                .from('produtos')
                                .select('id, nome, descricao, codigo, codigo_barras, preco_venda, estoque_atual, unidade')
                                .eq('id', item.produto_id)
                                .single();
                            
                            if (prodError) {
                                console.error('‚ùå Erro ao buscar produto:', item.produto_id, prodError);
                            } else {
                                item.produtos = produto;
                                console.log('‚úÖ Produto carregado:', produto?.nome);
                            }
                        }
                    }
                    
                    console.log('‚úÖ Todos os produtos carregados!');
                }
                
                renderVenda();
                await renderItens();
                renderAcoes();
            } catch (error) {
                console.error('Erro ao carregar venda:', error);
                showToast('Erro ao carregar venda: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderVenda() {
            document.getElementById('venda-numero').textContent = venda.numero || '-';
            document.getElementById('venda-status').textContent = venda.status || 'FINALIZADA';
            
            // Calcular total baseado nos itens carregados
            const totalCalculado = itens.reduce((sum, item) => sum + (item.total || item.subtotal || 0), 0);
            const quantidadeTotal = itens.reduce((sum, item) => sum + (item.quantidade || 0), 0);
            
            // Usar o total da venda (√© o valor que foi realmente cobrado)
            document.getElementById('venda-total').textContent = formatCurrency(venda.total || 0);
            document.getElementById('venda-quantidade-total').textContent = `${quantidadeTotal.toFixed(2)} UN`;
            
            document.getElementById('venda-vendedor').textContent = venda.operador?.full_name || '-';
            document.getElementById('venda-cliente').textContent = venda.cliente?.nome || 'Cliente n√£o informado';
            document.getElementById('venda-data').textContent = formatDate(venda.created_at);
            
            // Observa√ß√µes
            const obsElement = document.getElementById('venda-observacoes');
            if (venda.observacoes && venda.observacoes.trim()) {
                obsElement.textContent = venda.observacoes;
            } else {
                obsElement.innerHTML = '<span class="text-gray-400 italic">Nenhuma observa√ß√£o</span>';
            }
            
            // Controle de visibilidade do bot√£o editar observa√ß√µes
            const btnEditarObs = document.getElementById('btn-editar-obs-venda');
            if (venda.status_venda === 'RASCUNHO' && (venda.operador_id === currentUser.id || currentUser.role === 'ADMIN')) {
                btnEditarObs.classList.remove('hidden');
            } else if (currentUser.role === 'ADMIN') {
                btnEditarObs.classList.remove('hidden');
            } else {
                btnEditarObs.classList.add('hidden');
            }
            
            // Mostrar informa√ß√µes de pagamento se a venda estiver finalizada
            if (venda.status === 'FINALIZADO') {
                document.getElementById('pagamento-info').classList.remove('hidden');
                document.getElementById('venda-valor-pago').textContent = formatCurrency(venda.valor_pago || 0);
                document.getElementById('venda-valor-pendente').textContent = formatCurrency(venda.valor_pendente || 0);
                
                const statusPagamento = document.getElementById('venda-pagamento-status');
                const status = venda.pagamento_status || 'PENDENTE';
                const statusTexts = {
                    'PENDENTE': { text: 'Pendente', color: 'text-red-600' },
                    'PARCIAL': { text: 'Parcial', color: 'text-orange-600' },
                    'PAGO': { text: 'Pago', color: 'text-green-600' }
                };
                statusPagamento.textContent = statusTexts[status].text;
                statusPagamento.className = `font-semibold ${statusTexts[status].color}`;
            }
            
            if (venda.observacoes) {
                document.getElementById('venda-observacoes').textContent = venda.observacoes;
            } else {
                document.getElementById('observacoes-card').style.display = 'none';
            }
            
            if (venda.aprovador) {
                document.getElementById('aprovador-info').classList.remove('hidden');
                document.getElementById('venda-aprovador').textContent = venda.aprovador.full_name;
            }
        }

        async function renderItens() {
            const tbody = document.getElementById('itens-tbody');
            
            // Controlar visibilidade da coluna de estoque
            const thEstoque = document.getElementById('th-estoque');
            const mostrarEstoque = venda.status !== 'FINALIZADO';
            
            if (thEstoque) {
                thEstoque.style.display = mostrarEstoque ? '' : 'none';
            }
            
            if (itens.length === 0) {
                const colspan = mostrarEstoque ? '6' : '5';
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="px-4 py-4 text-center text-gray-500 text-sm">Nenhum item adicionado</td></tr>`;
                document.getElementById('venda-quantidade-total').textContent = '0 UN';
                return;
            }
            
            // Calcular quantidade total de itens
            const quantidadeTotal = itens.reduce((sum, item) => sum + parseFloat(item.quantidade || 0), 0);
            document.getElementById('venda-quantidade-total').textContent = `${Math.round(quantidadeTotal)} UN`;
            
            // Buscar estoque atual para cada item
            const itensComEstoque = await Promise.all(itens.map(async (item) => {
                let estoqueAtual = 0;
                
                try {
                    if (item.sabor_id) {
                        // Produto com sabor - buscar estoque do sabor
                        const { data: sabor } = await supabase
                            .from('produto_sabores')
                            .select('quantidade')
                            .eq('id', item.sabor_id)
                            .single();
                        estoqueAtual = sabor?.quantidade || 0;
                    } else {
                        // Produto sem sabor - buscar estoque do produto
                        const { data: produto } = await supabase
                            .from('produtos')
                            .select('estoque_atual')
                            .eq('id', item.produto_id)
                            .single();
                        estoqueAtual = produto?.estoque_atual || 0;
                    }
                } catch (error) {
                    console.error('Erro ao buscar estoque:', error);
                }
                
                return { ...item, estoqueAtual };
            }));
            
            tbody.innerHTML = itensComEstoque.map(item => {
                const produtoNome = item.produtos?.nome || 'N/A';
                const produtoDescricao = item.produtos?.descricao || '';
                const produtoCodigo = item.produtos?.codigo || item.produtos?.codigo_barras || '';
                const sabor = item.sabor?.sabor ? ` - ${item.sabor.sabor}` : '';
                const quantidade = parseFloat(item.quantidade);
                const estoqueAtual = item.estoqueAtual;
                
                // Determinar status do estoque
                let estoqueClass = 'text-green-600';
                let estoqueIcon = '‚úÖ';
                let estoqueMensagem = '';
                
                if (estoqueAtual === 0) {
                    estoqueClass = 'text-red-600 font-semibold';
                    estoqueIcon = '‚ùå';
                    estoqueMensagem = 'Sem estoque!';
                } else if (estoqueAtual < quantidade) {
                    estoqueClass = 'text-orange-600 font-semibold';
                    estoqueIcon = '‚ö†Ô∏è';
                    const faltam = quantidade - estoqueAtual;
                    estoqueMensagem = `Faltam ${faltam}`;
                } else {
                    estoqueClass = 'text-green-600';
                    estoqueIcon = '‚úÖ';
                    estoqueMensagem = 'OK';
                }
                
                // Controlar visibilidade da coluna de estoque
                const mostrarEstoque = venda.status !== 'FINALIZADO';
                
                return `
                    <tr class="border-t">
                        <td class="px-4 py-3">
                            <div class="font-medium">${produtoNome}</div>
                            ${produtoDescricao ? `<div class="text-sm text-gray-600">${produtoDescricao}</div>` : ''}
                            ${sabor ? `<div class="text-xs text-gray-500">${sabor}</div>` : ''}
                            ${produtoCodigo ? `<div class="text-xs text-gray-500">C√≥d: ${produtoCodigo}</div>` : ''}
                        </td>
                        <td class="px-4 py-3">${item.quantidade} ${item.produtos?.unidade || ''}</td>
                        <td class="px-4 py-3 ${estoqueClass}" style="display: ${mostrarEstoque ? '' : 'none'}">
                            <div class="flex items-center gap-1">
                                <span>${estoqueIcon}</span>
                                <span>${estoqueAtual}</span>
                            </div>
                            <div class="text-xs">${estoqueMensagem}</div>
                        </td>
                        <td class="px-4 py-3">${formatCurrency(item.preco_unitario)}</td>
                        <td class="px-4 py-3 font-medium">${formatCurrency(item.subtotal)}</td>
                        <td class="px-4 py-3">
                            ${venda.status === 'RASCUNHO' ? `
                                <button onclick="editarItem('${item.id}', ${item.quantidade}, ${item.preco_unitario})" class="text-blue-600 hover:text-blue-800 text-sm mr-2" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="removerItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm" title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAcoes() {
            const acoesDiv = document.getElementById('acoes-venda');
            let botoes = [];
            
            // Bot√£o de impress√£o sempre vis√≠vel
            botoes.push('<button onclick="imprimirPedidoVenda(\'' + vendaId + '\')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">üñ®Ô∏è Imprimir</button>');
            
            // DEBUG: Verificar configura√ß√µes WhatsApp
            console.log('=== DEBUG WHATSAPP ===');
            console.log('empresaConfig:', empresaConfig);
            console.log('whatsapp_api_provider:', empresaConfig?.whatsapp_api_provider);
            console.log('whatsapp_api_url:', empresaConfig?.whatsapp_api_url);
            console.log('whatsapp_api_key:', empresaConfig?.whatsapp_api_key);
            console.log('venda.status_venda:', venda.status_venda);
            console.log('venda.cliente:', venda.cliente);
            console.log('venda.cliente?.whatsapp:', venda.cliente?.whatsapp);
            
            // Bot√£o de envio por WhatsApp
            const whatsappConfigurado = empresaConfig?.whatsapp_api_provider && empresaConfig?.whatsapp_api_url && empresaConfig?.whatsapp_api_key;
            const statusPermitido = venda.status_venda === 'FINALIZADO';
            const clienteTemWhatsApp = venda.cliente?.whatsapp;
            
            console.log('whatsappConfigurado:', whatsappConfigurado);
            console.log('statusPermitido:', statusPermitido);
            console.log('clienteTemWhatsApp:', clienteTemWhatsApp);
            console.log('=== FIM DEBUG ===');
            
            if (whatsappConfigurado && statusPermitido && clienteTemWhatsApp) {
                botoes.push('<button onclick="enviarPDFWhatsAppHandler()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">üì± Enviar WhatsApp</button>');
            }
            
            // DEBUG: Verificar status da venda
            console.log('===== DEBUG STATUS VENDA =====');
            console.log('venda.status:', venda.status);
            console.log('venda.status_venda:', venda.status_venda);
            console.log('venda.operador_id:', venda.operador_id);
            console.log('currentUser.id:', currentUser.id);
            console.log('currentUser.role:', currentUser.role);
            
            // Verificar status em ambos os campos
            const statusAtual = (venda.status || venda.status_venda || '').toUpperCase();
            const isRascunho = statusAtual === 'RASCUNHO';
            const isAdmin = currentUser.role === 'ADMIN';
            const isProprietario = venda.operador_id === currentUser.id;
            
            console.log('statusAtual:', statusAtual);
            console.log('isRascunho:', isRascunho);
            console.log('isAdmin:', isAdmin);
            console.log('isProprietario:', isProprietario);
            console.log('================================');
            
            const podeEditar = isRascunho && (isProprietario || isAdmin);
            console.log('podeEditar:', podeEditar);
            
            // Permite finalizar vendas em RASCUNHO (novo fluxo) ou APROVADO (pedidos antigos j√° aprovados)
            const podeFinalizar = ['RASCUNHO', 'APROVADO'].includes(statusAtual) && ['ADMIN', 'VENDEDOR'].includes(currentUser.role);
            
            if (podeEditar) {
                document.getElementById('btn-add-item').style.display = 'block';
                // Mostrar bot√£o de altera√ß√£o em lote se houver itens
                const btnAlterarPrecoLote = document.getElementById('btn-alterar-preco-lote');
                if (btnAlterarPrecoLote) {
                    btnAlterarPrecoLote.style.display = itens.length > 0 ? 'block' : 'none';
                }
                botoes.push('<button onclick="excluirVenda()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">üóëÔ∏è Excluir Venda</button>');
            } else {
                document.getElementById('btn-add-item').style.display = 'none';
                const btnAlterarPrecoLote = document.getElementById('btn-alterar-preco-lote');
                if (btnAlterarPrecoLote) {
                    btnAlterarPrecoLote.style.display = 'none';
                }
            }
            
            if (podeFinalizar) {
                botoes.push('<button onclick="finalizarVenda()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">‚úÖ Finalizar Venda</button>');
            }
            
            // Bot√£o para registrar pagamento (vendas finalizadas com saldo pendente)
            if (venda.status_venda === 'FINALIZADO' && venda.pagamento_status !== 'PAGO' && ['ADMIN', 'VENDEDOR'].includes(currentUser.role)) {
                const pendente = (venda.total || 0) - (venda.valor_pago || 0);
                if (pendente > 0) {
                    botoes.push(`<button onclick="abrirModalPagamento()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">üí∞ Registrar Pagamento</button>`);
                }
            }
            
            // Bot√£o de cancelar dispon√≠vel para ADMIN em vendas FINALIZADAS
            // Verificar tanto status quanto status_venda e aceitar FINALIZADO/FINALIZADA
            const statusVenda = (venda.status || venda.status_venda || '').toUpperCase();
            const isFinalizada = statusVenda === 'FINALIZADO' || statusVenda === 'FINALIZADA';
            
            console.log('===== DEBUG BOT√ÉO CANCELAR =====');
            console.log('venda.status:', venda.status);
            console.log('venda.status_venda:', venda.status_venda);
            console.log('statusVenda (uppercase):', statusVenda);
            console.log('isFinalizada:', isFinalizada);
            console.log('currentUser.role:', currentUser.role);
            console.log('Condi√ß√£o:', isFinalizada && currentUser.role === 'ADMIN');
            console.log('================================');
            
            if (isFinalizada && currentUser.role === 'ADMIN') {
                botoes.push('<button onclick="openModal(\'modal-cancelar\')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">üö´ Cancelar Venda</button>');
            }
            
            // Bot√£o de emitir nota fiscal para vendas finalizadas sem nota
            if (isFinalizada && ['ADMIN', 'VENDEDOR'].includes(currentUser.role)) {
                if (!venda.nfce_referencia && !venda.status_fiscal) {
                    botoes.push('<button onclick="emitirNotaFiscal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">üìÑ Emitir NFC-e</button>');
                } else if (venda.nfce_referencia || venda.status_fiscal === 'EMITIDA_NFCE') {
                    botoes.push('<button onclick="imprimirNotaFiscal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">üñ®Ô∏è Imprimir NFC-e</button>');
                }
            }
            
            acoesDiv.innerHTML = botoes.join('');
        }

        window.removerItem = async function(itemId) {
            if (confirm('Deseja remover este item?')) {
                try {
                    showLoading(true);
                    const success = await deleteItemPedido(itemId);
                    if (success) await loadVenda();
                } finally {
                    showLoading(false);
                }
            }
        };

        window.editarItem = async function(itemId, quantidadeAtual, precoAtual) {
            // Buscar informa√ß√µes completas do item
            const item = itens.find(i => i.id === itemId);
            if (!item) {
                showToast('Item n√£o encontrado', 'error');
                return;
            }

            // Preencher o modal
            document.getElementById('editar-item-id').value = itemId;
            
            const produtoNome = item.produto?.nome || 'N/A';
            const sabor = item.sabor?.sabor ? ` - ${item.sabor.sabor}` : '';
            document.getElementById('editar-item-nome').value = produtoNome + sabor;
            
            const inputQuantidade = document.getElementById('editar-item-quantidade');
            inputQuantidade.value = quantidadeAtual;
            
            // üîì Guardar se produto exige estoque (para usar na valida√ß√£o)
            const produtoExigeEstoque = item.produto?.exige_estoque !== false; // Default true
            inputQuantidade.dataset.exigeEstoque = produtoExigeEstoque;
            
            // Buscar estoque atual do sabor
            if (item.sabor_id) {
                try {
                    const { data: saborAtual } = await supabase
                        .from('produto_sabores')
                        .select('quantidade')
                        .eq('id', item.sabor_id)
                        .single();
                    
                    if (saborAtual) {
                        // Calcular quanto deste sabor j√° est√° sendo usado em outros itens do pedido
                        let quantidadeJaUsadaEmOutrosItens = 0;
                        for (const outroItem of itens) {
                            if (outroItem.sabor_id === item.sabor_id && outroItem.id !== itemId) {
                                quantidadeJaUsadaEmOutrosItens += outroItem.quantidade;
                            }
                        }
                        
                        // Estoque dispon√≠vel = estoque atual - quantidade usada em outros itens
                        // (n√£o contamos o item atual pois ele est√° sendo editado)
                        const estoqueDisponivel = saborAtual.quantidade - quantidadeJaUsadaEmOutrosItens;
                        inputQuantidade.max = estoqueDisponivel;
                        inputQuantidade.dataset.estoqueMax = estoqueDisponivel;
                        inputQuantidade.dataset.quantidadeOriginal = quantidadeAtual;
                        inputQuantidade.dataset.saborId = item.sabor_id;
                        
                        // Mostrar informa√ß√£o de estoque dispon√≠vel (somente se exige_estoque = true)
                        if (produtoExigeEstoque) {
                            document.getElementById('editar-estoque-info').classList.remove('hidden');
                            document.getElementById('editar-estoque-disponivel').textContent = `${estoqueDisponivel} UN`;
                        } else {
                            // Ocultar if produto n√£o exige estoque
                            document.getElementById('editar-estoque-info').classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Erro ao buscar estoque:', error);
                }
            } else {
                // Se n√£o tem sabor_id, ocultar info de estoque
                document.getElementById('editar-estoque-info').classList.add('hidden');
            }
            
            document.getElementById('editar-item-preco').value = precoAtual;
            
            // Calcular e mostrar subtotal
            atualizarSubtotalEdicao();
            
            // Abrir modal
            openModal('modal-editar-item');
        };

        function atualizarSubtotalEdicao() {
            const inputQuantidade = document.getElementById('editar-item-quantidade');
            const quantidade = parseFloat(inputQuantidade.value) || 0;
            const estoqueMax = parseFloat(inputQuantidade.dataset.estoqueMax);
            const avisoElement = document.getElementById('editar-quantidade-aviso');
            
            // Validar estoque se houver limite configurado
            if (estoqueMax && quantidade > estoqueMax) {
                // Mostrar aviso visual
                avisoElement.classList.remove('hidden');
                inputQuantidade.classList.add('border-red-500', 'bg-red-50');
                inputQuantidade.classList.remove('border-gray-300');
            } else {
                // Ocultar aviso e remover estilo de erro
                avisoElement.classList.add('hidden');
                inputQuantidade.classList.remove('border-red-500', 'bg-red-50');
                inputQuantidade.classList.add('border-gray-300');
            }
            
            const quantidadeFinal = parseFloat(inputQuantidade.value) || 0;
            const preco = parseFloat(document.getElementById('editar-item-preco').value) || 0;
            const subtotal = quantidadeFinal * preco;
            document.getElementById('editar-item-subtotal').textContent = formatCurrency(subtotal);
        }

        // Event listeners para atualizar subtotal em tempo real
        document.getElementById('editar-item-quantidade').addEventListener('input', atualizarSubtotalEdicao);
        document.getElementById('editar-item-preco').addEventListener('input', atualizarSubtotalEdicao);

        // Form de edi√ß√£o de item
        document.getElementById('form-editar-item').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemId = document.getElementById('editar-item-id').value;
            const inputQuantidade = document.getElementById('editar-item-quantidade');
            const quantidade = parseFloat(inputQuantidade.value);
            const preco = parseFloat(document.getElementById('editar-item-preco').value);

            if (quantidade <= 0 || preco <= 0) {
                showToast('Quantidade e pre√ßo devem ser maiores que zero', 'error');
                return;
            }

            // üîì Validar estoque apenas se exige_estoque = true
            const exigeEstoque = inputQuantidade.dataset.exigeEstoque !== 'false';
            if (exigeEstoque) {
                const estoqueMax = parseFloat(inputQuantidade.dataset.estoqueMax);
                if (estoqueMax && quantidade > estoqueMax) {
                    showToast(`Estoque insuficiente! M√°ximo dispon√≠vel: ${estoqueMax} UN`, 'error');
                    return;
                }
            } else {
                console.log('‚ÑπÔ∏è Produto n√£o exige valida√ß√£o de estoque, skipping check');
            }

            try {
                showLoading(true);
                
                console.log('üìù Atualizando item da venda:', itemId, {quantidade, preco});
                
                const { data, error } = await supabase
                    .from('venda_itens')
                    .update({
                        quantidade: quantidade,
                        preco_unitario: preco
                        // subtotal √© calculado automaticamente pelo banco (coluna GENERATED)
                    })
                    .eq('id', itemId)
                    .select();

                if (error) {
                    console.error('‚ùå Erro no Supabase:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum item foi atualizado. Poss√≠vel problema de RLS.');
                    throw new Error('N√£o foi poss√≠vel atualizar o item. Verifique suas permiss√µes.');
                }

                console.log('‚úÖ Item atualizado:', data);
                
                // ‚úÖ RECALCULAR O TOTAL DO PEDIDO
                console.log('üîÑ Recalculando total da venda...');
                await recalcularTotalPedido(vendaId);
                
                showToast('Item atualizado com sucesso!', 'success');
                closeModal('modal-editar-item');
                await loadVenda();
            } catch (error) {
                console.error('‚ùå Erro completo ao atualizar item:', error);
                const mensagemErro = error.message || 'Erro ao atualizar item';
                showToast(mensagemErro, 'error');
            } finally {
                showLoading(false);
            }
        });

        // Fun√ß√µes de aprova√ß√£o removidas - vendas agora finalizam diretamente do RASCUNHO

        function abrirModalPagamento() {
            document.getElementById('pagamento-total').textContent = formatCurrency(venda.total || 0);
            document.getElementById('pagamento-ja-pago').textContent = formatCurrency(venda.valor_pago || 0);
            const pendente = (venda.total || 0) - (venda.valor_pago || 0);
            document.getElementById('pagamento-pendente').textContent = formatCurrency(pendente);
            document.getElementById('valor-pagamento').value = pendente.toFixed(2);
            document.getElementById('valor-pagamento').max = pendente.toFixed(2);
            atualizarRestante();
            openModal('modal-pagamento');
        }

        function atualizarRestante() {
            const total = venda.total || 0;
            const jaPago = venda.valor_pago || 0;
            const pendente = total - jaPago;
            const valorDigitado = parseFloat(document.getElementById('valor-pagamento').value) || 0;
            const restante = pendente - valorDigitado;
            
            const infoRestante = document.getElementById('info-restante');
            const valorRestante = document.getElementById('valor-restante');
            
            if (valorDigitado > 0 && valorDigitado < pendente) {
                infoRestante.classList.remove('hidden');
                valorRestante.textContent = formatCurrency(restante);
            } else {
                infoRestante.classList.add('hidden');
            }
        }

        document.getElementById('form-pagamento').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const valorPagamento = parseFloat(document.getElementById('valor-pagamento').value);
            const formaPagamento = document.getElementById('forma-pagamento').value;
            const observacao = document.getElementById('obs-pagamento').value;
            
            const total = venda.total || 0;
            const jaPago = venda.valor_pago || 0;
            const pendente = total - jaPago;
            
            if (valorPagamento > pendente) {
                showToast('Valor informado √© maior que o pendente', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const novoValorPago = jaPago + valorPagamento;
                const novoValorPendente = total - novoValorPago;
                const pagamentoCompleto = novoValorPendente <= 0;
                
                // Registrar pagamento
                const { error: pagamentoError } = await supabase
                    .from('pagamentos_venda')
                    .insert({
                        venda_id: vendaId,
                        valor: valorPagamento,
                        forma_pagamento: formaPagamento,
                        observacao: observacao,
                        usuario_id: currentUser.id
                    });
                
                if (pagamentoError) throw pagamentoError;
                
                // Atualizar pedido
                const updateData = {
                    valor_pago: novoValorPago,
                    valor_pendente: novoValorPendente,
                    pagamento_status: pagamentoCompleto ? 'PAGO' : 'PARCIAL'
                };
                
                if (pagamentoCompleto) {
                    updateData.data_pagamento_completo = new Date().toISOString();
                }
                
                const { error: pedidoError } = await supabase
                    .from('vendas')
                    .update(updateData)
                    .eq('id', vendaId);
                
                if (pedidoError) throw pedidoError;
                
                showToast(`Pagamento de ${formatCurrency(valorPagamento)} registrado com sucesso!`, 'success');
                closeModal('modal-pagamento');
                document.getElementById('form-pagamento').reset();
                await loadVenda();
                
            } catch (error) {
                handleError(error, 'Erro ao registrar pagamento');
            } finally {
                showLoading(false);
            }
        });

        // Emitir NFC-e para venda finalizada
        async function emitirNotaFiscal() {
            try {
                showLoading(true);
                
                // Validar se venda est√° finalizada
                const statusVenda = (venda.status || venda.status_venda || '').toUpperCase();
                if (statusVenda !== 'FINALIZADO' && statusVenda !== 'FINALIZADA') {
                    throw new Error('Apenas vendas finalizadas podem ter nota fiscal emitida');
                }
                
                // Validar se j√° tem nota
                if (venda.nfce_referencia || venda.status_fiscal === 'EMITIDA_NFCE') {
                    throw new Error('Esta venda j√° possui nota fiscal emitida');
                }
                
                // Validar itens
                if (!itens || itens.length === 0) {
                    throw new Error('N√£o √© poss√≠vel emitir nota sem itens');
                }
                
                console.log('üì§ [VENDA] Preparando emiss√£o de NFC-e...');
                
                // Preparar dados da venda
                const vendaNFe = {
                    numero_venda: venda.numero,
                    subtotal: venda.subtotal || 0,
                    desconto_valor: venda.desconto_valor || 0,
                    total: venda.total || 0,
                    data_emissao: new Date().toISOString()
                };
                
                // Preparar itens para NFCe
                const itensNFe = itens.map(item => ({
                    produto_id: item.produto_id,
                    codigo_barras: item.produtos?.codigo_barras || item.produtos?.sku || item.produto_id.substring(0, 13),
                    descricao: item.produtos?.nome || item.nome || 'PRODUTO',
                    ncm: item.produtos?.ncm || '22021000',
                    cfop: item.produtos?.cfop || '5102',
                    cst_icms: item.produtos?.cst_icms || '102',
                    unidade: item.unidade_medida || 'UN',
                    quantidade: item.quantidade,
                    preco_unitario: item.preco_unitario,
                    subtotal: item.subtotal,
                    desconto_valor: item.desconto || 0,
                    aliquota_icms: item.produtos?.aliquota_icms || 0
                }));
                
                // Buscar formas de pagamento
                const { data: pagamentos } = await supabase
                    .from('pagamentos')
                    .select('*')
                    .eq('venda_id', vendaId);
                
                // Se n√£o houver pagamento registrado, usar DINHEIRO como padr√£o
                const pagamentosNFe = (pagamentos && pagamentos.length > 0) 
                    ? pagamentos.map(p => ({
                        tipo: p.forma_pagamento,
                        valor: p.valor
                    }))
                    : [{
                        tipo: 'DINHEIRO',
                        valor: venda.total
                    }];
                
                // Buscar cliente se houver
                let cliente = null;
                if (venda.cliente_id) {
                    const { data: clienteData } = await supabase
                        .from('clientes')
                        .select('*')
                        .eq('id', venda.cliente_id)
                        .single();
                    cliente = clienteData;
                }
                
                console.log('üì§ [VENDA] Emitindo NFC-e via API Fiscal configurada...');
                
                // Emitir NFC-e
                const resultado = await FiscalService.emitirNFCeDireto(vendaNFe, itensNFe, pagamentosNFe, cliente);
                
                console.log('üì¶ [VENDA] Resultado da emiss√£o:', resultado);
                
                // Verificar sucesso
                if (resultado.success && (resultado.status === 'autorizado' || resultado.status_sefaz === 'autorizado')) {
                    console.log('‚úÖ [VENDA] NFC-e autorizada!');
                    
                    // Atualizar venda com dados fiscais
                    const { error: erroUpdate } = await supabase
                        .from('vendas')
                        .update({
                            status_fiscal: 'EMITIDA_NFCE',
                            nfce_referencia: resultado.ref,
                            nfce_chave: resultado.chave_nfe,
                            nfce_numero: resultado.numero
                        })
                        .eq('id', vendaId);
                    
                    if (erroUpdate) {
                        console.warn('‚ö†Ô∏è Erro ao atualizar dados fiscais:', erroUpdate);
                    }
                    
                    // Salvar documento fiscal
                    if (resultado.documentoFiscalData) {
                        try {
                            resultado.documentoFiscalData.venda_id = vendaId;
                            await FocusNFe.salvarDocumentoFiscal(resultado.documentoFiscalData);
                            console.log('‚úÖ [VENDA] Documento fiscal salvo com sucesso');
                        } catch (erroDoc) {
                            console.warn('‚ö†Ô∏è Erro ao salvar documento fiscal:', erroDoc);
                        }
                    }
                    
                    showToast('‚úÖ NFC-e emitida com sucesso!', 'success');
                    
                    // Recarregar venda
                    await loadVenda();
                    
                    // Perguntar se deseja visualizar DANFE
                    if (resultado.caminho_danfe) {
                        setTimeout(async () => {
                            if (confirm('NFC-e autorizada!\n\nDeseja visualizar o DANFE agora?')) {
                                window.open(resultado.caminho_danfe, '_blank');
                            }
                        }, 1000);
                    }
                } else {
                    const mensagemErro = resultado.mensagem_sefaz || resultado.erro || 'Erro desconhecido';
                    throw new Error(`NFC-e n√£o autorizada: ${mensagemErro}`);
                }
            } catch (error) {
                console.error('‚ùå Erro ao emitir NFC-e:', error);
                showToast('Erro ao emitir NFC-e: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Imprimir/Consultar nota fiscal existente
        async function imprimirNotaFiscal() {
            try {
                showLoading(true);
                
                if (!venda.chave_acesso_nfce) {
                    throw new Error('Esta venda n√£o possui nota fiscal emitida');
                }
                
                console.log('üîç [VENDA] Consultando NFC-e com chave:', venda.chave_acesso_nfce);
                
                // Consultar nota usando a chave de acesso
                const resultado = await FiscalService.consultarDocumento(venda.chave_acesso_nfce, 'nfce');
                
                if (resultado.caminho_danfe) {
                    window.open(resultado.caminho_danfe, '_blank');
                    showToast('DANFE aberto em nova aba', 'success');
                } else {
                    throw new Error('N√£o foi poss√≠vel obter o DANFE');
                }
            } catch (error) {
                console.error('‚ùå Erro ao buscar DANFE:', error);
                showToast('Erro ao consultar nota: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function finalizarVenda() {
            if (!confirm('Finalizar venda? O estoque ser√° REDUZIDO automaticamente.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                // Validar status
                const statusAtual = (venda.status || venda.status_venda || '').toUpperCase();
                if (statusAtual !== 'RASCUNHO') {
                    throw new Error('Apenas vendas em RASCUNHO podem ser finalizadas');
                }
                
                // Validar itens
                if (!itens || itens.length === 0) {
                    throw new Error('N√£o √© poss√≠vel finalizar uma venda sem itens');
                }
                
                console.log('üí∞ [VENDA] Finalizando venda:', vendaId);
                console.log('üì¶ [VENDA] Total de itens:', itens.length);
                
                // Processar sa√≠da de estoque usando EstoqueService
                const resultadoEstoque = await EstoqueService.saidaPorVenda(vendaId);
                
                if (!resultadoEstoque.sucesso) {
                    throw new Error(resultadoEstoque.mensagem || 'Erro ao processar sa√≠da de estoque');
                }
                
                console.log(`‚úÖ [VENDA] ${resultadoEstoque.itens_processados} produtos sa√≠ram do estoque`);
                
                // Atualizar status da venda
                const { error } = await supabase
                    .from('vendas')
                    .update({ 
                        status: 'FINALIZADA',
                        status_venda: 'FINALIZADA',
                        data_venda: new Date().toISOString()
                    })
                    .eq('id', vendaId);
                
                if (error) {
                    console.error('‚ùå Erro ao atualizar status:', error);
                    throw error;
                }
                
                console.log('‚úÖ [VENDA] Venda finalizada com sucesso!');
                showToast('Venda finalizada com sucesso! Estoque atualizado.', 'success');
                await loadVenda();
                
            } catch (error) {
                console.error('‚ùå Erro ao finalizar venda:', error);
                showToast('Erro ao finalizar venda: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function excluirVenda() {
            // Validar status
            const statusAtual = (venda.status || venda.status_venda || '').toUpperCase();
            if (statusAtual !== 'RASCUNHO') {
                showToast('‚ùå Apenas vendas em RASCUNHO podem ser exclu√≠das!', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja EXCLUIR esta venda?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!')) {
                return;
            }
            
            try {
                showLoading(true);
                
                console.log('üóëÔ∏è [VENDA] Excluindo venda:', vendaId);
                
                // 1. Desassociar comandas que referenciam esta venda (remove FK)
                const { error: errorComandas } = await supabase
                    .from('comandas')
                    .update({ venda_id: null, status: 'cancelada' })
                    .eq('venda_id', vendaId);
                
                if (errorComandas) {
                    console.error('‚ùå Erro ao desassociar comandas:', errorComandas);
                    throw errorComandas;
                }
                
                console.log('‚úÖ Comandas desassociadas');
                
                // 2. Excluir itens da venda
                const { error: errorItens } = await supabase
                    .from('venda_itens')
                    .delete()
                    .eq('venda_id', vendaId);
                
                if (errorItens) {
                    console.error('‚ùå Erro ao excluir itens:', errorItens);
                    throw errorItens;
                }
                
                console.log('‚úÖ Itens exclu√≠dos');
                
                // 3. Excluir venda
                const { error: errorVenda } = await supabase
                    .from('vendas')
                    .delete()
                    .eq('id', vendaId);
                
                if (errorVenda) {
                    console.error('‚ùå Erro ao excluir venda:', errorVenda);
                    throw errorVenda;
                }
                
                console.log('‚úÖ Venda exclu√≠da com sucesso');
                showToast('Venda exclu√≠da com sucesso!', 'success');
                
                // Redirecionar para lista de vendas
                setTimeout(() => {
                    window.location.href = 'vendas.html';
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir venda:', error);
                showToast('Erro ao excluir venda: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function getStatusText(status) {
            const texts = {
                'RASCUNHO': 'Status: Rascunho',
                'ENVIADO': 'Status: Aguardando Aprova√ß√£o',
                'APROVADO': 'Status: Aprovada',
                'REJEITADO': 'Status: Rejeitada',
                'FINALIZADO': 'Status: Finalizada',
                'CANCELADO': 'Status: Cancelada'
            };
            return texts[status] || status;
        }

        async function cancelarVendaHandler(novoStatus) {
            // VALIDA√á√ÉO: Impedir cancelamento de vendas j√° canceladas ou em rascunho
            if (venda.status === 'CANCELADO' || venda.status === 'CANCELADA') {
                showToast('‚ùå Esta venda j√° foi cancelada anteriormente!', 'error');
                closeModal('modal-cancelar');
                return;
            }
            
            if (venda.status === 'RASCUNHO') {
                showToast('‚ùå Esta venda j√° est√° em rascunho!', 'error');
                closeModal('modal-cancelar');
                return;
            }
            
            const mensagem = novoStatus === 'CANCELADO' 
                ? 'Tem certeza que deseja CANCELAR DEFINITIVAMENTE esta venda? Os itens retornar√£o ao estoque.' 
                : 'Tem certeza que deseja CANCELAR e REABRIR esta venda como rascunho?';
            
            if (!confirm(mensagem)) {
                closeModal('modal-cancelar');
                return;
            }
            
            showLoading(true);
            try {
                // ‚úÖ L√ìGICA COM ESTOQUE SERVICE CENTRALIZADO
                
                const statusAtual = venda.status?.toUpperCase() || '';
                const isFinalizada = statusAtual === 'FINALIZADA' || statusAtual === 'FINALIZADO';
                
                // ‚ö†Ô∏è CR√çTICO: SEMPRE devolver estoque quando sair de FINALIZADA
                // Tanto para CANCELADO quanto para RASCUNHO
                if (isFinalizada) {
                    console.log(`‚ùå [VENDA] Mudando de FINALIZADA para ${novoStatus} - devolvendo produtos ao estoque`);
                    
                    // Usar EstoqueService centralizado para reverter (com prote√ß√£o contra duplica√ß√£o)
                    const resultado = await EstoqueService.reverterSaidaVenda(vendaId);
                    
                    if (!resultado.sucesso) {
                        throw new Error(resultado.mensagem || 'Erro ao devolver produtos ao estoque');
                    }
                    
                    console.log(`‚úÖ [VENDA] ${resultado.itens_processados} produtos devolvidos ao estoque`);
                    
                    if (novoStatus === 'RASCUNHO') {
                        console.log('üîÑ [VENDA] Venda reaberta como RASCUNHO - estoque devolvido');
                        console.log('   ‚Üí Ao refinalizar, o sistema vai baixar estoque novamente');
                    }
                }
                
                const updateData = { status: novoStatus };
                
                // Nota: O registro de quem cancelou fica nas estoque_movimentacoes (usuario_id)
                
                console.log('üìù Atualizando venda:', vendaId, 'Status atual:', venda.status_venda, 'Novo status:', novoStatus);
                console.log('üìù Dados para atualizar:', updateData);
                
                const { data, error } = await supabase
                    .from('vendas')
                    .update(updateData)
                    .eq('id', vendaId)
                    .select();
                
                if (error) {
                    console.error('‚ùå Erro ao atualizar status:', error);
                    throw error;
                }
                
                console.log('‚úÖ Venda atualizada com sucesso:', data);
                
                const msgSucesso = novoStatus === 'CANCELADO' 
                    ? 'Venda cancelada definitivamente! Itens devolvidos ao estoque.' 
                    : 'Venda cancelada e reaberta como rascunho!';
                
                showToast(msgSucesso, 'success');
                closeModal('modal-cancelar');
                
                // Recarregar dados da venda para exibir novo status
                console.log('üîÑ Recarregando dados da venda...');
                await loadVenda();
                console.log('‚úÖ Venda recarregada. Novo status:', venda.status_venda);
            } catch (error) {
                handleError(error, 'Erro ao cancelar venda');
            } finally {
                showLoading(false);
            }
        }

        async function enviarPDFWhatsAppHandler() {
            try {
                if (!venda.cliente?.whatsapp) {
                    showToast('Cliente n√£o possui WhatsApp cadastrado', 'error');
                    return;
                }

                if (!confirm(`Enviar PDF da venda para ${venda.cliente.nome}?\n\nWhatsApp: ${venda.cliente.whatsapp}`)) {
                    return;
                }

                await enviarPDFWhatsApp(vendaId, venda.cliente.whatsapp);
            } catch (error) {
                // Erro j√° tratado na fun√ß√£o enviarPDFWhatsApp
                console.error('Erro ao enviar WhatsApp:', error);
            }
        }

        // =====================================================
        // ALTERA√á√ÉO DE PRE√áO EM LOTE
        // =====================================================

        function abrirModalAlterarPrecoLote() {
            if (itens.length === 0) {
                showToast('N√£o h√° itens na venda', 'warning');
                return;
            }

            // Obter produtos √∫nicos da venda
            const produtosUnicos = {};
            itens.forEach(item => {
                if (!produtosUnicos[item.produto_id]) {
                    produtosUnicos[item.produto_id] = {
                        id: item.produto_id,
                        nome: item.produto?.nome || 'N/A',
                        itens: []
                    };
                }
                produtosUnicos[item.produto_id].itens.push(item);
            });

            // Preencher select com produtos
            const select = document.getElementById('select-produto-lote');
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            
            Object.values(produtosUnicos).forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = `${produto.nome} (${produto.itens.length} iten(s))`;
                option.dataset.itens = JSON.stringify(produto.itens);
                select.appendChild(option);
            });

            // Limpar campos
            document.getElementById('novo-preco-lote').value = '';
            document.getElementById('preview-alteracao-lote').classList.add('hidden');
            document.getElementById('info-itens-produto').classList.add('hidden');

            openModal('modal-alterar-preco-lote');
        }

        function atualizarInfoProdutoLote() {
            const select = document.getElementById('select-produto-lote');
            const selectedOption = select.options[select.selectedIndex];
            const infoElement = document.getElementById('info-itens-produto');
            
            if (!selectedOption.value) {
                infoElement.classList.add('hidden');
                document.getElementById('preview-alteracao-lote').classList.add('hidden');
                return;
            }

            const itensData = JSON.parse(selectedOption.dataset.itens);
            const quantidadeTotal = itensData.reduce((sum, item) => sum + parseFloat(item.quantidade || 0), 0);
            
            infoElement.textContent = `Este produto possui ${itensData.length} sabor(es) na venda, totalizando ${quantidadeTotal} unidades.`;
            infoElement.classList.remove('hidden');
            
            // Se j√° tiver pre√ßo digitado, recalcular
            calcularNovoTotalLote();
        }

        function calcularNovoTotalLote() {
            const select = document.getElementById('select-produto-lote');
            const selectedOption = select.options[select.selectedIndex];
            const novoPreco = parseFloat(document.getElementById('novo-preco-lote').value);
            const previewElement = document.getElementById('preview-alteracao-lote');
            
            if (!selectedOption.value || !novoPreco || novoPreco <= 0) {
                previewElement.classList.add('hidden');
                return;
            }

            const itensData = JSON.parse(selectedOption.dataset.itens);
            
            // Calcular total atual
            const totalAtual = itensData.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);
            
            // Calcular novo total
            const novoTotal = itensData.reduce((sum, item) => {
                const quantidade = parseFloat(item.quantidade || 0);
                return sum + (quantidade * novoPreco);
            }, 0);
            
            // Calcular diferen√ßa
            const diferenca = novoTotal - totalAtual;
            
            // Atualizar preview
            document.getElementById('total-atual-lote').textContent = formatCurrency(totalAtual);
            document.getElementById('novo-total-lote').textContent = formatCurrency(novoTotal);
            
            const diferencaElement = document.getElementById('diferenca-lote');
            diferencaElement.textContent = formatCurrency(Math.abs(diferenca));
            
            if (diferenca > 0) {
                diferencaElement.className = 'font-bold text-green-600';
                diferencaElement.textContent = '+ ' + formatCurrency(diferenca);
            } else if (diferenca < 0) {
                diferencaElement.className = 'font-bold text-red-600';
                diferencaElement.textContent = '- ' + formatCurrency(Math.abs(diferenca));
            } else {
                diferencaElement.className = 'font-bold text-gray-600';
                diferencaElement.textContent = formatCurrency(0);
            }
            
            previewElement.classList.remove('hidden');
        }

        document.getElementById('form-alterar-preco-lote').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const select = document.getElementById('select-produto-lote');
            const selectedOption = select.options[select.selectedIndex];
            const novoPreco = parseFloat(document.getElementById('novo-preco-lote').value);
            
            if (!selectedOption.value || !novoPreco || novoPreco <= 0) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            const itensData = JSON.parse(selectedOption.dataset.itens);
            const produtoNome = selectedOption.textContent.split(' (')[0];
            
            const confirmacao = confirm(
                `Confirma a altera√ß√£o de pre√ßo?\n\n` +
                `Produto: ${produtoNome}\n` +
                `Itens afetados: ${itensData.length}\n` +
                `Novo pre√ßo unit√°rio: ${formatCurrency(novoPreco)}\n\n` +
                `Esta a√ß√£o ir√° atualizar TODOS os itens deste produto.`
            );
            
            if (!confirmacao) return;

            try {
                showLoading(true);
                
                let sucessos = 0;
                let erros = 0;
                
                // Atualizar cada item
                for (const item of itensData) {
                    try {
                        const { error } = await supabase
                            .from('venda_itens')
                            .update({
                                preco_unitario: novoPreco
                                // subtotal √© calculado automaticamente pelo banco
                            })
                            .eq('id', item.id);
                        
                        if (error) {
                            console.error('Erro ao atualizar item:', item.id, error);
                            erros++;
                        } else {
                            sucessos++;
                        }
                    } catch (error) {
                        console.error('Erro ao processar item:', item.id, error);
                        erros++;
                    }
                }
                
                if (erros > 0) {
                    showToast(`${sucessos} item(ns) atualizado(s), ${erros} erro(s)`, 'warning');
                } else {
                    showToast(`${sucessos} item(ns) atualizado(s) com sucesso!`, 'success');
                }
                
                // Recalcular total do pedido
                await recalcularTotalPedido(vendaId);
                
                closeModal('modal-alterar-preco-lote');
                await loadVenda();
                
            } catch (error) {
                handleError(error, 'Erro ao alterar pre√ßos em lote');
            } finally {
                showLoading(false);
            }
        });

        // =====================================================
        // FUN√á√ïES DE OBSERVA√á√ïES
        // =====================================================
        
        function abrirModalObservacoes() {
            const textarea = document.getElementById('textarea-observacoes');
            textarea.value = venda.observacoes || '';
            openModal('modal-observacoes');
        }

        // Listener para o formul√°rio de observa√ß√µes
        document.getElementById('form-observacoes').addEventListener('submit', async (e) => {
            e.preventDefault();
            await salvarObservacoes();
        });

        async function salvarObservacoes() {
            try {
                showLoading(true);
                
                const observacoes = document.getElementById('textarea-observacoes').value.trim();
                
                const { error } = await supabase
                    .from('vendas')
                    .update({ observacoes })
                    .eq('id', vendaId);
                
                if (error) throw error;
                
                showToast('Observa√ß√µes atualizadas com sucesso!', 'success');
                closeModal('modal-observacoes');
                
                // Recarregar venda para exibir as novas observa√ß√µes
                await loadVenda();
            } catch (error) {
                handleError(error, 'Erro ao salvar observa√ß√µes');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
