<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Venda</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .output {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
        }
        .output pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-ok { color: #10b981; font-weight: bold; }
        .status-error { color: #ef4444; font-weight: bold; }
        .status-warning { color: #f59e0b; font-weight: bold; }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
        }
        .section-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico de Venda</h1>
            <p>Ferramenta para diagnosticar problemas em vendas espec√≠ficas</p>
        </div>
        
        <div class="content">
            <div class="input-group">
                <label for="vendaId">N√∫mero da Venda:</label>
                <input type="text" id="vendaId" placeholder="Ex: VND202601081155" value="VND202601081155">
            </div>
            
            <button id="btnDiagnosticar" onclick="diagnosticar()">
                üîç Executar Diagn√≥stico
            </button>
            
            <div id="output" class="output" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script>
        let outputDiv;
        
        function log(message, type = 'normal') {
            if (!outputDiv) {
                outputDiv = document.getElementById('output');
            }
            
            let className = '';
            if (type === 'success') className = 'status-ok';
            if (type === 'error') className = 'status-error';
            if (type === 'warning') className = 'status-warning';
            
            const line = document.createElement('div');
            line.className = className;
            line.textContent = message;
            outputDiv.appendChild(line);
            
            // Auto scroll
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function logSection(title) {
            if (!outputDiv) {
                outputDiv = document.getElementById('output');
            }
            
            const section = document.createElement('div');
            section.className = 'section';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'section-title';
            titleDiv.textContent = title;
            
            section.appendChild(titleDiv);
            outputDiv.appendChild(section);
            
            return section;
        }

        async function diagnosticar() {
            const vendaNumero = document.getElementById('vendaId').value.trim();
            
            if (!vendaNumero) {
                alert('Por favor, informe o n√∫mero da venda!');
                return;
            }
            
            const btn = document.getElementById('btnDiagnosticar');
            outputDiv = document.getElementById('output');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Diagnosticando...';
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando dados...</p></div>';
            
            setTimeout(async () => {
                outputDiv.innerHTML = '';
                
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'normal');
                log('üîç DIAGN√ìSTICO DE VENDA ESPEC√çFICA', 'normal');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'normal');
                log(`üìã Venda: ${vendaNumero}`, 'normal');
                log('');
                
                try {
                    // 1. Buscar dados da venda (busca exata)
                    log('1Ô∏è‚É£ BUSCANDO DADOS DA VENDA (busca exata)...', 'normal');
                    log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                    
                    const { data: vendas, error: vendaError } = await supabase
                        .from('pedidos')
                        .select(`
                            *,
                            solicitante:users!pedidos_solicitante_id_fkey(id, full_name, email),
                            aprovador:users!pedidos_aprovador_id_fkey(id, full_name, email),
                            cliente:clientes(id, nome, cpf_cnpj, whatsapp)
                        `)
                        .eq('numero', vendaNumero)
                        .order('created_at', { ascending: false });

                    if (vendaError) {
                        log(`‚ùå Erro ao buscar venda: ${vendaError.message}`, 'error');
                        log('');
                        log('üí° POSS√çVEIS CAUSAS:', 'warning');
                        log('   - N√∫mero da venda incorreto', 'warning');
                        log('   - Venda n√£o existe no banco de dados', 'warning');
                        log('   - Problema de permiss√£o (RLS)', 'warning');
                        return;
                    }
                    
                    if (!vendas || vendas.length === 0) {
                        log('‚ùå Venda n√£o encontrada com busca exata!', 'error');
                        log('');
                        
                        // Buscar vendas similares
                        log('üîç Buscando vendas com numera√ß√£o similar...', 'normal');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                        
                        const { data: similares } = await supabase
                            .from('pedidos')
                            .select(`
                                id,
                                numero,
                                tipo,
                                status,
                                total,
                                created_at,
                                cliente:clientes(nome)
                            `)
                            .or(`numero.ilike.%${vendaNumero}%,numero.ilike.%VND2026%`)
                            .order('created_at', { ascending: false })
                            .limit(10);
                        
                        if (similares && similares.length > 0) {
                            log(`‚úÖ Encontradas ${similares.length} vendas com numera√ß√£o similar:`, 'warning');
                            log('');
                            similares.forEach((v, idx) => {
                                log(`   ${idx + 1}. N√∫mero: ${v.numero}`, 'normal');
                                log(`      ID: ${v.id}`, 'normal');
                                log(`      Tipo: ${v.tipo}`, 'normal');
                                log(`      Status: ${v.status}`, 'normal');
                                log(`      Total: R$ ${parseFloat(v.total || 0).toFixed(2)}`, 'normal');
                                log(`      Cliente: ${v.cliente?.nome || 'N/A'}`, 'normal');
                                log(`      Criada: ${new Date(v.created_at).toLocaleString('pt-BR')}`, 'normal');
                                log('');
                            });
                            log('üí° Verifique se o n√∫mero correto √© um dos acima.', 'warning');
                        } else {
                            log('‚ùå Nenhuma venda similar encontrada.', 'error');
                        }
                        
                        // Buscar √∫ltimas vendas criadas
                        log('');
                        log('üîç √öltimas 10 vendas criadas no sistema:', 'normal');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                        
                        const { data: ultimas } = await supabase
                            .from('pedidos')
                            .select(`
                                id,
                                numero,
                                tipo,
                                status,
                                total,
                                created_at,
                                cliente:clientes(nome)
                            `)
                            .eq('tipo', 'VENDA')
                            .order('created_at', { ascending: false })
                            .limit(10);
                        
                        if (ultimas && ultimas.length > 0) {
                            ultimas.forEach((v, idx) => {
                                log(`   ${idx + 1}. ${v.numero}`, 'normal');
                                log(`      Status: ${v.status} | Total: R$ ${parseFloat(v.total || 0).toFixed(2)}`, 'normal');
                                log(`      Cliente: ${v.cliente?.nome || 'N/A'}`, 'normal');
                                log(`      Criada: ${new Date(v.created_at).toLocaleString('pt-BR')}`, 'normal');
                                log('');
                            });
                        }
                        
                        log('');
                        log('ü§î POSS√çVEIS EXPLICA√á√ïES:', 'warning');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'warning');
                        log('1. O n√∫mero da venda foi digitado incorretamente', 'warning');
                        log('2. A venda foi deletada do banco de dados', 'warning');
                        log('3. Voc√™ est√° vendo dados em cache no navegador', 'warning');
                        log('4. A venda foi criada como COMPRA ao inv√©s de VENDA', 'warning');
                        log('');
                        log('üîß A√á√ïES SUGERIDAS:', 'success');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'success');
                        log('1. Verifique o n√∫mero exato da venda na listagem', 'success');
                        log('2. Limpe o cache do navegador (Ctrl+Shift+Delete)', 'success');
                        log('3. Verifique se a venda aparece na lista de COMPRAS', 'success');
                        log('4. Copie e cole o n√∫mero exato da listagem aqui', 'success');
                        
                        return;
                    }
                    
                    // Verificar duplicatas
                    if (vendas.length > 1) {
                        log(`‚ö†Ô∏è  PROBLEMA GRAVE DETECTADO!`, 'error');
                        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                        log('', 'error');
                        log(`Encontradas ${vendas.length} vendas com o MESMO n√∫mero!`, 'error');
                        log('Isso indica um problema de duplica√ß√£o no sistema.', 'error');
                        log('');
                        log('üìã VENDAS DUPLICADAS:', 'warning');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'warning');
                        
                        vendas.forEach((v, index) => {
                            log('');
                            log(`   Venda #${index + 1}:`, 'normal');
                            log(`      ID: ${v.id}`, 'normal');
                            log(`      N√∫mero: ${v.numero}`, 'normal');
                            log(`      Status: ${v.status}`, 'normal');
                            log(`      Total: R$ ${parseFloat(v.total || 0).toFixed(2)}`, 'normal');
                            log(`      Cliente: ${v.cliente?.nome || 'N/A'}`, 'normal');
                            log(`      Criada em: ${new Date(v.created_at).toLocaleString('pt-BR')}`, 'normal');
                        });
                        
                        log('');
                        log('üîß ANALISANDO CADA VENDA...', 'normal');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                    } else {
                        log('‚úÖ Venda encontrada!', 'success');
                        log('');
                    }
                    
                    // Processar cada venda encontrada
                    for (let i = 0; i < vendas.length; i++) {
                        const venda = vendas[i];
                        
                        if (vendas.length > 1) {
                            log('');
                            log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'normal');
                            log(`üìã ANALISANDO VENDA #${i + 1}`, 'normal');
                            log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'normal');
                        }
                        
                        log('');
                        log(`   ID: ${venda.id}`);
                        log(`   N√∫mero: ${venda.numero}`);
                        log(`   Tipo: ${venda.tipo}`);
                        log(`   Status: ${venda.status}`);
                        log(`   Total: R$ ${parseFloat(venda.total || 0).toFixed(2)}`);
                        log(`   Solicitante: ${venda.solicitante?.full_name || 'N/A'}`);
                        log(`   Cliente: ${venda.cliente?.nome || 'N/A'}`);
                        log(`   Data Cria√ß√£o: ${new Date(venda.created_at).toLocaleString('pt-BR')}`);
                        log('');
                        
                        // 2. Buscar itens desta venda espec√≠fica
                        log(`2Ô∏è‚É£ BUSCANDO ITENS DA VENDA #${i + 1}...`, 'normal');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                        
                        const { data: itens, error: itensError } = await supabase
                        .from('pedido_itens')
                        .select(`
                            *,
                            produto:produtos(id, codigo, nome, unidade, preco),
                            sabor:produto_sabores(id, sabor, quantidade)
                        `)
                        .eq('pedido_id', venda.id)
                        .order('created_at');

                    if (itensError) {
                        log(`‚ùå Erro ao buscar itens: ${itensError.message}`, 'error');
                        log('');
                        log('üí° POSS√çVEL CAUSA:', 'warning');
                        log('   - Problema de permiss√£o RLS na tabela pedido_itens', 'warning');
                        return;
                    }
                    
                    log(`üì¶ Total de itens encontrados: ${itens.length}`, 'normal');
                    log('');
                    
                    if (itens.length === 0) {
                        log('‚ö†Ô∏è  PROBLEMA IDENTIFICADO!', 'warning');
                        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        log('', 'warning');
                        log('A venda existe no banco de dados mas N√ÉO possui', 'warning');
                        log('nenhum item associado!', 'warning');
                        log('', 'warning');
                        log('Isso explica por que:', 'warning');
                        log('  ‚Ä¢ A venda aparece na listagem com valor', 'warning');
                        log('  ‚Ä¢ Mas ao abrir os detalhes n√£o tem informa√ß√µes', 'warning');
                        log('');
                        
                        // Verificar movimenta√ß√µes de estoque
                        const { data: movimentacoes } = await supabase
                            .from('movimentacoes_estoque')
                            .select('*')
                            .eq('pedido_id', venda.id);
                        
                        log('');
                        log('üîç Verifica√ß√£o adicional:', 'normal');
                        log(`   Movimenta√ß√µes de estoque: ${movimentacoes?.length || 0}`);
                        log('');
                        
                        log('üí° POSS√çVEIS CAUSAS:', 'normal');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                        log('1. Os itens foram deletados acidentalmente', 'normal');
                        log('2. A venda foi criada mas os itens nunca foram adicionados', 'normal');
                        log('3. Houve um erro durante a cria√ß√£o dos itens', 'normal');
                        log('4. Pol√≠tica RLS est√° bloqueando o acesso aos itens', 'normal');
                        log('');
                        
                        log('üîß A√á√ïES SUGERIDAS:', 'success');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'success');
                        log('1. Se a venda √© antiga, considere exclu√≠-la', 'success');
                        log('2. Se a venda √© recente, tente adicionar os itens novamente', 'success');
                        log('3. Verifique as pol√≠ticas RLS da tabela pedido_itens', 'success');
                        log('4. Entre em contato com suporte se o problema persistir', 'success');
                        
                    } else {
                        log('‚úÖ Itens encontrados!', 'success');
                        log('');
                        
                        let totalCalculado = 0;
                        
                        itens.forEach((item, index) => {
                            log(`   üì¶ Item ${index + 1}:`);
                            log(`      Produto: ${item.produto?.nome || 'N/A'}`);
                            if (item.sabor?.sabor) {
                                log(`      Sabor: ${item.sabor.sabor}`);
                            }
                            log(`      Quantidade: ${item.quantidade}`);
                            log(`      Pre√ßo Unit.: R$ ${parseFloat(item.preco_unitario || 0).toFixed(2)}`);
                            log(`      Subtotal: R$ ${parseFloat(item.subtotal || 0).toFixed(2)}`);
                            log('');
                            
                            totalCalculado += parseFloat(item.subtotal || 0);
                        });
                        
                        log('üìä VERIFICA√á√ÉO DE TOTAIS:', 'normal');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'normal');
                        log(`   Total no campo 'total': R$ ${parseFloat(venda.total || 0).toFixed(2)}`);
                        log(`   Total calculado (soma): R$ ${totalCalculado.toFixed(2)}`);
                        
                        const diferenca = Math.abs(venda.total - totalCalculado);
                        if (diferenca > 0.01) {
                            log(`   ‚ö†Ô∏è  DIVERG√äNCIA: R$ ${diferenca.toFixed(2)}`, 'warning');
                            log('   H√° uma diferen√ßa entre o total registrado e a soma dos itens!', 'warning');
                        } else {
                            log('   ‚úÖ Totais conferem!', 'success');
                        }
                        log('');
                        
                        // Se chegou aqui, o problema n√£o √© falta de dados
                        log('ü§î DIAGN√ìSTICO:', 'warning');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'warning');
                        log('Os dados da venda e itens existem no banco!', 'warning');
                        log('');
                        log('Se os detalhes n√£o aparecem no frontend, pode ser:', 'warning');
                        log('1. Problema de cache do navegador (Ctrl+Shift+R)', 'warning');
                        log('2. Erro no JavaScript ao carregar os dados', 'warning');
                        log('3. Problema com o ID usado na URL', 'warning');
                        log('');
                        log('Tente:', 'success');
                        log('‚Ä¢ Limpar cache e recarregar (Ctrl+Shift+R)', 'success');
                        log('‚Ä¢ Abrir o console do navegador (F12) e verificar erros', 'success');
                        log(`‚Ä¢ Acessar: /pages/venda-detalhe.html?id=${venda.id}`, 'success');
                    }
                    
                    } // Fim do loop de vendas
                    
                    // Se houver duplicatas, mostrar recomenda√ß√µes
                    if (vendas.length > 1) {
                        log('');
                        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                        log('üö® A√á√ÉO URGENTE NECESS√ÅRIA!', 'error');
                        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'error');
                        log('');
                        log('Voc√™ tem m√∫ltiplas vendas com o mesmo n√∫mero!', 'error');
                        log('Isso pode causar problemas s√©rios no sistema.', 'error');
                        log('');
                        log('üîß RECOMENDA√á√ïES:', 'warning');
                        log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'warning');
                        log('1. Identifique qual √© a venda correta (geralmente a mais recente)', 'warning');
                        log('2. Verifique se h√° itens em cada uma delas', 'warning');
                        log('3. Considere excluir as vendas duplicadas incorretas', 'warning');
                        log('4. Investigue como a duplica√ß√£o ocorreu para evitar no futuro', 'warning');
                        log('');
                        log('üí° PROV√ÅVEL CAUSA DA DUPLICA√á√ÉO:', 'normal');
                        log('   - Clique duplo ao criar venda', 'normal');
                        log('   - Falta de prote√ß√£o contra cliques m√∫ltiplos', 'normal');
                        log('   - Problema de rede causando envio duplicado', 'normal');
                    }
                    
                } catch (error) {
                    log('');
                    log(`‚ùå ERRO INESPERADO: ${error.message}`, 'error');
                    console.error('Erro completo:', error);
                } finally {
                    log('');
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'normal');
                    log('‚úÖ Diagn√≥stico conclu√≠do!', 'success');
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'normal');
                    
                    btn.disabled = false;
                    btn.textContent = 'üîç Executar Diagn√≥stico';
                }
            }, 100);
        }
        
        // Permitir Enter para diagnosticar
        document.getElementById('vendaId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                diagnosticar();
            }
        });
    </script>
</body>
</html>
